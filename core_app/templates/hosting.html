{% extends "base.html" %}
{% block title %}All Hosts{% endblock %}
{% load static%}
{% block extra_css %}
<style>
    .scrollable-table-body {
        max-height: 400px;
        /* Adjust height as needed */
        overflow-y: auto;
    }

    .scrollable-table-body table {
        margin-bottom: 0;
        /* Avoid extra spacing */
    }

    /* Optional: Fix the header */
    .scrollable-table-body thead th {
        position: sticky;
        top: 0;
        background: #fff;
        z-index: 1;
    }
</style>
{% endblock %}

{% block content %}
{% if messages %}
<div id="toast-container" style="
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 3000;  /* above sidebar/navbar */
    display: flex;
    flex-direction: column;
    gap: 10px;
">
    {% for message in messages %}
    <div class="toast align-items-center text-white bg-{{ message.tags }} border-0 show" role="alert"
        aria-live="assertive" aria-atomic="true" style="min-width: 250px;">
        <div class="d-flex">
            <div class="toast-body">
                {{ message }}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                aria-label="Close"></button>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}
<div class="content-wrapper">

    <!-- Content -->
    <div class="container-xxl flex-grow-1 container-p-y">

        <!-- Project Status Cards -->
        <div class="row mb-4">
            <!-- Total Servers -->
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card h-100 shadow-sm border-0">
                    <div class="card-body d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="mb-1">Total Servers</h6>
                            <h4 class="fw-bold text-primary">{{total_servers}}</h4>
                        </div>
                        <div class="avatar bg-primary text-white rounded-circle p-2">
                            <i class="bx bx-server fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Running Servers -->
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card h-100 shadow-sm border-0">
                    <div class="card-body d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="mb-1">Running Servers</h6>
                            <h4 class="fw-bold text-success">{{running_servers}}</h4>
                        </div>
                        <div class="avatar bg-success text-white rounded-circle p-2">
                            <i class="bx bx-play-circle fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Down Servers -->
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card h-100 shadow-sm border-0">
                    <div class="card-body d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="mb-1">Down Servers</h6>
                            <h4 class="fw-bold text-danger">{{down_servers}}</h4>
                        </div>
                        <div class="avatar bg-danger text-white rounded-circle p-2">
                            <i class="bx bx-error fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Expiring Soon -->
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card h-100 shadow-sm border-0">
                    <div class="card-body d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="mb-1">Expiring Soon</h6>
                            <h4 class="fw-bold text-warning">{{expiring_soon}}</h4>
                        </div>
                        <div class="avatar bg-warning text-white rounded-circle p-2">
                            <i class="bx bx-line-chart fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- All Domains Table -->
        <div class="card">
            <div class="card-body">


                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="mb-0">All Hostdata</h4>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-outline-secondary" title="Filter Projects">
                            <i class="bx bx-filter-alt"></i>
                        </button>


                        <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                            data-bs-target="#addHostDataModal">
                            <i class="bx bx-plus"></i> Add hostdata
                        </button>

                    </div>
                </div>

                <div class="table-responsive text-nowrap scrollable-table-body">
                    <table class="table" id="hostTable">
                        <thead>

                            <tr>
                                <th data-sort="number">Sr No.</th>
                                <th data-sort="string">Hosting Provider</th>
                                <th data-sort="string">Project ID</th>
                                <th data-sort="string">Project Name</th>
                                <th data-sort="string">Login URL</th>
                                <th data-sort="string">Status</th>
                                <th data-sort="string">Left Days</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody class="table-border-bottom-0">
                            {% for host in page_obj %}
                            <tr>
                                <td>{{ forloop.counter0|add:page_obj.start_index }}</td>
                                <td><a href="#" data-bs-toggle="modal" data-bs-target="#hostDetailsModal"
                                        class="fw-bold host-link" data-host-id="{{ host.id }}">{{ host.hosting_provider }}</a></td>
                                <td>
                                    {% if host.project.exists %}
                                    {% for p in host.project.all %}
                                    {{ p.project_id }} <br>
                                    {% endfor %}
                                    {% else %}
                                    <span class="text-muted"> - </span>
                                    {% endif %}
                                </td>

                                <td>
                                    {% if host.project.exists %}
                                    {% for p in host.project.all %}

                                    {{ p.project_name }}
                                    <br>
                                    {% endfor %}
                                    {% else %}
                                    <span class="text-muted">No Project</span>
                                    {% endif %}
                                </td>

                                <td><a href="{{ host.login_url }}" target="_blank">{{ host.login_url }}</a></td>

                                <td><span class="badge 
                                        {% if host.status == 'Active' %}bg-label-success
                                        {% elif host.status == 'Inactive' %}bg-label-warning
                                        {% elif host.status == 'Expired' %}bg-label-danger
                                        {% else %}bg-label-secondary
                                        {% endif %}
                                    ">
                                        {{ host.status }}
                                    </span>
                                </td>

                                <td>{{ host.left_days }}</td>
                                <td>
                                    <a href="#" class="text-primary me-2 action-icon edit-host" title="Edit"
                                        data-host-id="{{ host.id }}">
                                        <i class="bx bx-edit-alt"></i>
                                    </a>

                                    <a href="#" class="text-danger action-icon delete-host" title="Delete"
                                        data-host-id="{{ host.id }}">
                                        <i class="bx bx-trash"></i>
                                    </a>

                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="21" class="text-center">No Host found.</td>
                            </tr>
                            {% endfor %}


                        </tbody>
                    </table>

                </div>
                <!-- Records Per Page & Pagination -->
                <div class="d-flex justify-content-between align-items-center mt-3">

                    <!-- Records Per Page Dropdown -->
                    <div class="d-flex align-items-center">
                        <form method="GET" id="recordsForm" class="d-flex align-items-center">
                            <label for="recordsPerPage" class="me-2 mb-0">Records per page:</label>
                            <select class="form-select form-select-sm" name="recordsPerPage" id="recordsPerPage"
                                style="width: auto;">
                                {% for option in records_options %}
                                <option value="{{ option }}" {% if records_per_page == option %}selected{% endif %}>
                                    {{ option }}
                                </option>
                                {% endfor %}
                            </select>
                        </form>
                    </div>

                    <!-- Pagination -->
                    <nav aria-label="Page navigation" class="mt-3">
                        <ul class="pagination justify-content-end mb-0">

                            <!-- Previous Button -->
                            <li class="page-item {% if not page_obj.has_previous %}disabled{% endif %}">
                                {% if page_obj.has_previous %}
                                <a class="page-link"
                                    href="?page={{ page_obj.previous_page_number }}&recordsPerPage={{ records_per_page }}">
                                    <i class="bx bx-chevrons-left"></i>
                                </a>
                                {% else %}
                                <span class="page-link disabled">
                                    <i class="bx bx-chevrons-left"></i>
                                </span>
                                {% endif %}
                            </li>

                            <!-- Always show first page -->
                            <li class="page-item {% if page_obj.number == 1 %}active{% endif %}">
                                <a class="page-link" href="?page=1&recordsPerPage={{ records_per_page }}">1</a>
                            </li>

                            <!-- Show second page if exists -->
                            {% if page_obj.paginator.num_pages >= 2 %}
                            <li class="page-item {% if page_obj.number == 2 %}active{% endif %}">
                                <a class="page-link" href="?page=2&recordsPerPage={{ records_per_page }}">2</a>
                            </li>
                            {% endif %}

                            <!-- Ellipsis -->
                            {% if page_obj.paginator.num_pages > 4 %}
                            <li class="page-item disabled"><span class="page-link">…</span></li>
                            {% endif %}

                            <!-- Second last page (if not duplicate of 2) -->
                            {% if page_obj.paginator.num_pages > 2 and page_obj.paginator.num_pages|add:'-1' != 2 %}
                            <li
                                class="page-item {% if page_obj.number == page_obj.paginator.num_pages|add:'-1' %}active{% endif %}">
                                <a class="page-link"
                                    href="?page={{ page_obj.paginator.num_pages|add:'-1' }}&recordsPerPage={{ records_per_page }}">
                                    {{ page_obj.paginator.num_pages|add:'-1' }}
                                </a>
                            </li>
                            {% endif %}

                            <!-- Last page (if not duplicate of 2) -->
                            {% if page_obj.paginator.num_pages > 1 and page_obj.paginator.num_pages != 2 %}
                            <li
                                class="page-item {% if page_obj.number == page_obj.paginator.num_pages %}active{% endif %}">
                                <a class="page-link"
                                    href="?page={{ page_obj.paginator.num_pages }}&recordsPerPage={{ records_per_page }}">
                                    {{ page_obj.paginator.num_pages }}
                                </a>
                            </li>
                            {% endif %}

                            <!-- Next Button -->
                            <li class="page-item {% if not page_obj.has_next %}disabled{% endif %}">
                                {% if page_obj.has_next %}
                                <a class="page-link"
                                    href="?page={{ page_obj.next_page_number }}&recordsPerPage={{ records_per_page }}">
                                    <i class="bx bx-chevrons-right"></i>
                                </a>
                                {% else %}
                                <span class="page-link disabled">
                                    <i class="bx bx-chevrons-right"></i>
                                </span>
                                {% endif %}
                            </li>

                        </ul>
                    </nav>
                </div>

            </div>



        </div>

    </div>

    <!-- Host Details Modal -->
    <div class="modal fade" id="hostDetailsModal" tabindex="-1" aria-labelledby="hostDetailsModalLabel"
        aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header table-primary text-white">
                    <h5 class="modal-title" id="hostDetailsModalLabel">
                        <i class="bx bx-folder-open"></i>
                        <span id="hd-header-hosting-provider" class="fw-bold text-primary text-uppercase"></span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body px-4 py-3">
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped align-middle">
                            <tbody>
                                <!-- Project Info -->
                                <tr class="table-light">
                                    <th colspan="4"><i class="bx bx-briefcase me-2"></i> Project Info</th>
                                </tr>
                                <tr>
                                    <th>Project(s)</th>
                                    <td colspan="3" id="hd-projects"></td>
                                </tr>
                                <tr>
                                    <th>Hosting Provider</th>
                                    <td colspan="3" id="hd-hosting-provider"></td>
                                </tr>
                                <tr>
                                    <th>Server Name</th>
                                    <td colspan="3" id="hd-server-name"></td>
                                </tr>
                                <tr>
                                    <th>Server Type</th>
                                    <td id="hd-server-type"></td>
                                    <th>Plan / Package</th>
                                    <td id="hd-plan-package"></td>
                                </tr>

                                <!-- Network & OS -->
                                <tr class="table-light">
                                    <th colspan="4"><i class="bx bx-server me-2"></i> Network & OS</th>
                                </tr>
                                <tr>
                                    <th>Server IP</th>
                                    <td id="hd-server-ip"></td>
                                    <th>Operating System</th>
                                    <td id="hd-operating-system"></td>
                                </tr>
                                <tr>
                                    <th>Login URL</th>
                                    <td colspan="3" id="hd-login-url"></td>
                                </tr>
                                <tr>
                                    <th>Username</th>
                                    <td id="hd-username"></td>
                                    <th>Password</th>
                                    <td>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="hd-password" readonly>
                                            <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                                                <i class="bx bx-show"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <th>SSH Username</th>
                                    <td id="hd-ssh-username"></td>
                                    <th>SSH / FTP Access</th>
                                    <td id="hd-ssh-ftp-access"></td>
                                </tr>

                                <!-- Database -->
                                <tr class="table-light">
                                    <th colspan="4"><i class="bx bx-cloud me-2"></i> Database</th>
                                </tr>
                                <tr>
                                    <th>Database Name</th>
                                    <td id="hd-database-name"></td>
                                    <th>DB Username</th>
                                    <td id="hd-db-username"></td>
                                </tr>
                                <tr>
                                    <th>DB Password</th>
                                    <td>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="hd-db-password" readonly>
                                            <button class="btn btn-outline-secondary" type="button"
                                                id="toggleDbPassword">
                                                <i class="bx bx-show"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>

                                <!-- Dates & Cost -->
                                <tr class="table-light">
                                    <th colspan="4"><i class="bx bx-calendar me-2"></i> Dates & Cost</th>
                                </tr>
                                <tr>
                                    <th>Purchase Date</th>
                                    <td id="hd-purchase-date"></td>
                                    <th>Expiry Date</th>
                                    <td id="hd-expiry-date"></td>
                                </tr>
                                <tr>
                                    <th>Server Cost (₹)</th>
                                    <td colspan="3" id="hd-server-cost"></td>
                                </tr>

                                <!-- Metrics -->
                                <tr class="table-light">
                                    <th colspan="4"><i class="bx bx-bar-chart-alt-2 me-2"></i> Metrics</th>
                                </tr>
                                <tr>
                                    <th>Memory</th>
                                    <td colspan="3" id="hd-memory-usage"></td>
                                </tr>
                                <tr>
                                    <th>RAM</th>
                                    <td colspan="3" id="hd-ram"></td>
                                </tr>
                                <tr>
                                    <th>Backup Status</th>
                                    <td colspan="3" id="hd-backup-status"></td>
                                </tr>

                                <!-- Services & Notes -->
                                <tr class="table-light">
                                    <th colspan="4"><i class="bx bx-link me-2"></i> Services & Notes</th>
                                </tr>
                                <tr>
                                    <th>Linked Services</th>
                                    <td colspan="3" id="hd-linked-services"></td>
                                </tr>
                                <tr>
                                    <th>Status</th>
                                    <td colspan="3" id="hd-status"></td>
                                </tr>
                                <tr>
                                    <th>Notes</th>
                                    <td colspan="3" id="hd-notes"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Add Host Data Modal -->
    <div class="modal fade" id="addHostDataModal" tabindex="-1" aria-labelledby="addHostDataModalLabel"
        aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header table-primary text-white">
                    <h5 class="modal-title" id="addHostDataModalLabel">
                        <i class="bx bx-plus me-2"></i> Add New Host Data
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>

                <form id="hostDataForm" method="POST">
                    {% csrf_token %}
                    <div class="modal-body px-4 py-3" style="max-height: 70vh; overflow-y: auto;">
                        <div class="table-responsive">
                            <table class="table table-bordered align-middle">
                                <tbody>

                                    <!-- ==================== Project Info ==================== -->
                                    <tr class="table-light">
                                        <th colspan="4"><i class="bx bx-briefcase me-2"></i> Project Info</th>
                                    </tr>
                                    <tr>
                                        <th>Project(s)</th>
                                        <td colspan="3">
                                            <select class="form-control tom-select" name="project" id="add-project" multiple>
                                                <option value="">Search projects</option>
                                                {% for project in projects %}
                                                <option value="{{ project.id }}">{{ project.project_name }}</option>
                                                {% endfor %}
                                            </select>
                                            <small class="text-muted">Hold Ctrl (Windows) or Command (Mac) to select
                                                multiple</small>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Hosting Provider</th>
                                        <td colspan="3">
                                            <input type="text" class="form-control" name="hosting_provider"
                                                placeholder="Enter hosting provider">
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Server Name</th>
                                        <td colspan="3">
                                            <input type="text" class="form-control" name="server_name"
                                                placeholder="Enter server name">
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Server Type</th>
                                        <td>
                                            <input type="text" class="form-control" name="server_type"
                                                placeholder="Enter server type">
                                        </td>
                                        <th>Plan / Package</th>
                                        <td>
                                            <input type="text" class="form-control" name="plan_package"
                                                placeholder="Enter plan/package">
                                        </td>
                                    </tr>

                                    <!-- ==================== Network & OS ==================== -->
                                    <tr class="table-light">
                                        <th colspan="4"><i class="bx bx-server me-2"></i> Network & OS</th>
                                    </tr>
                                    <tr>
                                        <th>Server IP</th>
                                        <td>
                                            <input type="text" class="form-control" name="server_ip"
                                                placeholder="Enter server IP">
                                        </td>
                                        <th>Operating System</th>
                                        <td>
                                            <input type="text" class="form-control" name="operating_system"
                                                placeholder="Enter operating system">
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Login URL</th>
                                        <td>
                                            <input type="url" class="form-control" name="login_url"
                                                placeholder="Enter login URL">
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Username</th>
                                        <td>
                                            <input type="text" class="form-control" name="username"
                                                placeholder="Enter hosting username">
                                        </td>
                                        <th>Password</th>
                                        <td>
                                            <input type="password" class="form-control" name="password"
                                                placeholder="Enter hosting password">
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>SSH Username</th>
                                        <td>
                                            <input type="text" class="form-control" name="ssh_username"
                                                placeholder="Enter SSH username">
                                        </td>
                                        <th>SSH / FTP Access</th>
                                        <td>
                                            <input type="text" class="form-control" name="ssh_ftp_access"
                                                placeholder="Enter SSH/FTP access">
                                        </td>
                                    </tr>

                                    <!-- ==================== Database ==================== -->
                                    <tr class="table-light">
                                        <th colspan="4"><i class="bx bx-cloud me-2"></i> Database</th>
                                    </tr>
                                    <tr>
                                        <th>Database Name</th>
                                        <td>
                                            <input type="text" class="form-control" name="database_name"
                                                placeholder="Enter database name">
                                        </td>
                                        <th>DB Username</th>
                                        <td>
                                            <input type="text" class="form-control" name="db_username"
                                                placeholder="Enter DB username">
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>DB Password</th>
                                        <td colspan="3">
                                            <input type="password" class="form-control" name="db_password"
                                                placeholder="Enter DB password">
                                        </td>
                                    </tr>

                                    <!-- ==================== Dates & Cost ==================== -->
                                    <tr class="table-light">
                                        <th colspan="4"><i class="bx bx-calendar me-2"></i> Dates & Cost</th>
                                    </tr>
                                    <tr>
                                        <th>Purchase Date</th>
                                        <td>
                                            <input type="text" class="form-control flat-date" name="purchase_date"
                                                placeholder="Select purchase date">
                                        </td>
                                        <th>Expiry Date</th>
                                        <td>
                                            <input type="text" class="form-control flat-date" name="expiry_date"
                                                placeholder="Select expiry date">
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Server Cost (₹)</th>
                                        <td colspan="3">
                                            <input type="number" step="0.01" class="form-control" name="server_cost"
                                                placeholder="Enter server cost">
                                        </td>
                                    </tr>

                                    <!-- ==================== Metrics ==================== -->
                                    <tr class="table-light">
                                        <th colspan="4"><i class="bx bx-bar-chart-alt-2 me-2"></i> Metrics</th>
                                    </tr>
                                    <tr>
                                        <th>Memory</th>
                                        <td colspan="3">
                                            <input type="text" class="form-control" name="memory_usage"
                                                placeholder="e.g. 5.6 GB / 8 GB">
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>RAM</th>
                                        <td colspan="3">
                                            <input type="text" class="form-control" name="disk_space"
                                                placeholder="e.g. 120 GB / 150 GB">
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Backup Status</th>
                                        <td colspan="3">
                                            <select class="form-select" name="backup_status">
                                                <option value="">-- Select Backup Status --</option>
                                                <option value="Scheduled">Scheduled</option>
                                                <option value="Completed">Completed</option>
                                                <option value="Failed">Failed</option>
                                            </select>
                                        </td>
                                    </tr>

                                    <!-- ==================== Services & Notes ==================== -->
                                    <tr class="table-light">
                                        <th colspan="4"><i class="bx bx-link me-2"></i> Services & Notes</th>
                                    </tr>
                                    <tr>
                                        <th>Linked Services</th>
                                        <td colspan="3">
                                            <textarea class="form-control" name="linked_services" rows="2"
                                                placeholder="e.g. Nginx, MySQL, Docker"></textarea>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Status</th>
                                        <td colspan="3">
                                            <select class="form-select" name="status">
                                                <option value="">-- Select Status --</option>
                                                <option value="Active">Active</option>
                                                <option value="Inactive">Inactive</option>
                                                <option value="Expired">Expired</option>
                                            </select>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Notes</th>
                                        <td colspan="3">
                                            <textarea class="form-control" name="notes" rows="2"
                                                placeholder="Enter additional notes"></textarea>
                                        </td>
                                    </tr>

                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Save Server</button>
                    </div>
                </form>
            </div>
        </div>
    </div>



    <!-- Edit Host Data Modal -->
    <div class="modal fade" id="editHostModal" tabindex="-1" aria-labelledby="editHostModalLabel" aria-hidden="true"
        data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header table-primary text-white">
                    <h5 class="modal-title" id="editHostModalLabel">
                        <i class="bx bx-edit-alt me-2"></i> Edit Server / Host Data
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>

                <form id="editHostForm" method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="host_id" id="edit-host-id">

                    <div class="modal-body px-4 py-3" style="max-height: 70vh; overflow-y: auto;">
                        <div class="table-responsive">
                            <table class="table table-bordered align-middle">
                                <tbody>
                                    <!-- Project Info -->
                                    <tr class="table-light">
                                        <th colspan="4"><i class="bx bx-briefcase me-2"></i> Project Info</th>
                                    </tr>
                                    <tr>
                                        <th>Project(s)</th>
                                        <td colspan="3">
                                            <select class="form-control tom-select" name="project" id="edit-project" multiple>
                                                <option value="">Search projects</option>
                                                {% for project in projects %}
                                                <option value="{{ project.id }}">{{ project.project_name }}</option>
                                                {% endfor %}
                                            </select>
                                            <small class="text-muted">Hold Ctrl (Windows) or Command (Mac) to select
                                                multiple</small>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Hosting Provider</th>
                                        <td colspan="3">
                                            <input type="text" class="form-control" name="hosting_provider"
                                                id="edit-hosting-provider" placeholder="Enter hosting provider">
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Server Name</th>
                                        <td colspan="3">
                                            <input type="text" class="form-control" name="server_name"
                                                id="edit-server-name" placeholder="Enter server name">
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Server Type</th>
                                        <td>
                                            <input type="text" class="form-control" name="server_type"
                                                id="edit-server-type" placeholder="Enter server type">
                                        </td>
                                        <th>Plan / Package</th>
                                        <td>
                                            <input type="text" class="form-control" name="plan_package"
                                                id="edit-plan-package" placeholder="Enter plan/package">
                                        </td>
                                    </tr>

                                    <!-- Network & OS -->
                                    <tr class="table-light">
                                        <th colspan="4"><i class="bx bx-server me-2"></i> Network & OS</th>
                                    </tr>
                                    <tr>
                                        <th>Server IP</th>
                                        <td>
                                            <input type="text" class="form-control" name="server_ip" id="edit-server-ip"
                                                placeholder="Enter server IP">
                                        </td>
                                        <th>Operating System</th>
                                        <td>
                                            <input type="text" class="form-control" name="operating_system"
                                                id="edit-operating-system" placeholder="Enter operating system">
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Login URL</th>
                                        <td colspan="3">
                                            <input type="url" class="form-control" name="login_url" id="edit-login-url"
                                                placeholder="Enter login URL">
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Username</th>
                                        <td>
                                            <input type="text" class="form-control" name="username" id="edit-username"
                                                placeholder="Enter hosting username">
                                        </td>
                                        <th>Password</th>
                                        <td>
                                            <div class="input-group">
                                                <input type="password" class="form-control" name="password"
                                                    id="edit-password" placeholder="Enter hosting password">
                                                <button class="btn btn-outline-secondary" type="button"
                                                    id="edit-toggle-password">
                                                    <i class="bx bx-show"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>SSH Username</th>
                                        <td>
                                            <input type="text" class="form-control" name="ssh_username"
                                                id="edit-ssh-username" placeholder="Enter SSH username">
                                        </td>
                                        <th>SSH / FTP Access</th>
                                        <td>
                                            <input type="text" class="form-control" name="ssh_ftp_access"
                                                id="edit-ssh-ftp-access" placeholder="Enter SSH/FTP access">
                                        </td>
                                    </tr>

                                    <!-- Database -->
                                    <tr class="table-light">
                                        <th colspan="4"><i class="bx bx-cloud me-2"></i> Database</th>
                                    </tr>
                                    <tr>
                                        <th>Database Name</th>
                                        <td>
                                            <input type="text" class="form-control" name="database_name"
                                                id="edit-database-name" placeholder="Enter database name">
                                        </td>
                                        <th>DB Username</th>
                                        <td>
                                            <input type="text" class="form-control" name="db_username"
                                                id="edit-db-username" placeholder="Enter DB username">
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>DB Password</th>
                                        <td colspan="3">
                                            <div class="input-group">
                                                <input type="password" class="form-control" name="db_password"
                                                    id="edit-db-password" placeholder="Enter DB password">
                                                <button class="btn btn-outline-secondary" type="button"
                                                    id="edit-toggle-db-password">
                                                    <i class="bx bx-show"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>

                                    <!-- Dates & Cost -->
                                    <tr class="table-light">
                                        <th colspan="4"><i class="bx bx-calendar me-2"></i> Dates & Cost</th>
                                    </tr>
                                    <tr>
                                        <th>Purchase Date</th>
                                        <td>
                                            <input type="text" class="form-control flat-date" name="purchase_date"
                                                id="edit-purchase-date" placeholder="Select purchase date">
                                        </td>
                                        <th>Expiry Date</th>
                                        <td>
                                            <input type="text" class="form-control flat-date" name="expiry_date"
                                                id="edit-expiry-date" placeholder="Select expiry date">
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Server Cost (₹)</th>
                                        <td colspan="3">
                                            <input type="number" step="0.01" class="form-control" name="server_cost"
                                                id="edit-server-cost" placeholder="Enter server cost">
                                        </td>
                                    </tr>

                                    <!-- Metrics -->
                                    <tr class="table-light">
                                        <th colspan="4"><i class="bx bx-bar-chart-alt-2 me-2"></i> Metrics</th>
                                    </tr>
                                    <tr>
                                        <th>Memory</th>
                                        <td colspan="3">
                                            <input type="text" class="form-control" name="memory_usage"
                                                id="edit-memory-usage" placeholder="e.g. 5.6 GB / 8 GB">
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>RAM</th>
                                        <td colspan="3">
                                            <input type="text" class="form-control" name="disk_space"
                                                id="edit-disk-space" placeholder="e.g. 120 GB / 150 GB">
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Backup Status</th>
                                        <td colspan="3">
                                            <select class="form-select" name="backup_status" id="edit-backup-status">
                                                <option value="">-- Select Backup Status --</option>
                                                <option value="Scheduled">Scheduled</option>
                                                <option value="Completed">Completed</option>
                                                <option value="Failed">Failed</option>
                                            </select>
                                        </td>
                                    </tr>

                                    <!-- Services & Notes -->
                                    <tr class="table-light">
                                        <th colspan="4"><i class="bx bx-link me-2"></i> Services & Notes</th>
                                    </tr>
                                    <tr>
                                        <th>Linked Services</th>
                                        <td colspan="3">
                                            <textarea class="form-control" name="linked_services"
                                                id="edit-linked-services" rows="2"
                                                placeholder="e.g. Nginx, MySQL, Docker"></textarea>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Status</th>
                                        <td colspan="3">
                                            <select class="form-select" name="status" id="edit-status">
                                                <option value="">-- Select Status --</option>
                                                <option value="Active">Active</option>
                                                <option value="Inactive">Inactive</option>
                                                <option value="Expired">Expired</option>
                                            </select>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Notes</th>
                                        <td colspan="3">
                                            <textarea class="form-control" name="notes" id="edit-notes" rows="2"
                                                placeholder="Enter additional notes"></textarea>
                                        </td>
                                    </tr>

                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Update Server</button>
                    </div>
                </form>
            </div>
        </div>
    </div>



    <!-- Delete Host Confirmation Modal -->
    <div class="modal fade" id="deleteHostModal" tabindex="-1" aria-labelledby="deleteHostLabel" aria-hidden="true"
        data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content text-center">
                <div class="modal-header border-0">
                    <h5 class="modal-title w-100" id="deleteHostLabel">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this host?
                </div>
                <div class="modal-footer justify-content-center border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteHostBtn">Delete</button>
                </div>
            </div>
        </div>
    </div>

</div>
{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="{% static 'js/common.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {

        // searching
        enableTableSearch("searchBox", "hostTable");
        // sorting

        enableTableSorting("hostTable");

        // dropdown with search
         document.querySelectorAll(".tom-select").forEach(function(el) {
                new TomSelect(el, {
                    create: false,
                     plugins: ['remove_button'], // add X remove button
                    sortField: {
                        field: "text",
                        direction: "asc"
                    }
                });
                
    });
        $(document).ready(function () {
            const hostDetailsUrl = "{% url 'get_host_details' %}";



            // VIEW modal
            $(document).on("click", ".host-link", function (e) {
                e.preventDefault();
                const hostId = $(this).data("host-id");
                if (!hostId) return console.error("Host ID missing!");
                // Toggle Hosting Password
                $("#togglePassword").on("click", function () {
                    const passwordField = $("#hd-password");
                    const type = passwordField.attr("type") === "password" ? "text" : "password";
                    passwordField.attr("type", type);
                    $(this).find("i").toggleClass("bx-show bx-hide");
                });

                // Toggle DB Password
                $("#toggleDbPassword").on("click", function () {
                    const passwordField = $("#hd-db-password");
                    const type = passwordField.attr("type") === "password" ? "text" : "password";
                    passwordField.attr("type", type);
                    $(this).find("i").toggleClass("bx-show bx-hide");
                });

                $.get(hostDetailsUrl, { id: hostId, mode: "view" }, function (res) {
                    if (!res.success) return console.error(res.error);
                    const h = res.host;
                    $("#hd-header-hosting-provider").text(h.hosting_provider);
                    // Projects (ManyToMany)
                    if (h.projects && h.projects.length > 0) {
                        const projectNames = h.projects.map(p => p.name).join(", ");
                        $("#hd-projects").text(projectNames);
                    } else {
                        $("#hd-projects").text("-");
                    }

                    // Project Info
                    $("#hd-hosting-provider").text(h.hosting_provider || '-');
                    $("#hd-server-name").text(h.server_name || '-');
                    $("#hd-server-type").text(h.server_type || '-');
                    $("#hd-plan-package").text(h.plan_package || '-');

                    // Network & OS
                    $("#hd-server-ip").text(h.server_ip || '-');
                    $("#hd-operating-system").text(h.operating_system || '-');
                    $("#hd-login-url").text(h.login_url || '-');
                    $("#hd-username").text(h.username || '-');
                    $("#hd-password").val(h.password || '-');
                    $("#hd-ssh-username").text(h.ssh_username || '-');
                    $("#hd-ssh-ftp-access").text(h.ssh_ftp_access || '-');

                    // Database
                    $("#hd-database-name").text(h.database_name || '-');
                    $("#hd-db-username").text(h.db_username || '-');
                    $("#hd-db-password").val(h.db_password || '-');

                    // Dates & Cost
                    $("#hd-purchase-date").text(formatDate(h.purchase_date || '-'));
                    $("#hd-expiry-date").text(formatDate(h.expiry_date || '-'));
                    $("#hd-server-cost").text(h.server_cost || '-');

                    // Metrics
                    $("#hd-memory-usage").text(h.memory || '-');
                    $("#hd-ram").text(h.ram || '-');

                    // Backup Status badge
                    let backupBadge = '';
                    if (h.backup_status === "Scheduled") {
                        backupBadge = `<span class="badge bg-label-info">${h.backup_status}</span>`;
                    } else if (h.backup_status === "Completed") {
                        backupBadge = `<span class="badge bg-label-success">${h.backup_status}</span>`;
                    } else if (h.backup_status === "Failed") {
                        backupBadge = `<span class="badge bg-label-danger">${h.backup_status}</span>`;
                    } else {
                        backupBadge = `<span class="badge bg-label-secondary">${h.backup_status || '-'}</span>`;
                    }
                    $("#hd-backup-status").html(backupBadge);

                    // Services & Notes
                    $("#hd-linked-services").text(h.linked_services || '-');

                    // Status badge
                    let statusBadge = '';
                    if (h.status === "Active") {
                        statusBadge = `<span class="badge bg-label-success">${h.status}</span>`;
                    } else if (h.status === "Inactive") {
                        statusBadge = `<span class="badge bg-label-warning">${h.status}</span>`;
                    } else if (h.status === "Expired") {
                        statusBadge = `<span class="badge bg-label-danger">${h.status}</span>`;
                    } else {
                        statusBadge = `<span class="badge bg-label-secondary">${h.status || '-'}</span>`;
                    }
                    $("#hd-status").html(statusBadge);

                    $("#hd-notes").text(h.notes || '-');

                    // Show modal
                    $("#hostDetailsModal").modal("show");
                });
            });

            // EDIT modal

            $(document).on("click", ".edit-host", function (e) {
                // Password toggle
                $("#edit-toggle-password").click(function () {
                    const input = $("#edit-password");
                    const icon = $(this).find("i");
                    if (input.attr("type") === "password") {
                        input.attr("type", "text");
                        icon.removeClass("bx-show").addClass("bx-hide");
                    } else {
                        input.attr("type", "password");
                        icon.removeClass("bx-hide").addClass("bx-show");
                    }
                });

                $("#edit-toggle-db-password").click(function () {
                    const input = $("#edit-db-password");
                    const icon = $(this).find("i");
                    if (input.attr("type") === "password") {
                        input.attr("type", "text");
                        icon.removeClass("bx-show").addClass("bx-hide");
                    } else {
                        input.attr("type", "password");
                        icon.removeClass("bx-hide").addClass("bx-show");
                    }
                });

                e.preventDefault();
                const hostId = $(this).data("host-id");
                if (!hostId) return console.error("Host ID missing on Edit button!");

                $.get(hostDetailsUrl, { id: hostId, mode: "edit" }, function (res) {
                    if (!res.success) return console.error(res.error);
                    const h = res.host;

                    // Set form action and hidden input
                    $("#editHostForm").attr("action", `/update_host_data/${hostId}/`);
                    $("#edit-host-id").val(hostId);

                    // Clear old selection
                    $("#edit-project").val([]);

                    // If backend returned multiple projects
                    if (h.projects && h.projects.length > 0) {
                        const ids = h.projects.map(p => p.id.toString());
                        // $("#edit-project").val(ids).trigger("change");  
                        document.getElementById("edit-project").tomselect.setValue(ids);
                    }

                    $("#edit-server-name").val(h.server_name || '');
                    $("#edit-hosting-provider").val(h.hosting_provider || '');
                    $("#edit-server-type").val(h.server_type || '');
                    $("#edit-plan-package").val(h.plan_package || '');
                    $("#edit-server-ip").val(h.server_ip || '');
                    $("#edit-operating-system").val(h.operating_system || '');
                    $("#edit-login-url").val(h.login_url || '');
                    $("#edit-username").val(h.username || '');
                    $("#edit-password").val(h.password || '');
                    $("#edit-ssh-username").val(h.ssh_username || '');
                    $("#edit-ssh-ftp-access").val(h.ssh_ftp_access || '');
                    $("#edit-database-name").val(h.database_name || '');
                    $("#edit-db-username").val(h.db_username || '');
                    $("#edit-db-password").val(h.db_password || '');
                    // When populating edit modal
                    if (h.purchase_date) {
                        $("#edit-purchase-date")[0]._flatpickr.setDate(h.purchase_date);
                    } else {
                        $("#edit-purchase-date").val('');
                    }

                    if (h.expiry_date) {
                        $("#edit-expiry-date")[0]._flatpickr.setDate(h.expiry_date);
                    } else {
                        $("#edit-expiry-date").val('');
                    }
                    $("#edit-server-cost").val(h.server_cost || '');
                    $("#edit-memory-usage").val(h.memory || '');
                    $("#edit-disk-space").val(h.ram || '');
                    $("#edit-backup-status").val(h.backup_status || '');
                    $("#edit-linked-services").val(h.linked_services || '');
                    $("#edit-status").val(h.status || '');
                    $("#edit-notes").val(h.notes || '');

                    $("#editHostModal").modal("show");
                });
            });

            // deleet modal
            let hostIdToDelete = null;

            $(document).on("click", ".delete-host", function (e) {
                e.preventDefault();
                hostIdToDelete = $(this).data("host-id");
                if (!hostIdToDelete) return console.error("Host ID missing!");

                let deleteModal = new bootstrap.Modal(document.getElementById('deleteHostModal'));
                deleteModal.show();
            });

            $(document).on("click", "#confirmDeleteHostBtn", function () {
                if (!hostIdToDelete) return;

                $.ajax({
                    url: `/delete_host/${hostIdToDelete}/`,
                    type: "POST",
                    data: {
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                    },
                    success: function (res) {
                        if (res.success) {
                            showToast(res.message, "success");
                            setTimeout(() => window.location.reload(), 800);
                        } else {
                            showToast(res.error || "Failed to delete host.", "danger");
                        }
                    },
                    error: function (err) {
                        console.error("Error deleting host:", err);
                        showToast("Unexpected error while deleting host.", "danger");

                    }
                });

                // Hide modal
                let deleteModalEl = document.getElementById('deleteHostModal');
                let deleteModalInstance = bootstrap.Modal.getInstance(deleteModalEl);
                deleteModalInstance.hide();
            });

        });

        document.getElementById("hostDataForm").addEventListener("submit", function (e) {
            e.preventDefault();
            let form = this;
            let formData = new FormData(form);

            fetch("/add_host_data/", {
                method: "POST",
                body: formData,
                headers: {
                    "X-Requested-With": "XMLHttpRequest",
                    "X-CSRFToken": form.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
                .then(res => res.json())
                .then(data => {
                    // Clear validation errors
                    form.querySelectorAll(".is-invalid").forEach(el => el.classList.remove("is-invalid"));
                    form.querySelectorAll(".invalid-feedback").forEach(el => el.innerText = "");

                    if (data.success) {
                        let modalEl = document.getElementById("addHostDataModal");
                        let modal = bootstrap.Modal.getInstance(modalEl);
                        modal.hide();

                        showToast(data.message, "success");
                        setTimeout(() => window.location.reload(), 800);
                    } else {
                        if (data.errors) {
                            for (let field in data.errors) {
                                let input = form.querySelector(`[name="${field}"]`);
                                if (input) {
                                    input.classList.add("is-invalid");
                                    let feedback = input.closest("td,div").querySelector(".invalid-feedback");
                                    if (!feedback) {
                                        feedback = document.createElement("div");
                                        feedback.classList.add("invalid-feedback");
                                        input.parentNode.appendChild(feedback);
                                    }
                                    feedback.innerText = data.errors[field].join(", ");
                                }
                            }
                        }
                        if (data.errors["__all__"]) {
                            showToast(data.errors["__all__"].join(", "), "danger");
                        }
                    }
                })
                .catch(err => {
                    console.error("Error:", err);
                    showToast("Unexpected error while saving host data.", "danger");
                });
        });

        document.getElementById("editHostForm").addEventListener("submit", function (e) {
            e.preventDefault();
            let form = this;
            let formData = new FormData(form);
            let hostId = document.getElementById("edit-host-id").value;

            fetch(`/update_host_data/${hostId}/`, {
                method: "POST",
                body: formData,
                headers: {
                    "X-Requested-With": "XMLHttpRequest",
                    "X-CSRFToken": form.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
                .then(res => res.json())
                .then(data => {
                    // Clear previous errors
                    form.querySelectorAll(".is-invalid").forEach(el => el.classList.remove("is-invalid"));
                    form.querySelectorAll(".invalid-feedback").forEach(el => el.innerText = "");

                    if (data.success) {
                        let modalEl = document.getElementById("editHostModal");
                        let modal = bootstrap.Modal.getInstance(modalEl);
                        modal.hide();
                        showToast(data.message, "success");
                        setTimeout(() => window.location.reload(), 800);
                    } else {
                        if (data.errors) {
                            for (let field in data.errors) {
                                let input = form.querySelector(`[name="${field}"]`);
                                if (input) {
                                    input.classList.add("is-invalid");
                                    let feedback = input.closest("td,div").querySelector(".invalid-feedback");
                                    if (feedback) feedback.innerText = data.errors[field].join(", ");
                                }
                            }
                        }
                        if (data.errors["__all__"]) {
                            showToast(data.errors["__all__"].join(", "), "danger");
                        }
                    }
                })
                .catch(err => {
                    console.error("Error:", err);
                    showToast("Unexpected error while updating host data.", "danger");
                });
        });

    });
</script>
{% endblock %}
{% endblock %}
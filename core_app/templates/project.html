{% extends "base.html" %}
{% load static %}
{% block title %}All Domains{% endblock %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>


{% block extra_css %}
<style>
  

    select.readonly {
        pointer-events: none;
        /* blocks click */
        background-color: #eceef1 !important;
        /* your requested color */
        color: #495057;
        /* optional: text color like Bootstrap disabled */
    }

    .alert-success {
        background-color: #017004 !important;
        /* Green */
        color: black !important;
    }

    /* Example: Custom error background */
    .alert-error,
    .alert-danger {
        background-color: #F44336;
        /* Red */
        color: black;
    }

    /* Example: Custom info background */
    .alert-info {
        background-color: #2196F3;
        /* Blue */
        color: black;
    }

    /* Example: Custom warning background */
    .alert-warning {
        background-color: #FF9800;
        /* Orange */
        color: black;
    }

    .scrollable-table-body {
        max-height: 400px;
        /* Adjust height as needed */
        overflow-y: auto;
    }

    .scrollable-table-body table {
        margin-bottom: 0;
        /* Avoid extra spacing */
    }

    /* Optional: Fix the header */
    .scrollable-table-body thead th {
        position: sticky;
        top: 0;
        background: #fff;
        z-index: 1;
    }
</style>
{% endblock %}

{% block content %}
{% if messages %}
<div id="toast-container    " style="
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 3000;  /* above sidebar/navbar */
    display: flex;
    flex-direction: column;
    gap: 10px;
">
    {% for message in messages %}
    <div class="toast align-items-center text-white bg-{{ message.tags }} border-0 show" role="alert"
        aria-live="assertive" aria-atomic="true" style="min-width: 250px;">
        <div class="d-flex">
            <div class="toast-body">
                {{ message }}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                aria-label="Close"></button>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}


<div class="content-wrapper">

    <!-- Content -->
    <div class="container-xxl flex-grow-1 container-p-y">
        <!-- Project Status Cards -->
        <div class="row mb-4">
            <!-- Total Projects -->
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card h-100 shadow-sm border-0">
                    <div class="card-body d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="mb-1">Total Projects</h6>
                            <h4 class="fw-bold">{{total_projects}}</h4>
                        </div>
                        <div class="avatar bg-primary text-white rounded-circle p-2">
                            <i class="bx bx-folder-open fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- In Progress -->
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card h-100 shadow-sm border-0">
                    <div class="card-body d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="mb-1">In Progress</h6>
                            <h4 class="fw-bold text-info">{{ongoing_count}}</h4>
                        </div>
                        <div class="avatar bg-info text-white rounded-circle p-2">
                            <i class="bx bx-loader-circle fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Completed -->
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card h-100 shadow-sm border-0">
                    <div class="card-body d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="mb-1">Completed</h6>
                            <h4 class="fw-bold text-success">{{completed_count}}</h4>
                        </div>
                        <div class="avatar bg-success text-white rounded-circle p-2">
                            <i class="bx bx-check-circle fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cancelled -->
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card h-100 shadow-sm border-0">
                    <div class="card-body d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="mb-1">Cancelled</h6>
                            <h4 class="fw-bold text-danger">{{cancelled_count}}</h4>
                        </div>
                        <div class="avatar bg-danger text-white rounded-circle p-2">
                            <i class="bx bx-x-circle fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- All Projects Table -->
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="mb-0">All Projects</h4>
                    <div class="d-flex gap-2">

                        <button type="button" class="btn btn-outline-secondary" title="Filter Projects">
                            <i class="bx bx-filter-alt"></i>
                        </button>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                            data-bs-target="#addProjectModal">
                            <i class="bx bx-plus"></i> Add Project
                        </button>
                    </div>
                </div>

                <div class="table-responsive text-nowrap scrollable-table-body">
                    <table class="table" id="projectTable">
                        <thead>
                            <tr>
                                <th data-sort="number">Sr No.</th>
                                <th data-sort="string">Project ID</th>
                                <th data-sort="string">Project Name</th>
                                <th data-sort="string">Start Date</th>
                                <th data-sort="string">App Mode</th>
                                <th data-sort="string">Status</th>
                                <th>Team Members</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody class="table-border-bottom-0">
                            {% for project in page_obj %}

                            <tr>

                                <th>{{ forloop.counter0|add:page_obj.start_index }}</th>
                                <td>{{ project.project_id }}</td>
                                <td>
                                    <a href="#" data-bs-toggle="modal" data-bs-target="#projectDetailsModal"
                                        class="fw-bold project-link" data-project-id="{{ project.id }}">
                                        {{ project.project_name }}
                                    </a>
                                </td>
                                <td>{{ project.start_date }}</td>
                                <td>
                                    {% if project.app_modes.all %}
                                    {% for mode in project.app_modes.all %}
                                    {{ mode.name }}{% if not forloop.last %}<br /> {% endif %}
                                    {% endfor %}
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>

                                <td>
                                    {% if project.status == "In Progress" %}
                                    <span class="badge bg-label-warning">{{ project.status }}</span>
                                    {% elif project.status == "Completed" %}
                                    <span class="badge bg-label-success">{{ project.status }}</span>
                                    {% elif project.status == "On Hold" %}
                                    <span class="badge bg-label-primary">{{ project.status }}</span>
                                    {% elif project.status == "Cancelled" %}
                                    <span class="badge bg-label-danger">{{ project.status }}</span>
                                    {% else %}
                                    <span class="badge bg-label-secondary">{{ project.status }}</span>
                                    {% endif %}

                                </td>
                                <td>
                                    <ul class="list-unstyled d-flex align-items-center avatar-group mb-0">
                                        {% for member in project.team_members.all|slice:":4" %}
                                        <li data-bs-toggle="tooltip"
                                            title="{{ member.first_name }} {{ member.last_name }}"
                                            class="avatar avatar-xs pull-up view-user" data-user-id="{{ member.id }}"
                                            style="margin-left: -8px; cursor:pointer; border:2px solid #fff; border-radius:50%;">
                                            {% if member.profile_picture %}
                                            <img src="{{ member.profile_picture.url }}" alt="{{ member.first_name }}"
                                                class="rounded-circle" style="width:30px; height:30px;" />
                                            {% else %}
                                            <img src="{% static 'img/avatars/default-avatar.png' %}"
                                                alt="{{ member.first_name }}" class="rounded-circle"
                                                style="width:30px; height:30px;" />
                                            {% endif %}
                                        </li>
                                        {% endfor %}

                                        {% if project.team_members.count > 4 %}
                                        <li class="avatar avatar-xs"
                                            style="margin-left: -8px; width:30px; height:30px; display:flex; align-items:center; justify-content:center; background:#eee; border-radius:50%; border:2px solid #fff; font-size:12px; font-weight:600;">
                                            +{{ project.team_members.count|add:"-4" }}
                                        </li>
                                        {% endif %}
                                    </ul>
                                </td>

                                <td>

                                    <a href="{% url 'update_project' project.id %}"
                                        class="text-primary me-2 action-icon edit-project"
                                        data-project-id="{{ project.id }}" title="Edit">
                                        <i class="bx bx-edit-alt"></i>
                                    </a>

                                    <a href="#" class="text-danger action-icon delete-project"
                                        data-id="{{ project.id }}" title="Delete">
                                        <i class="bx bx-trash"></i>
                                    </a>

                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="8">No projects found.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>





                </div>
                <!-- Records Per Page & Pagination -->
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div class="d-flex align-items-center">
                        <form method="GET" id="recordsForm" class="d-flex align-items-center">
                            <label for="recordsPerPage" class="me-2 mb-0">Records per page:</label>
                            <select class="form-select form-select-sm" name="recordsPerPage" id="recordsPerPage"
                                style="width: auto;">
                                {% for option in records_options %}
                                <option value="{{ option }}" {% if records_per_page == option %}selected{% endif %}>
                                    {{ option }}
                                </option>
                                {% endfor %}
                            </select>
                        </form>
                    </div>

                    <!-- Pagination -->
                    <nav aria-label="Page navigation" class="mt-3">
                        <ul class="pagination justify-content-end mb-0">

                            <!-- Previous Button -->
                            <li class="page-item {% if not page_obj.has_previous %}disabled{% endif %}">
                                {% if page_obj.has_previous %}
                                <a class="page-link"
                                    href="?page={{ page_obj.previous_page_number }}&recordsPerPage={{ records_per_page }}">
                                    <i class="bx bx-chevrons-left"></i>
                                </a>
                                {% else %}
                                <span class="page-link disabled">
                                    <i class="bx bx-chevrons-left"></i>
                                </span>
                                {% endif %}
                            </li>


                            <!-- Always show page 1 -->
                            <li class="page-item {% if page_obj.number == 1 %}active{% endif %}">
                                <a class="page-link" href="?page=1&recordsPerPage={{ records_per_page }}">1</a>
                            </li>

                            <!-- Always show page 2 if exists -->
                            {% if page_obj.paginator.num_pages >= 2 %}
                            <li class="page-item {% if page_obj.number == 2 %}active{% endif %}">
                                <a class="page-link" href="?page=2&recordsPerPage={{ records_per_page }}">2</a>
                            </li>
                            {% endif %}

                            <!-- Ellipsis if thereâ€™s a gap before last two pages -->
                            {% if page_obj.paginator.num_pages > 4 %}
                            <li class="page-item disabled"><span class="page-link">â€¦</span></li>
                            {% endif %}

                            <!-- Show second last page only if it's not duplicate of page 2 -->
                            {% if page_obj.paginator.num_pages > 2 and page_obj.paginator.num_pages|add:'-1' != 2 %}
                            <li
                                class="page-item {% if page_obj.number == page_obj.paginator.num_pages|add:'-1' %}active{% endif %}">
                                <a class="page-link"
                                    href="?page={{ page_obj.paginator.num_pages|add:'-1' }}&recordsPerPage={{ records_per_page }}">
                                    {{ page_obj.paginator.num_pages|add:'-1' }}
                                </a>
                            </li>
                            {% endif %}

                            <!-- Show last page only if it's not duplicate of page 2 -->
                            {% if page_obj.paginator.num_pages > 1 and page_obj.paginator.num_pages != 2 %}
                            <li
                                class="page-item {% if page_obj.number == page_obj.paginator.num_pages %}active{% endif %}">
                                <a class="page-link"
                                    href="?page={{ page_obj.paginator.num_pages }}&recordsPerPage={{ records_per_page }}">
                                    {{ page_obj.paginator.num_pages }}
                                </a>
                            </li>
                            {% endif %}

                            <!-- Next Button -->
                            <li class="page-item {% if not page_obj.has_next %}disabled{% endif %}">
                                {% if page_obj.has_next %}
                                <a class="page-link"
                                    href="?page={{ page_obj.next_page_number }}&recordsPerPage={{ records_per_page }}">
                                    <i class="bx bx-chevrons-right"></i>
                                </a>
                                {% else %}
                                <span class="page-link disabled">
                                    <i class="bx bx-chevrons-right"></i>
                                </span>
                                {% endif %}
                            </li>

                        </ul>
                    </nav>
                </div>


            </div>

        </div>


    </div>



    <!-- Add Project Modal -->
    <div class="modal fade" id="addProjectModal" tabindex="-1" aria-labelledby="addProjectModalLabel" aria-hidden="true"
        data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header table-primary text-white">
                    <h5 class="modal-title" id="addProjectModalLabel">
                        <i class="bx bx-plus me-2"></i> Add New Project
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>

                <form id="projectForm" method="POST" action="{% url 'save_project' %}">
                    {% csrf_token %}
                    <div class="modal-body px-4 py-3" style="max-height: 70vh; overflow-y: auto;">
                        <div class="table-responsive">
                            <table class="table table-bordered align-middle">
                                <tbody>

                                    <!-- ==================== Quotation Details ==================== -->
                                    <tr class="table-light">
                                        <th colspan="4"><i class="bx bx-file me-2"></i> Quotation Details</th>
                                    </tr>

                                    <tr>
                                        <th>Quotation</th>
                                        <td colspan="3">
                                            
                                            <select class="form-control tom-select"  name="quotation" id="quotationSelect">
                                                <option value="">Search quotation</option>
                                                {% for q in quotations %}
                                                <option value="{{ q.id }}">{{ q.quotation_no }} - {{ q.client_name }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                           
                                        </td>
                                    </tr>

                                    <tr>
                                        <th>Inquiry Date</th>
                                        <td>
                                            <input type="text" class="form-control flat-date" name="inquiry_date"
                                                placeholder="Select inquiry date">

                                        </td>
                                        <th>Lead Source</th>
                                        <td>
                                            <input type="text" class="form-control" name="lead_source"
                                                placeholder="Enter lead source">

                                        </td>
                                    </tr>

                                    <tr>
                                        <th>Quotation Sent</th>
                                        <td>
                                            <select class="form-select" name="quotation_sent">
                                                <option value="">-- Select --</option>
                                                <option value="Yes">Yes</option>
                                                <option value="No">No</option>
                                            </select>

                                        </td>
                                        <th>Demo Given</th>
                                        <td>
                                            <select class="form-select" name="demo_given">
                                                <option value="">-- Select --</option>
                                                <option value="Yes">Yes</option>
                                                <option value="No">No</option>
                                            </select>

                                        </td>
                                    </tr>

                                    <tr>
                                        <th>Quotation Amount (â‚¹)</th>
                                        <td>
                                            <input type="number" step="0.01" class="form-control"
                                                name="quotation_amount" placeholder="Enter quotation amount">

                                        </td>
                                        <th>Approval Amount (â‚¹)</th>
                                        <td>
                                            <input type="number" step="0.01" class="form-control" name="approval_amount"
                                                placeholder="Enter approval amount">

                                        </td>
                                    </tr>

                                    <tr>
                                        <th>Client Industry</th>
                                        <td>
                                            <input type="text" class="form-control" name="client_industry"
                                                placeholder="Enter client industry">

                                        </td>
                                        <th>Client</th>
                                        <td>
                                            <input type="text" class="form-control" name="client_name"
                                                placeholder="Enter client name">

                                        </td>
                                    </tr>

                                    <tr>
                                        <th>Contract Signed</th>
                                        <td colspan="3">
                                            <select class="form-select" name="contract_signed">
                                                <option value="">-- Select --</option>
                                                <option value="Yes">Yes</option>
                                                <option value="No">No</option>
                                            </select>

                                        </td>
                                    </tr>

                                    <!-- ==================== Project Details ==================== -->
                                    <tr class="table-light">
                                        <th colspan="4"><i class="bx bx-briefcase me-2"></i> Project Details</th>
                                    </tr>

                                    <tr>
                                        <th>Project Name</th>
                                        <td>
                                            <input type="text" class="form-control" name="project_name"
                                                placeholder="Enter project name">

                                        </td>
                                        <th>Project Type</th>
                                        <td>
                                            <select class="form-select" name="project_type">
                                                <option value="">-- Select Project Type --</option>
                                                <option value="Hourly">Hourly</option>
                                                <option value="Fixed">Fix</option>
                                                <option value="Salary">Salary</option>
                                            </select>

                                        </td>
                                    </tr>

                                    <tr>
                                        <th>Start Date</th>
                                        <td>
                                            <input type="text" class="form-control flat-date" name="start_date"
                                                placeholder="Select start date">

                                        </td>
                                        <th>Deadline</th>
                                        <td>
                                            <input type="text" class="form-control flat-date" name="deadline"
                                                placeholder="Select deadline date">

                                        </td>
                                    </tr>

                                    <tr>
                                        <th>Technologies</th>
                                        <td>
                                            <select class="form-control tom-select" name="technologies" multiple>
                                                <option value="">Search technologies</option>
                                                {% for tech in technologies %}
                                                <option value="{{ tech.id }}">{{ tech.name }}</option>
                                                {% endfor %}
                                            </select>
                                            <small class="text-muted">Hold CTRL (Windows) or CMD (Mac) to select
                                                multiple</small>

                                        </td>
                                        <th>App Mode</th>
                                        <td>
                                            <select class="form-control tom-select" name="app_mode" multiple>
                                                <option value="">Search Apps</option>
                                                {% for mode in app_modes %}
                                                <option value="{{ mode.id }}">{{ mode.name }}</option>
                                                {% endfor %}
                                            </select>
                                            <small class="text-muted">Hold CTRL (Windows) or CMD (Mac) to select
                                                multiple</small>
                                        </td>
                                    </tr>

                                    <tr>
                                        <th>Status</th>
                                        <td>
                                            <select class="form-select" name="status">
                                                <option value="">-- Select --</option>
                                                <option value="In Progress">In Progress</option>
                                                <option value="Completed">Completed</option>
                                                <option value="On Hold">On Hold</option>
                                                <option value="Cancelled">Cancelled</option>
                                            </select>

                                        </td>
                                        <th>Team Members</th>
                                        <td>
                                            <select class="form-control tom-select" name="team_members" multiple>
                                                <option value="">Search employee</option>
                                                {% for user in users %}
                                                <option value="{{ user.id }}">{{ user.first_name }} {{ user.last_name }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                            <small class="text-muted">Hold CTRL (Windows) or CMD (Mac) to select
                                                multiple</small>

                                        </td>
                                    </tr>

                                    <!-- Payment, Links, Financials, Free Service -->
                                    <tr>
                                        <th>Payment (â‚¹)</th>
                                        <td>
                                            <input type="number" class="form-control" name="payment_value"
                                                placeholder="Enter total payment value" min="0" readonly>

                                        </td>
                                        <th>Payment Status</th>
                                        <td>
                                            <select class="form-select" name="payment_status">
                                                <option value="Pending">Pending</option>
                                                <option value="Advanced">Advanced</option>
                                                <option value="Paid">Received</option>
                                            </select>

                                        </td>
                                    </tr>

                                    <tr>
                                        <th>Live Link</th>
                                        <td>
                                            <input type="url" class="form-control" name="live_link"
                                                placeholder="https://example.com">

                                        </td>
                                        <th>Postman Collection</th>
                                        <td>
                                            <input type="url" class="form-control" name="postman_collection"
                                                placeholder="https://example.com/postman.json">

                                        </td>
                                    </tr>

                                    <tr>
                                        <th>Data Folder</th>
                                        <td>
                                            <input type="url" class="form-control" name="data_folder"
                                                placeholder="https://example.com/data/">

                                        </td>
                                        <th>Other Link</th>
                                        <td>
                                            <input type="url" class="form-control" name="other_link"
                                                placeholder="https://example.com/other">

                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Frontend Link</th>
                                        <td>
                                            <input type="url" class="form-control" name="frontend_link"
                                                placeholder="https://example.com/other">

                                        </td>
                                        <th>Backend Link</th>
                                        <td>
                                            <input type="url" class="form-control" name="backend_link"
                                                placeholder="https://example.com/other">

                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Other Expense (â‚¹)</th>
                                        <td>
                                            <input type="number" class="form-control" name="other_expense"
                                                placeholder="Enter expense amount">

                                        </td>
                                        <th>Developer Charge (â‚¹)</th>
                                        <td>
                                            <input type="number" class="form-control" name="developer_charge"
                                                placeholder="Enter developer charge">

                                        </td>
                                    </tr>

                                    <tr>
                                        <th>Server Charge (â‚¹)</th>
                                        <td>
                                            <input type="number" class="form-control" name="server_charge"
                                                placeholder="Enter server charge">

                                        </td>
                                        <th>3rd Party API Charge (â‚¹)</th>
                                        <td>
                                            <input type="number" class="form-control" name="third_party_api_charge"
                                                placeholder="Enter 3rd party API charge">

                                        </td>
                                    </tr>

                                    <tr>
                                        <th>Mediator Charge (â‚¹)</th>
                                        <td>
                                            <input type="number" class="form-control" name="mediator_charge"
                                                placeholder="Enter mediator charge">

                                        </td>
                                        <th>Domain Charge (â‚¹)</th>
                                            <td>
                                                <input type="number" class="form-control" name="domain_charge"
                                                    placeholder="Enter Domain charge">
                                                
                                            </td>
                                    </tr>


                                    <tr>
                                        <th>Completed Date</th>
                                        <td>
                                            <input type="text" class="form-control flat-date" name="completed_date"
                                                placeholder="Select completed date">

                                        </td>

                                        <th>Free Service</th>
                                        <td>
                                            <textarea class="form-control" name="free_service" rows="2"
                                                placeholder="Describe free services included"></textarea>

                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Notes</th>
                                        <td colspan="3">
                                            <textarea class="form-control" name="notes" rows="3"
                                                placeholder="Add any notes for this project"></textarea>
                                        </td>
                                    </tr>

                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Save Project</button>
                    </div>
                </form>

            </div>
        </div>
    </div>




    <!-- Project Details Modal -->
    <div class="modal fade" id="projectDetailsModal" tabindex="-1" aria-labelledby="projectDetailsModalLabel"
        aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header table-primary text-white">
                    <h5 class="modal-title" id="projectDetailsModalLabel">
                        <i class="bx bx-folder-open"></i>
                        <span id="pd-header-project-name" class="fw-bold text-primary text-uppercase"></span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body px-4 py-3">
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped align-middle">
                            <tbody>

                                <!-- ðŸ”µ Quotation Details -->
                                <tr class="table-light">
                                    <td colspan="4"><i class="bx bx-file me-1 text-primary"></i>Quotation Details</td>
                                </tr>
                                <tr>
                                    <th>Quotation</th>
                                    <td id="pd-quotation-reference" colspan="3"></td>
                                </tr>
                                <tr>
                                    <th>Client Name</th>
                                    <td id="pd-client-name" colspan="3"></td>
                                </tr>
                                <tr>
                                    <th>Inquiry Date</th>
                                    <td id="pd-inquiry-date"></td>
                                    <th>Lead Source</th>
                                    <td id="pd-lead-source"></td>
                                </tr>
                                <tr>
                                    <th>Quotation Sent?</th>
                                    <td id="pd-quotation-sent"></td>
                                    <th>Demo Given</th>
                                    <td id="pd-demo"></td>
                                </tr>
                                <tr>
                                    <th>Quotation Amount</th>
                                    <td id="pd-quotation-amount"></td>
                                    <th>Approval Amount</th>
                                    <td id="pd-approval-amount"></td>
                                </tr>
                                <tr>
                                    <th>Client Industry</th>
                                    <td id="pd-client-industry"></td>
                                    <th>Contract Signed?</th>
                                    <td id="pd-contract-signed"></td>
                                </tr>

                                <!-- ðŸŸ¢ Project Details -->
                                <tr class="table-light">
                                    <td colspan="4"><i class="bx bx-folder-open me-1 text-success"></i>Project Details
                                    </td>
                                </tr>
                                <tr>
                                    <th>Project ID</th>
                                    <td id="pd-project-id"></td>
                                    <th>Project Name</th>
                                    <td id="pd-project-name"></td>
                                </tr>
                                <tr>
                                    <th>Project Type</th>
                                    <td id="pd-project-type"></td>
                                    <th>Status</th>
                                    <td id="pd-status"></td>
                                </tr>
                                <tr>
                                    <th>Start Date</th>
                                    <td id="pd-start-date"></td>
                                    <th>Deadline</th>
                                    <td id="pd-deadline"></td>
                                </tr>
                                <tr>
                                    <th>Completed Date</th>
                                    <td id="pd-completed-date"></td>
                                    <th>Team Members</th>
                                    <td id="pd-team-members"></td>
                                </tr>
                                <tr>
                                    <th>Technologies</th>
                                    <td id="pd-technologies" colspan="3"></td>
                                </tr>
                                <tr>
                                    <th>App Mode</th>
                                    <td id="pd-app-mode"></td>
                                    <th>Payment Status</th>
                                    <td id="pd-payment-status"></td>
                                </tr>

                                <!-- ðŸ’¸ Financials -->
                                <tr class="table-light">
                                    <td colspan="4"><i class="bx bx-dollar-circle me-1 text-danger"></i>Expense & Income
                                    </td>
                                </tr>
                                <tr>
                                    <th>Other Expense</th>
                                    <td id="pd-other-expense"></td>
                                    <th>Developer Charge</th>
                                    <td id="pd-developer-charge"></td>
                                </tr>
                                <tr>
                                    <th>Server Charge</th>
                                    <td id="pd-server-charge"></td>
                                    <th>3rd Party API Charge</th>
                                    <td id="pd-third-party-charge"></td>
                                </tr>
                                <tr>
                                    <th>Mediator Charge</th>
                                    <td id="pd-mediator-charge"></td>
                                    <th>Domain Charge</th>
                                    <td id="pd-domain-charge"></td>
                                </tr>
                                <tr>
                                    <th>Total Income</th>
                                    <td id="pd-total-income"></td>
                                    <th>Total Expense</th>
                                    <td id="pd-total-expense"></td>
                                </tr>
                                <tr>
                                    <th>Free Service</th>
                                    <td id="pd-free-service" colspan="3"></td>

                                </tr>
                                <!-- ðŸ”— Links -->
                                <tr class="table-light">
                                    <td colspan="4"><i class="bx bx-link-alt me-1 text-warning"></i>Project Links</td>
                                </tr>
                                <tr>
                                    <th>Live Link</th>
                                    <td id="pd-live-link" colspan="3"></td>
                                </tr>
                                <tr>
                                    <th>Postman Collection</th>
                                    <td id="pd-postman-collection" colspan="3"></td>
                                </tr>
                                <tr>
                                    <th>Data Folder</th>
                                    <td id="pd-data-folder" colspan="3"></td>
                                </tr>
                                <tr>
                                    <th>Other Link</th>
                                    <td id="pd-other-link" colspan="3"></td>
                                </tr>
                                <tr>
                                    <th>Frontend Link</th>
                                    <td id="pd-frontend-link" colspan="3"></td>
                                </tr>
                                <tr>
                                    <th>backend Link</th>
                                    <td id="pd-backend-link" colspan="3"></td>

                                </tr>
                                <tr>
                                    <th>Notes</th>
                                    <td id="pd-notes" colspan="3"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Edit Project Modal -->
    <div class="modal fade" id="editProjectModal" tabindex="-1" aria-labelledby="editProjectModalLabel"
        aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header table-primary text-white">
                    <h5 class="modal-title" id="editProjectModalLabel">
                        <i class="bx bx-edit me-2"></i> Edit Project
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>

                <form id="editProjectForm" method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="project_id" id="edit-project-id">

                    <div class="modal-body px-4 py-3" style="max-height: 70vh; overflow-y: auto;">
                        <div class="table-responsive">
                            <table class="table table-bordered align-middle">
                                <tbody>

                                    <!-- ==================== Quotation Details ==================== -->
                                    <tr class="table-light">
                                        <th colspan="4"><i class="bx bx-file me-2"></i> Quotation Details</th>
                                    </tr>

                                    <tr>
                                        <th>Quotation</th>
                                        <td colspan="3">
                                            <select class="form-control tom-select" name="quotation" id="edit-quotation">
                                                <option value="">-- Select Quotation --</option>
                                                {% for q in quotations %}
                                                <option value="{{ q.id }}">{{ q.quotation_no }} - {{ q.client_name }}
                                                </option>
                                                {% endfor %}
                                            </select>

                                        </td>
                                    </tr>

                                    <tr>
                                        <th>Inquiry Date</th>
                                        <td><input type="text" class="form-control flat-date" name="inquiry_date"
                                                id="edit-inquiry-date" placeholder="Select inquiry date"></td>
                                        <th>Lead Source</th>
                                        <td><input type="text" class="form-control" name="lead_source"
                                                id="edit-lead-source" placeholder="Enter lead source"></td>
                                    </tr>

                                    <tr>
                                        <th>Quotation Sent</th>
                                        <td>
                                            <select class="form-select" name="quotation_sent" id="edit-quotation-sent">
                                                <option value="">-- Select --</option>
                                                <option value="Yes">Yes</option>
                                                <option value="No">No</option>
                                            </select>
                                        </td>
                                        <th>Demo Given</th>
                                        <td>
                                            <select class="form-select" name="demo_given" id="edit-demo-given">
                                                <option value="">-- Select --</option>
                                                <option value="Yes">Yes</option>
                                                <option value="No">No</option>
                                            </select>
                                        </td>
                                    </tr>

                                    <tr>
                                        <th>Quotation Amount (â‚¹)</th>
                                        <td><input type="number" step="0.01" class="form-control"
                                                name="quotation_amount" id="edit-quotation-amount"
                                                placeholder="Enter quotation amount"></td>
                                        <th>Approval Amount (â‚¹)</th>
                                        <td><input type="number" step="0.01" class="form-control" name="approval_amount"
                                                id="edit-approval-amount" placeholder="Enter approval amount"></td>
                                    </tr>

                                    <tr>
                                        <th>Client Industry</th>
                                        <td><input type="text" class="form-control" name="client_industry"
                                                id="edit-client-industry" placeholder="Enter client industry"></td>
                                        <th>Client</th>
                                        <td><input type="text" class="form-control" name="client_name"
                                                id="edit-client-name" placeholder="Enter client name"></td>
                                    </tr>

                                    <tr>
                                        <th>Contract Signed</th>
                                        <td colspan="3">
                                            <select class="form-select" name="contract_signed"
                                                id="edit-contract-signed">
                                                <option value="">-- Select --</option>
                                                <option value="Yes">Yes</option>
                                                <option value="No">No</option>
                                            </select>
                                        </td>
                                    </tr>

                                    <!-- ==================== Project Details ==================== -->
                                    <tr class="table-light">
                                        <th colspan="4"><i class="bx bx-briefcase me-2"></i> Project Details</th>
                                    </tr>

                                    <tr>
                                        <th>Project Name</th>
                                        <td><input type="text" class="form-control" name="project_name"
                                                id="edit-project-name" placeholder="Enter project name"></td>
                                        <th>Project Type</th>
                                        <td>
                                            <select class="form-select" name="project_type" id="edit-project-type">
                                                <option value="">-- Select Project Type --</option>
                                                <option value="Hourly">Hourly</option>
                                                <option value="Fixed">Fix</option>
                                                <option value="Salary">Salary</option>
                                            </select>
                                        </td>
                                    </tr>

                                    <tr>
                                        <th>Start Date</th>
                                        <td><input type="text" class="form-control flat-date" name="start_date"
                                                id="edit-start-date" placeholder="Select start date"></td>
                                        <th>Deadline</th>
                                        <td><input type="text" class="form-control flat-date" name="deadline"
                                                id="edit-deadline" placeholder="Select deadline"></td>
                                    </tr>

                                    <tr>
                                        <th>Technologies</th>
                                        <td>
                                            <select class="form-control tom-select" name="technologies" id="edit-technologies"
                                                multiple>

                                                {% for tech in technologies %}
                                                <option value="{{ tech.id }}">{{ tech.name }}</option>
                                                {% endfor %}
                                            </select>
                                            <small class="text-muted">Hold CTRL or CMD to select multiple</small>
                                        </td>
                                        <th>App Mode</th>
                                        <td>

                                            <select class="form-control tom-select" name="app_mode" id="edit-app-mode" multiple>

                                                {% for mode in app_modes %}
                                                <option value="{{ mode.id }}">{{ mode.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </td>
                                    </tr>

                                    <tr>
                                        <th>Status</th>
                                        <td>
                                            <select class="form-select" name="status" id="edit-status">
                                                <option value="">-- Select --</option>
                                                <option value="In Progress">In Progress</option>
                                                <option value="Completed">Completed</option>
                                                <option value="On Hold">On Hold</option>
                                                <option value="Cancelled">Cancelled</option>
                                            </select>
                                        </td>
                                        <th>Team Members</th>
                                        <td>
                                            <select class="form-control tom-select" name="team_members" id="edit-team-members"
                                                multiple>
                                                {% for user in users %}
                                                <option value="{{ user.id }}">{{ user.first_name }} {{ user.last_name }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                        </td>
                                    </tr>

                                    <!-- Payment -->
                                    <tr>
                                        <th>Payment (â‚¹)</th>
                                        <td><input type="number" class="form-control" name="payment_value"
                                                id="edit-payment-value" placeholder="Enter payment amount" readonly>
                                        </td>
                                        <th>Payment Status</th>
                                        <td>
                                            <select class="form-select" name="payment_status" id="edit-payment-status">
                                                <option value="">-- Select Payment Status --</option>
                                                <option value="Pending">Pending</option>
                                                <option value="Advanced">Advanced</option>
                                                <option value="Paid">Received</option>
                                            </select>
                                        </td>
                                    </tr>
                                    <!-- Links -->
                                    <tr>
                                        <th>Live Link</th>
                                        <td><input type="url" class="form-control" name="live_link" id="edit-live-link"
                                                placeholder="Enter live link URL"></td>
                                        <th>Postman Collection</th>
                                        <td><input type="url" class="form-control" name="postman_collection"
                                                id="edit-postman-collection" placeholder="Enter Postman collection URL">
                                        </td>
                                    </tr>

                                    <tr>
                                        <th>Data Folder</th>
                                        <td><input type="url" class="form-control" name="data_folder"
                                                id="edit-data-folder" placeholder="Enter data folder URL"></td>
                                        <th>Other Link</th>
                                        <td><input type="url" class="form-control" name="other_link"
                                                id="edit-other-link" placeholder="Enter other link"></td>
                                    </tr>
                                    <tr>
                                        <th>Frontend Link</th>
                                        <td><input type="url" class="form-control" name="frontend_link"
                                                id="edit-frontend-link" placeholder="Enter frontend link"></td>
                                        <th>Backend Link</th>
                                        <td><input type="url" class="form-control" name="backend_link"
                                                id="edit-backend-link" placeholder="Enter backend link"></td>
                                    </tr>
                                    <!-- Financials -->
                                    <tr>
                                        <th>Other Expense (â‚¹)</th>
                                        <td><input type="number" class="form-control" name="other_expense"
                                                id="edit-other-expense" placeholder="Enter expense"></td>
                                        <th>Developer Charge (â‚¹)</th>
                                        <td><input type="number" class="form-control" name="developer_charge"
                                                id="edit-developer-charge" placeholder="Enter developer charge"></td>
                                    </tr>
                                    <tr>
                                        <th>Server Charge (â‚¹)</th>
                                        <td><input type="number" class="form-control" name="server_charge"
                                                id="edit-server-charge" placeholder="Enter server charge"></td>
                                        <th>3rd Party API Charge (â‚¹)</th>
                                        <td><input type="number" class="form-control" name="third_party_api_charge"
                                                id="edit-third-party-charge" placeholder="Enter API charge"></td>
                                    </tr>
                                    <tr>
                                        <th>Mediator Charge (â‚¹)</th>
                                        <td><input type="number" class="form-control" name="mediator_charge"
                                                id="edit-mediator-charge" placeholder="Enter mediator charge"></td>
                                        <th>Domain Charge (â‚¹)</th>
                                        <td><input type="number"  class="form-control" name="domain_charge"
                                                id="edit-domain-charge" placeholder="Enter domain charge"></td>
                                    </tr>
                                    <!-- Completion and Free Service -->
                                    <tr>
                                        <th>Completed Date</th>
                                        <td><input type="text" class="form-control flat-date" name="completed_date"
                                                id="edit-completed-date" placeholder="Select completed date"></td>
                                        <th>Free Service</th>
                                        <td><textarea class="form-control" name="free_service" id="edit-free-service"
                                                rows="2" placeholder="Describe free services if any"></textarea></td>
                                    </tr>


                                    <!-- notes -->
                                    <tr>


                                        <th>Notes</th>
                                        <td colspan="3"><textarea class="form-control" name="notes" rows="3"
                                                id="edit-notes" placeholder="Add any notes for this project"></textarea>

                                    </tr>

                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Update Project</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmLabel"
        aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content text-center">
                <div class="modal-header border-0">
                    <h5 class="modal-title w-100" id="deleteConfirmLabel">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this project?
                </div>
                <div class="modal-footer justify-content-center border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- display user data -->
    <div class="modal fade" id="viewUserModal" tabindex="-1" aria-labelledby="viewUserModalLabel" aria-hidden="true"
        data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header table-info text-white">
                    <h5 class="modal-title" id="viewUserModalLabel">
                        <i class="bx bx-user me-2"></i> User Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>

                <div class="modal-body px-4 py-3" style="max-height: 70vh; overflow-y: auto;">
                    <div class="table-responsive">
                        <table class="table table-bordered align-middle">
                            <tbody>
                                <tr>
                                    <th>Username</th>
                                    <td id="view-username" colspan="3"></td>
                                </tr>
                                <tr>
                                    <th>First Name</th>
                                    <td id="view-firstname"></td>
                                    <th>Last Name</th>
                                    <td id="view-lastname"></td>
                                </tr>
                                <tr>
                                    <th>Email</th>
                                    <td id="view-email"></td>
                                    <th>Phone</th>
                                    <td id="view-phone"></td>
                                </tr>
                                <tr>
                                    <th>Designation</th>
                                    <td id="view-designation"></td>
                                    <th>Status</th>
                                    <td id="view-status"></td>
                                </tr>
                                <tr>
                                    <th>Projects</th>
                                    <td colspan="3">
                                        <ul id="view-projects" class="mb-0"></ul>
                                    </td>
                                </tr>
                                <tr>
                                    <th>Profile Picture</th>
                                    <td colspan="3" id="view-profile-picture"></td>
                                </tr>
                            </tbody>
                        </table>

                    </div>
                </div>


            </div>
        </div>
    </div>

</div>
{% block extra_js %}



<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="{% static 'js/common.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>


<script>
    document.addEventListener("DOMContentLoaded", function () {
            document.querySelectorAll(".tom-select").forEach(function(el) {
                new TomSelect(el, {
                    create: false,
                     plugins: ['remove_button'], // add X remove button
                    sortField: {
                        field: "text",
                        direction: "asc"
                    }
                });
                
    });
  
        // searhing
        enableTableSearch("searchBox", "projectTable");
        // sorting

        enableTableSorting("projectTable");

        // Function to handle form submission via AJAX
        function handleProjectFormSubmit(form) {
            form.addEventListener("submit", function (e) {
                e.preventDefault();
                let formData = new FormData(form);

                fetch(form.action, {
                    method: "POST",
                    body: formData,
                    headers: {
                        "X-Requested-With": "XMLHttpRequest",
                        "X-CSRFToken": form.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                    .then(res => res.json())
                    .then(data => {
                        // Clear old errors
                        form.querySelectorAll(".is-invalid").forEach(el => el.classList.remove("is-invalid"));

                        if (data.success) {
                            // Close modal
                            let modalEl = document.getElementById("addProjectModal");
                            let modal = bootstrap.Modal.getInstance(modalEl);
                            modal.hide();

                            // Show success toast
                            showToast(data.message, "success");

                            // Refresh after short delay
                            setTimeout(() => window.location.reload(), 800);
                        } else {
                            // Show validation errors
                            if (data.errors["__all__"]) {
                                showToast(data.errors["__all__"].join(", "), "danger");
                            } else {
                                for (let field in data.errors) {
                                    let input = form.querySelector(`[name="${field}"]`);
                                    if (input) input.classList.add("is-invalid");
                                }
                            }
                        }
                    })
                    .catch(err => console.error("Error:", err));
            });
        }

        // Attach listener when modal is shown
        let addProjectModalEl = document.getElementById("addProjectModal");
        addProjectModalEl.addEventListener('shown.bs.modal', function () {
            let form = document.getElementById("projectForm");
            // Avoid attaching multiple times
            if (!form.dataset.listenerAttached) {
                handleProjectFormSubmit(form);
                form.dataset.listenerAttached = "true";
            }
        });
        function makeSelectReadonly(select) {
            ["mousedown", "keydown", "wheel"].forEach(evt => {
                select.addEventListener(evt, e => e.preventDefault());
            });
            select.classList.add("readonly"); // apply the style
        }

        // Auto-fill when quotation is selected
        document.getElementById('quotationSelect').addEventListener('change', function () {
    let quotationId = this.value;

    // Get input references
    let leadInput = document.querySelector('input[name="lead_source"]');
    let quotationInput = document.querySelector('input[name="quotation_amount"]');
    let inquiryInput = document.querySelector('input[name="inquiry_date"]');
    let quotationSelect = document.querySelector('select[name="quotation_sent"]');
    let demoGiven = document.querySelector('select[name="demo_given"]');
    let clientName = document.querySelector('input[name="client_name"]');
    let contractSigned = document.querySelector('select[name="contract_signed"]');

    if (!quotationId) {
        // If quotation deselected â†’ reset values & enable inputs
        leadInput.value = '';
        leadInput.readOnly = false;

        quotationInput.value = '';
        quotationInput.readOnly = false;

        inquiryInput.value = '';
        if (inquiryInput._flatpickr) {
            inquiryInput._flatpickr.clear();
            inquiryInput._flatpickr.input.disabled = false;
            inquiryInput._flatpickr.altInput.disabled = false;
        } else {
            inquiryInput.disabled = false;
        }

        quotationSelect.value = '';
        quotationSelect.disabled = false;

        demoGiven.value = '';
        demoGiven.disabled = false;

        clientName.value = '';
        clientName.disabled = false;

        contractSigned.value = '';
        contractSigned.disabled = false;

        return;
    }

    // Fetch quotation data
    fetch(`/get_quotation/?id=${quotationId}`)
        .then(res => res.json())
        .then(data => {
            // Inquiry Date
            if (data.date) {
                let d = new Date(data.date);
                if (inquiryInput._flatpickr) {
                    inquiryInput._flatpickr.setDate(d, true);
                    inquiryInput._flatpickr.input.disabled = true;
                    inquiryInput._flatpickr.altInput.disabled = true;
                } else {
                    let month = (d.getMonth() + 1).toString().padStart(2, '0');
                    let day = d.getDate().toString().padStart(2, '0');
                    inquiryInput.value = `${d.getFullYear()}-${month}-${day}`;
                    inquiryInput.disabled = true;
                }
            } else {
                inquiryInput.value = '';
                if (inquiryInput._flatpickr) {
                    inquiryInput._flatpickr.clear();
                    inquiryInput._flatpickr.input.disabled = false;
                    inquiryInput._flatpickr.altInput.disabled = false;
                } else {
                    inquiryInput.disabled = false;
                }
            }

            // Lead Source
            leadInput.value = data.lead_source || '';
            leadInput.readOnly = !!data.lead_source;

            // Quotation Sent
            quotationSelect.value = data.quotation_sent ? data.quotation_sent : 'Yes';
            quotationSelect.disabled = false;


            // Demo Given
            demoGiven.value = data.demo_given ? data.demo_given : 'Yes';
            demoGiven.disabled = false;

            // Quotation Amount
            quotationInput.value = data.grand_total || '';
            quotationInput.readOnly = !!data.grand_total;

            // Client Name
            clientName.value = data.client_name || '';
            clientName.readOnly = !!data.client_name;

            // Contract Signed
            contractSigned.value = data.contract_signed ? data.contract_signed : 'Yes';
            contractSigned.disabled = false;
            
            // You can prefill Approval Amount if needed, but keep editable
            // let approvalAmountInput = document.querySelector('input[name="approval_amount"]');
            // approvalAmountInput.value = data.approval_amount || '';
            // approvalAmountInput.readOnly = !!data.approval_amount;
        })
        .catch(err => {
            console.error('Failed to fetch quotation data:', err);
            // If fetch fails, allow manual entry
            leadInput.readOnly = false;
            quotationInput.readOnly = false;
            inquiryInput.disabled = false;
            quotationSelect.disabled = false;
            demoGiven.disabled = false;
            clientName.disabled = false;
            contractSigned.disabled = false;
        });
});



        // View modal fill
        // Use Django's URL tag so the path is generated correctly

        const projectDetailsUrl = "{% url 'get_project_details' %}";
        $(document).on("click", ".project-link", function (e) {
            e.preventDefault();
            const projectId = $(this).data("project-id");

            $.get(projectDetailsUrl, { id: projectId, mode: "view" }, function (res) {
                if (!res.success) {
                    console.error("Failed to fetch project:", res.error);
                    return;
                }
                const p = res.project;
                $("#pd-header-project-name").text(p.project_name);
                $("#pd-project-id").text(p.project_id);
                $("#pd-inquiry-date").text(formatDate(p.inquiry_date));

                $("#pd-project-name").text(p.project_name);
                $('#pd-project-type').text(p.project_type);
                $("#pd-technologies").text(p.technologies.join(", ") || "-");
                $("#pd-app-mode").text((p.app_modes_names || []).join(", ") || "-");

                $("#pd-lead-source").text(p.lead_source);
                // Status Badge (same as Django template)
                let statusBadge = '';
                if (p.status === "In Progress") {
                    statusBadge = `<span class="badge bg-label-warning">${p.status}</span>`;
                } else if (p.status === "Completed") {
                    statusBadge = `<span class="badge bg-label-success">${p.status}</span>`;
                } else if (p.status === "On Hold") {
                    statusBadge = `<span class="badge bg-label-primary">${p.status}</span>`;
                } else if (p.status === "Cancelled") {
                    statusBadge = `<span class="badge bg-label-danger">${p.status}</span>`;
                } else {
                    statusBadge = `<span class="badge bg-label-secondary">${p.status}</span>`;
                }
                $("#pd-status").html(statusBadge);

                // Quotation Sent
                let quotationBadge = p.quotation_sent === "Yes"
                    ? `<span class="badge bg-label-success">${p.quotation_sent}</span>`
                    : `<span class="badge bg-label-danger">${p.quotation_sent}</span>`;
                $("#pd-quotation-sent").html(quotationBadge);

                // Demo Given
                let demoBadge = p.demo_given === "Yes"
                    ? `<span class="badge bg-label-success">${p.demo_given}</span>`
                    : `<span class="badge bg-label-danger">${p.demo_given}</span>`;
                $("#pd-demo").html(demoBadge);

                // Contract Signed
                let contractBadge = p.contract_signed === "Yes"
                    ? `<span class="badge bg-label-success">${p.contract_signed}</span>`
                    : `<span class="badge bg-label-danger">${p.contract_signed}</span>`;
                $("#pd-contract-signed").html(contractBadge);


                // Team members list (display)
                let tmHtml = "";
                (p.team_members_display || []).forEach(m => {
                    tmHtml += `<div>${m.name}</div>`;
                });
                $("#pd-team-members").html(tmHtml);
                $("#pd-quotation-amount").text(p.quotation_amount ? `â‚¹${p.quotation_amount}` : "-");
                $("#pd-quotation-reference").text(
                    p.quotation ? `${p.quotation} (${p.client_name})` : "-"
                );
                 $("#pd-client-name").text(p.c_name);
                $("#pd-approval-amount").text(p.approval_amount ? `â‚¹${p.approval_amount}` : "-");
                $("#pd-deadline").text(formatDate(p.deadline));
                $("#pd-completed-date").text(formatDate(p.completed_date));
                let statusClass = '';
                if (p.payment_status === 'Pending') {
                    statusClass = 'badge bg-warning';
                } else if (p.payment_status === 'Advanced') {
                    statusClass = 'badge bg-info';
                } else if (p.payment_status === 'Paid') {
                    statusClass = 'badge bg-success';
                } else {
                    statusClass = 'badge bg-secondary';
                }

                let paymentBadge = '';
                let paymentText = p.payment_status;

                if (p.payment_status === "Pending") {
                    paymentBadge = "badge bg-label-warning";
                } else if (p.payment_status === "Advanced") {
                    paymentBadge = "badge bg-label-info";
                } else if (p.payment_status === "Paid") {
                    paymentBadge = "badge bg-label-success";
                    paymentText = "Received";   // âœ… show "Received" instead of "Paid"
                } else {
                    paymentBadge = "badge bg-label-secondary";
                }

                $("#pd-payment-status").html(
                    `<span class="${paymentBadge}">${p.payment_value} ${paymentText}</span>`
                );


                $("#pd-client-industry").text(p.client_industry);
               
                if (p.live_link) {
                    $("#pd-live-link").html(`<a href="${p.live_link}" target="_blank">${p.live_link}</a>`);
                } else {
                    $("#pd-live-link").text("");
                }
                $("#pd-other-expense").text(p.other_expense ? `â‚¹${p.other_expense}` : "-");
                $("#pd-developer-charge").text(p.developer_charge ? `â‚¹${p.developer_charge}` : "-");
                $("#pd-server-charge").text(p.server_charge ? `â‚¹${p.server_charge}` : "-");
                $("#pd-domain-charge").text(p.domain_charge ? `â‚¹${p.domain_charge}` : "-");
                $("#pd-third-party-charge").text(p.third_party_api_charge ? `â‚¹${p.third_party_api_charge}` : "-");
                $("#pd-mediator-charge").text(p.mediator_charge ? `â‚¹${p.mediator_charge}` : "-");
                // $("#pd-income").text(p.income ? `â‚¹${p.income}` : "-");
                $("#pd-free-service").text(p.free_service);
                if (p.postman_collection) {
                    $("#pd-postman-collection").html(`<a href="${p.postman_collection}" target="_blank">${p.postman_collection}</a>`);
                } else {
                    $("#pd-postman-collection").text("");
                }
                if (p.data_folder) {
                    $("#pd-data-folder").html(`<a href="${p.data_folder}" target="_blank">${p.data_folder}</a>`);
                } else {
                    $("#pd-data-folder").text("");
                }

                if (p.other_link) {
                    $("#pd-other-link").html(`<a href="${p.other_link}" target="_blank">${p.other_link}</a>`);
                } else {
                    $("#pd-other-link").text("");
                }
                if (p.frontend_link) {
                    $("#pd-frontend-link").html(`<a href="${p.frontend_link}" target="_blank">${p.frontend_link}</a>`);
                } else {
                    $("#pd-frontend-link").text("");
                }
                if (p.backend_link) {
                    $("#pd-backend-link").html(`<a href="${p.backend_link}" target="_blank">${p.backend_link}</a>`);
                } else {
                    $("#pd-backend-link").text("");
                }
                $("#pd-notes").text(p.notes);
                $("#pd-start-date").text(formatDate(p.start_date));



                $("#projectDetailsModal").modal("show");
            });

            $.get("{% url 'get_project_p_l_detail' %}", { id: projectId }, function (res) {
                if (res.success) {
                    const d = res.data;
                    $("#pd-total-income").addClass("text-success").text(`â‚¹${d.total_paid}`);
                    $("#pd-total-expense").addClass("text-danger").text(`â‚¹${d.total_expense}`);
                }
            });

        });


        // view user modal

        const modalEl = document.getElementById("viewUserModal");
        const viewUserModal = new bootstrap.Modal(modalEl);
        document.querySelectorAll(".view-user").forEach(btn => {
            btn.addEventListener("click", function (e) {
                e.preventDefault();
                const userId = this.dataset.userId;

                fetch(`/get_user/${userId}/`, {
                    headers: { "X-Requested-With": "XMLHttpRequest" }
                })
                    .then(res => res.json())
                    .then(data => {
                        // Fill table fields
                        document.getElementById("view-firstname").textContent = data.first_name;
                        document.getElementById("view-lastname").textContent = data.last_name;
                        document.getElementById("view-username").textContent = data.username;
                        document.getElementById("view-email").textContent = data.email;
                        document.getElementById("view-phone").textContent = data.phone || "-";
                        document.getElementById("view-designation").textContent = data.designation || "-";
                        document.getElementById("view-status").innerHTML = data.is_active
                            ? `<span class="badge bg-label-success">Active</span>`
                            : `<span class="badge bg-label-danger">Inactive</span>`;


                        // Projects list
                        let projectList = document.getElementById("view-projects");
                        projectList.innerHTML = "";
                        if (data.projects && data.projects.length) {
                            data.projects.forEach(p => {
                                let li = document.createElement("li");
                                li.textContent = p;
                                projectList.appendChild(li);
                            });
                        } else {
                            projectList.innerHTML = "<li>No projects assigned</li>";
                        }

                        // Profile picture
                        document.getElementById("view-profile-picture").innerHTML = data.profile_picture_url
                            ? `<a href="${data.profile_picture_url}" target="_blank">
         <img src="${data.profile_picture_url}" class="img-thumbnail rounded" style="max-width:80px; max-height:80px;">
       </a>`
                            : "No picture";





                        // Show modal
                        // show with existing instance
                        viewUserModal.show();
                    })
                    .catch(() => showToast("Error loading user details", "danger"));
            });
        });

        // Edit modal fill
        $(document).on("click", ".edit-project", function (e) {
            e.preventDefault();
            const projectId = $(this).data("project-id");

            $.get(projectDetailsUrl, { id: projectId, mode: "edit" }, function (res) {
                if (!res.success) {
                    console.error("Failed to fetch project for edit:", res.error);
                    return;
                }
                const p = res.project;

                // Set form action to numeric id URL (update_project/<int:id>/)
                $("#editProjectForm").attr("action", `/update_project/${p.id}/`);
                // Quotation
                // $("#edit-quotation").val(p.quotation_id ? p.quotation_id.toString() : "");
                document.getElementById("edit-quotation").tomselect.setValue(p.quotation_id ? p.quotation_id.toString() : "");


                // set hidden ID field
                $("#edit-project-id").val(p.id);
                // populate fields in edit modal
                $("#edit-project-name").val(p.project_name);
                $("#edit-project-type").val(p.project_type);
                if (p.start_date) $("#edit-start-date")[0]._flatpickr.setDate(p.start_date, true);
                if (p.deadline) $("#edit-deadline")[0]._flatpickr.setDate(p.deadline, true);
                $("#edit-status").val(p.status);


                $("#edit-payment-value").val(p.payment_value);
                $("#edit-payment-status").val(p.payment_status);
                $("#edit-live-link").val(p.live_link);
                $("#edit-postman-collection").val(p.postman_collection);
                $("#edit-data-folder").val(p.data_folder);
                $("#edit-other-link").val(p.other_link);
                $("#edit-frontend-link").val(p.frontend_link);
                $("#edit-backend-link").val(p.backend_link);
                $("#edit-other-expense").val(p.other_expense);
                $("#edit-developer-charge").val(p.developer_charge);
                $("#edit-server-charge").val(p.server_charge);
                $("#edit-domain-charge").val(p.domain_charge);
                $("#edit-third-party-charge").val(p.third_party_api_charge);
                $("#edit-mediator-charge").val(p.mediator_charge);
                // $("#edit-income").val(p.income);

                $("#edit-free-service").val(p.free_service);
                if (p.inquiry_date) $("#edit-inquiry-date")[0]._flatpickr.setDate(p.inquiry_date, true);
                $("#edit-lead-source").val(p.lead_source);
                $("#edit-quotation-sent").val(p.quotation_sent);
                $("#edit-demo-given").val(p.demo_given);
                $("#edit-quotation-amount").val(p.quotation_amount);
                $("#edit-approval-amount").val(p.approval_amount);
                if (p.completed_date) $("#edit-completed-date")[0]._flatpickr.setDate(p.completed_date, true);
                $("#edit-client-industry").val(p.client_industry);
                $("#edit-notes").val(p.notes);
                $("#edit-contract-signed").val(p.contract_signed);
                $("#edit-client-name").val(p.c_name);
                // For multi-select team members use the numeric ids returned
                // $("#edit-team-members").val(p.team_members_ids || []);
                // $("#edit-technologies").val(p.technologies_ids);
                // $("#edit-technologies").val(p.technologies_ids.map(id => id.toString()));
                document.getElementById("edit-technologies").tomselect.setValue(p.technologies_ids.map(id => id.toString()));
                // $("#edit-team-members").val(p.team_members_ids.map(id => id.toString()));
                document.getElementById("edit-team-members").tomselect.setValue(p.team_members_ids.map(id => id.toString()));
                // App Mode
                // $("#edit-app-mode").val(p.app_modes_ids.map(id => id.toString()));
                document.getElementById("edit-app-mode").tomselect.setValue(p.app_modes_ids.map(id => id.toString()));
                // If project has a quotation â†’ lock quotation fields
                if (p.quotation_id) {
                    if ($("#edit-inquiry-date")[0]._flatpickr) {
                        let fp = $("#edit-inquiry-date")[0]._flatpickr;
                        fp.set('clickOpens', false);              // prevent calendar popup
                        fp.input.readOnly = true;                 // hidden input
                        if (fp.altInput) fp.altInput.readOnly = true; // visible input
                    } else {
                        $("#edit-inquiry-date").prop("readonly", true);
                    }

                    $("#edit-lead-source").prop("readonly", true);
                    $("#edit-quotation-sent").prop("disabled", true);
                    $("#edit-demo-given").prop("disabled", true);
                    $("#edit-quotation-amount").prop("readonly", true);

                    $("#edit-contract-signed").prop("disabled", true);
                    $("#edit-client-name").prop("readonly", true);
                } else {
                    // unlock if no quotation
                    if ($("#edit-inquiry-date")[0]._flatpickr) {
                        let fp = $("#edit-inquiry-date")[0]._flatpickr;
                        fp.set('clickOpens', true);
                        fp.input.readOnly = false;
                        if (fp.altInput) fp.altInput.readOnly = false;
                    } else {
                        $("#edit-inquiry-date").prop("readonly", false);
                    }

                    $("#edit-lead-source").prop("readonly", false);
                    $("#edit-quotation-sent").prop("disabled", false);
                    $("#edit-demo-given").prop("disabled", false);
                    $("#edit-quotation-amount").prop("readonly", false);

                    $("#edit-contract-signed").prop("disabled", false);
                    $("#edit-client-name").prop("readonly", false);
                }

                $("#editProjectModal").modal("show");
            });
        });

        document.getElementById("editProjectForm").addEventListener("submit", function (e) {
            e.preventDefault();
            let form = this;
            let formData = new FormData(form);
            let projectId = document.getElementById("edit-project-id").value;

            if (!projectId) {
                showToast("Project ID missing!", "danger");
                return;
            }

            fetch(`/update_project/${projectId}/`, {
                method: "POST",
                body: formData,
                headers: {
                    "X-Requested-With": "XMLHttpRequest",
                    "X-CSRFToken": form.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
                .then(res => res.json())
                .then(data => {
                    // Clear old validation errors
                    form.querySelectorAll(".is-invalid").forEach(el => el.classList.remove("is-invalid"));


                    if (data.success) {
                        // Close modal
                        let modalEl = document.getElementById("editProjectModal");
                        let modal = bootstrap.Modal.getInstance(modalEl);
                        modal.hide();

                        // Show success toast
                        showToast(data.message, "success");

                        // Refresh after a short delay
                        setTimeout(() => window.location.reload(), 800);
                    } else {


                        if (data.errors["__all__"]) {
                            showToast(data.errors["__all__"].join(", "), "danger");
                        }
                    }
                })
                .catch(err => {
                    console.error("Error:", err);
                    showToast("Unexpected error while updating project.", "danger");
                });
        });

        // Auto-fill when quotation is selected in EDIT modal
        document.getElementById('edit-quotation').addEventListener('change', function () {
            let quotationId = this.value;

            // Get input references (EDIT fields)
            let leadInput = document.getElementById('edit-lead-source');
            let quotationInput = document.getElementById('edit-quotation-amount');

            let inquiryInput = document.getElementById('edit-inquiry-date');
            let quotationSelect = document.getElementById('edit-quotation-sent');
            let demoGiven = document.getElementById('edit-demo-given');
            let clientName = document.getElementById('edit-client-name');
            let contractSigned = document.getElementById('edit-contract-signed');

            if (!quotationId) {
                // Reset values
                leadInput.value = '';
                quotationInput.value = '';

                quotationSelect.value = '';
                demoGiven.value = '';
                clientName.value = '';
                contractSigned.value = '';

                if (inquiryInput._flatpickr) {
                    inquiryInput._flatpickr.clear();
                    inquiryInput._flatpickr.set('clickOpens', true);
                    inquiryInput._flatpickr.input.readOnly = false;
                    if (inquiryInput._flatpickr.altInput) {
                        inquiryInput._flatpickr.altInput.readOnly = false;
                    }
                } else {
                    inquiryInput.value = '';
                    inquiryInput.readOnly = false;
                }

                // Reset readonly/disabled
                leadInput.readOnly = false;
                quotationInput.readOnly = false;

                quotationSelect.disabled = false;
                demoGiven.disabled = false;
                clientName.readOnly = false;
                contractSigned.disabled = false;
                return;
            }

            fetch(`/get_quotation/?id=${quotationId}`)
                .then(res => res.json())
                .then(data => {
                    // Fill values
                    leadInput.value = data.lead_source || '';
                    quotationInput.value = data.grand_total || '';

                    quotationSelect.value = "Yes";
                    demoGiven.value = "Yes";
                    clientName.value = data.client_name || '';
                    contractSigned.value = "Yes";

                    if (data.date) {
                        let d = new Date(data.date);
                        if (inquiryInput._flatpickr) {
                            inquiryInput._flatpickr.setDate(d, true);
                        } else {
                            let month = (d.getMonth() + 1).toString().padStart(2, '0');
                            let day = d.getDate().toString().padStart(2, '0');
                            inquiryInput.value = `${d.getFullYear()}-${month}-${day}`;
                        }
                    } else {
                        if (inquiryInput._flatpickr) {
                            inquiryInput._flatpickr.clear();
                        } else {
                            inquiryInput.value = '';
                        }
                    }

                    // Lock fields (readonly/disabled)
                    leadInput.readOnly = true;
                    quotationInput.readOnly = true;

                    quotationSelect.disabled = true;
                    // demoGiven.addEventListener("mousedown", e => e.preventDefault());
                    // contractSigned.addEventListener("mousedown", e => e.preventDefault());
                    makeSelectReadonly(demoGiven);
                    makeSelectReadonly(contractSigned);

                    clientName.readOnly = true;


                    if (inquiryInput._flatpickr) {
                        inquiryInput._flatpickr.set('clickOpens', false);
                        inquiryInput._flatpickr.input.readOnly = true;
                        if (inquiryInput._flatpickr.altInput) {
                            inquiryInput._flatpickr.altInput.readOnly = true;
                        }
                    } else {
                        inquiryInput.readOnly = true;
                    }
                });
        });

        //delete model
        let projectIdToDelete = null;

        $(document).on("click", ".delete-project", function (e) {
            e.preventDefault();
            projectIdToDelete = $(this).data("id");
            var deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            deleteModal.show();
        });

        $(document).on("click", "#confirmDeleteBtn", function () {
            if (!projectIdToDelete) return;

            $.ajax({
                url: `/delete_project/${projectIdToDelete}/`,
                type: "POST",
                data: {
                    csrfmiddlewaretoken: "{{ csrf_token }}"
                },
                success: function (response) {
                    if (response.success) {
                        showToast(response.message, "success");
                        setTimeout(() => window.location.reload(), 800);
                    } else {
                        showToast(response.message || "Something went wrong.", "danger");
                    }
                },
                error: function () {
                    showToast("Unexpected error while deleting project.", "danger");
                }
            });

            // Hide modal after clicking confirm
            var deleteModalEl = document.getElementById('deleteConfirmModal');
            var deleteModalInstance = bootstrap.Modal.getInstance(deleteModalEl);
            deleteModalInstance.hide();
        });

    });
</script>
{% endblock %}
{% endblock %}
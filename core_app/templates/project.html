{% extends "base.html" %}
{% block title %}All Domains{% endblock %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

{% block extra_css %}
<style>
    .alert-success {
        background-color: #017004 !important;
        /* Green */
        color: black !important;
    }

    /* Example: Custom error background */
    .alert-error,
    .alert-danger {
        background-color: #F44336;
        /* Red */
        color: black;
    }

    /* Example: Custom info background */
    .alert-info {
        background-color: #2196F3;
        /* Blue */
        color: black;
    }

    /* Example: Custom warning background */
    .alert-warning {
        background-color: #FF9800;
        /* Orange */
        color: black;
    }

    .scrollable-table-body {
        max-height: 400px;
        /* Adjust height as needed */
        overflow-y: auto;
    }

    .scrollable-table-body table {
        margin-bottom: 0;
        /* Avoid extra spacing */
    }

    /* Optional: Fix the header */
    .scrollable-table-body thead th {
        position: sticky;
        top: 0;
        background: #fff;
        z-index: 1;
    }
</style>
{% endblock %}

{% block content %}
{% if messages %}
<div id="toast-container" style="
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 3000;  /* above sidebar/navbar */
    display: flex;
    flex-direction: column;
    gap: 10px;
">
    {% for message in messages %}
    <div class="toast align-items-center text-white bg-{{ message.tags }} border-0 show" role="alert"
        aria-live="assertive" aria-atomic="true" style="min-width: 250px;">
        <div class="d-flex">
            <div class="toast-body">
                {{ message }}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                aria-label="Close"></button>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}


<div class="content-wrapper">

    <!-- Content -->
    <div class="container-xxl flex-grow-1 container-p-y">
        <!-- Project Status Cards -->
        <div class="row mb-4">
            <!-- Total Projects -->
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card h-100 shadow-sm border-0">
                    <div class="card-body d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="mb-1">Total Projects</h6>
                            <h4 class="fw-bold">120</h4>
                        </div>
                        <div class="avatar bg-primary text-white rounded-circle p-2">
                            <i class="bx bx-folder-open fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>


            <!-- In Progress -->
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card h-100 shadow-sm border-0">
                    <div class="card-body d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="mb-1">In Progress</h6>
                            <h4 class="fw-bold text-info">35</h4>
                        </div>
                        <div class="avatar bg-info text-white rounded-circle p-2">
                            <i class="bx bx-loader-circle fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Completed -->
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card h-100 shadow-sm border-0">
                    <div class="card-body d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="mb-1">Completed</h6>
                            <h4 class="fw-bold text-success">60</h4>
                        </div>
                        <div class="avatar bg-success text-white rounded-circle p-2">
                            <i class="bx bx-check-circle fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cancelled -->
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card h-100 shadow-sm border-0">
                    <div class="card-body d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="mb-1">Cancelled</h6>
                            <h4 class="fw-bold text-danger">10</h4>
                        </div>
                        <div class="avatar bg-danger text-white rounded-circle p-2">
                            <i class="bx bx-x-circle fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- All Projects Table -->
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="mb-0">All Projects</h4>
                    <div class="d-flex gap-2">
                        <!-- Filter Button -->
                        <button type="button" class="btn btn-outline-secondary" title="Filter Projects">
                            <i class="bx bx-filter-alt"></i>
                        </button>

                        <!-- Add Project Button -->
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                            data-bs-target="#addProjectModal">
                            <i class="bx bx-plus"></i> Add Project
                        </button>
                    </div>
                </div>

                <div class="table-responsive text-nowrap scrollable-table-body">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Sr No.</th>
                                <th>Project ID</th>
                                <th>Start Date</th>
                                <th>Project Name</th>
                                <th>Technologies</th>
                                <th>App Mode</th>

                                <th>Status</th>

                                <th>Deadline</th>
                                <th>Team Members</th>

                                <th>Payment Status</th>


                                <th>Live Links</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody class="table-border-bottom-0">
                            {% for project in page_obj %}

                            <tr>

                                <th>{{ forloop.counter0|add:page_obj.start_index }}</th>
                                <td>{{ project.project_id }}</td>
                                <td>{{ project.start_date }}</td>
                                <td>
                                    <!-- <a href="#" data-bs-toggle="modal" data-bs-target="#projectDetailsModal"
                                        class="text-dark fw-bold project-link">
                                            {{ project.project_name }}
                                        </a> -->
                                    <a href="#" data-bs-toggle="modal" data-bs-target="#projectDetailsModal"
                                        class="fw-bold project-link" data-project-id="{{ project.id }}">
                                        {{ project.project_name }}
                                    </a>

                                </td>
                                <td>{{ project.technologies }}</td>
                                <td>{{ project.app_mode }}</td>
                                <td>
                                    {% if project.status == "Ongoing" %}
                                    <span class="badge bg-label-success">{{ project.status }}</span>
                                    {% elif project.status == "Completed" %}
                                    <span class="badge bg-label-primary">{{ project.status }}</span>
                                    {% elif project.status == "On Hold" %}
                                    <span class="badge bg-label-warning">{{ project.status }}</span>
                                    {% elif project.status == "Cancelled" %}
                                    <span class="badge bg-label-danger">{{ project.status }}</span>
                                    {% else %}
                                    <span class="badge bg-label-secondary">{{ project.status }}</span>
                                    {% endif %}

                                </td>
                                <td>{{ project.deadline }}</td>
                                <td>
                                    <ul class="list-unstyled users-list m-0 avatar-group d-flex align-items-center">
                                        {% for member in project.team_members.all %}
                                        <li data-bs-toggle="tooltip"
                                            title="{{ member.first_name }} {{ member.last_name }}"
                                            class="avatar avatar-xs pull-up">
                                            <img src="{{ member.profile.avatar.url|default:'/static/default-avatar.png' }}"
                                                alt="Avatar" class="rounded-circle" />
                                        </li>
                                        {% endfor %}
                                    </ul>
                                </td>
                                <td>
                                    <span class="badge bg-label-warning">{{ project.payment_percentage }}%
                                        {{project.payment_status }}</span>
                                </td>
                                <td>
                                    {% if project.live_link %}
                                    <a href="{{ project.live_link }}" target="_blank">{{ project.live_link|urlize }}</a>
                                    {% endif %}
                                </td>
                                <td>

                                    <a href="{% url 'update_project' project.id %}"
                                        class="text-primary me-2 action-icon edit-project"
                                        data-project-id="{{ project.id }}" title="Edit">
                                        <i class="bx bx-edit-alt"></i>
                                    </a>

                                    <a href="#" class="text-danger action-icon delete-project"
                                        data-id="{{ project.id }}" title="Delete">
                                        <i class="bx bx-trash"></i>
                                    </a>

                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="12">No projects found.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% block extra_js %}
                    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
                    <script>
                        function showToast(message, type = "info") {
                            const container = document.getElementById("toast-container") || (() => {
                                const div = document.createElement("div");
                                div.id = "toast-container";
                                div.style.position = "fixed";
                                div.style.top = "20px";
                                div.style.right = "20px";
                                div.style.zIndex = "3000";
                                div.style.display = "flex";
                                div.style.flexDirection = "column";
                                div.style.gap = "10px";
                                document.body.appendChild(div);
                                return div;
                            })();

                            const toast = document.createElement("div");
                            toast.className = `toast align-items-center text-white bg-${type} border-0 show`;
                            toast.style.minWidth = "250px";
                            toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    `;

                            container.appendChild(toast);

                            setTimeout(() => {
                                toast.style.transition = "opacity 0.5s ease, transform 0.5s ease";
                                toast.style.opacity = "0";
                                toast.style.transform = "translateX(100%)";
                                setTimeout(() => toast.remove(), 500);
                            }, 3000);
                        }

                        document.addEventListener("DOMContentLoaded", function () {
                            const toasts = document.querySelectorAll('#toast-container .toast');
                            toasts.forEach(function (toast) {
                                setTimeout(() => {
                                    toast.style.transition = "opacity 0.5s ease, transform 0.5s ease";
                                    toast.style.opacity = "0";
                                    toast.style.transform = "translateX(100%)";
                                    setTimeout(() => toast.remove(), 500);
                                }, 3000); // Auto-hide after 3 seconds
                            });
                        });
                        // Use Django's URL tag so the path is generated correctly
                        const projectDetailsUrl = "{% url 'get_project_details' %}";

                        // View modal fill
                        $(document).on("click", ".project-link", function (e) {
                            e.preventDefault();
                            const projectId = $(this).data("project-id");

                            $.get(projectDetailsUrl, { id: projectId, mode: "view" }, function (res) {
                                if (!res.success) {
                                    console.error("Failed to fetch project:", res.error);
                                    return;
                                }
                                const p = res.project;

                                $("#pd-project-id").text(p.project_id);               // keep showing the human code e.g. "P0001"
                                $("#pd-inquiry-date").text(p.inquiry_date);
                                $("#pd-project-name").text(p.project_name);
                                $("#pd-technologies").text(p.technologies);
                                $("#pd-app-mode").text(p.app_mode);
                                $("#pd-lead-source").text(p.lead_source);
                                $("#pd-status").html(`<span class="badge bg-warning text-dark">${p.status}</span>`);
                                $("#pd-quotation-sent").html(`<span class="badge bg-${p.quotation_sent === 'Yes' ? 'success' : 'danger'}">${p.quotation_sent}</span>`);
                                $("#pd-demo").html(`<span class="badge bg-${p.demo_given === 'Yes' ? 'success' : 'danger'}">${p.demo_given}</span>`);
                                // Team members list (display)
                                let tmHtml = "";
                                (p.team_members_display || []).forEach(m => {
                                    tmHtml += `<div>${m.name}</div>`;
                                });
                                $("#pd-team-members").html(tmHtml);
                                $("#pd-quotation-amount").text(p.quotation_amount ? `₹${p.quotation_amount}` : "");
                                $("#pd-approval-amount").text(p.approval_amount ? `₹${p.approval_amount}` : "");
                                $("#pd-deadline").text(p.deadline);
                                $("#pd-completed-date").text(p.completed_date);
                                $("#pd-payment-status").html(`<span class="badge bg-primary">${p.payment_percentage}% ${p.payment_status}</span>`);
                                $("#pd-client-industry").text(p.client_industry);
                                $("#pd-contract-signed").html(`<span class="badge bg-${p.contract_signed === 'Yes' ? 'success' : 'danger'}">${p.contract_signed}</span>`);
                                if (p.live_link) {
                                    $("#pd-live-link").html(`<a href="${p.live_link}" target="_blank">${p.live_link}</a>`);
                                } else {
                                    $("#pd-live-link").text("");
                                }
                                $("#pd-expense").text(p.expense ? `₹${p.expense}` : "");
                                $("#pd-developer-charge").text(p.developer_charge ? `₹${p.developer_charge}` : "");
                                $("#pd-server-charge").text(p.server_charge ? `₹${p.server_charge}` : "");
                                $("#pd-third-party-charge").text(p.third_party_api_charge ? `₹${p.third_party_api_charge}` : "");
                                $("#pd-income").text(p.income ? `₹${p.income}` : "");
                                $("#pd-free-service").text(p.free_service);
                                if (p.postman_collection) {
                                    $("#pd-postman-collection").html(`<a href="${p.postman_collection}" target="_blank">Postman JSON</a>`);
                                } else {
                                    $("#pd-postman-collection").text("");
                                }
                                if (p.data_folder) {
                                    $("#pd-data-folder").html(`<a href="${p.data_folder}" target="_blank">Data Folder</a>`);
                                } else {
                                    $("#pd-data-folder").text("");
                                }

                                if (p.other_link) {
                                    $("#pd-other-link").html(`<a href="${p.other_link}" target="_blank">Other Link</a>`);
                                } else {
                                    $("#pd-other-link").text("");
                                }
                                $("#pd-start-date").text(p.start_date);



                                $("#projectDetailsModal").modal("show");
                            });
                        });

                        // Edit modal fill
                        $(document).on("click", ".edit-project", function (e) {
                            e.preventDefault();
                            const projectId = $(this).data("project-id");

                            $.get(projectDetailsUrl, { id: projectId, mode: "edit" }, function (res) {
                                if (!res.success) {
                                    console.error("Failed to fetch project for edit:", res.error);
                                    return;
                                }
                                const p = res.project;

                                // Set form action to numeric id URL (update_project/<int:id>/)
                                $("#editProjectForm").attr("action", `/update_project/${p.id}/`);
                                // set hidden ID field
                                $("#edit-project-id").val(p.id);
                                // populate fields in edit modal
                                $("#edit-project-name").val(p.project_name);
                                $("#edit-start-date").val(p.start_date);
                                $("#edit-deadline").val(p.deadline);
                                $("#edit-technologies").val(p.technologies);
                                $("#edit-app-mode").val(p.app_mode);
                                $("#edit-status").val(p.status);
                                $("#edit-payment-percentage").val(p.payment_percentage);
                                $("#edit-payment-status").val(p.payment_status);
                                $("#edit-live-link").val(p.live_link);
                                $("#edit-postman-collection").val(p.postman_collection);
                                $("#edit-data-folder").val(p.data_folder);
                                $("#edit-other-link").val(p.other_link);
                                $("#edit-expense").val(p.expense);
                                $("#edit-developer-charge").val(p.developer_charge);
                                $("#edit-server-charge").val(p.server_charge);
                                $("#edit-third-party-charge").val(p.third_party_api_charge);
                                $("#edit-income").val(p.income);
                                $("#edit-free-service").val(p.free_service);
                                $("#edit-inquiry-date").val(p.inquiry_date);
                                $("#edit-lead-source").val(p.lead_source);
                                $("#edit-quotation-sent").val(p.quotation_sent);
                                $("#edit-demo-given").val(p.demo_given);
                                $("#edit-quotation-amount").val(p.quotation_amount);
                                $("#edit-approval-amount").val(p.approval_amount);
                                $("#edit-completed-date").val(p.completed_date);
                                $("#edit-client-industry").val(p.client_industry);
                                $("#edit-contract-signed").val(p.contract_signed);

                                // For multi-select team members use the numeric ids returned
                                $("#edit-team-members").val(p.team_members_ids || []);
                                // if using plugins like select2 you might need: $("#edit-team-members").trigger('change');

                                $("#editProjectModal").modal("show");
                            });
                        });

                        //delete model
                        let projectIdToDelete = null;

                        $(document).on("click", ".delete-project", function (e) {
                            e.preventDefault();
                            projectIdToDelete = $(this).data("id");
                            var deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
                            deleteModal.show();
                        });

                        $(document).on("click", "#confirmDeleteBtn", function () {
                            if (!projectIdToDelete) return;

                            $.ajax({
                                url: `/delete_project/${projectIdToDelete}/`,
                                type: "POST",
                                data: {
                                    csrfmiddlewaretoken: "{{ csrf_token }}"
                                },
                                success: function (response) {
                                    if (response.success) {
                                        showToast(response.message, "success");
                                        setTimeout(() => window.location.reload(), 1000);
                                    } else {
                                        showToast(response.message || "Something went wrong.", "danger");
                                    }
                                },
                                error: function () {
                                    showToast("Unexpected error while deleting project.", "danger");
                                }
                            });

                            // Hide modal after clicking confirm
                            var deleteModalEl = document.getElementById('deleteConfirmModal');
                            var deleteModalInstance = bootstrap.Modal.getInstance(deleteModalEl);
                            deleteModalInstance.hide();
                        });


                    </script>

                    {% endblock %}

                </div>
                <!-- Records Per Page & Pagination -->
                <div class="d-flex justify-content-between align-items-center mt-3">

                    <!-- Records Per Page Dropdown -->
                    <div class="d-flex align-items-center">
                        <form method="GET" id="recordsForm" class="d-flex align-items-center">
                            <label for="recordsPerPage" class="me-2 mb-0">Records per page:</label>
                            <select class="form-select form-select-sm" name="recordsPerPage" id="recordsPerPage"
                                style="width: auto;">
                                {% for option in records_options %}
                                <option value="{{ option }}" {% if records_per_page == option %}selected{% endif %}>
                                    {{ option }}
                                </option>
                                {% endfor %}
                            </select>
                        </form>
                    </div>

                    <!-- Pagination -->
                    <nav aria-label="Page navigation" class="mt-3">
                        <ul class="pagination justify-content-end mb-0">

                            <!-- Previous Button -->
                            <li class="page-item {% if not page_obj.has_previous %}disabled{% endif %}">
                                {% if page_obj.has_previous %}
                                <a class="page-link"
                                    href="?page={{ page_obj.previous_page_number }}&recordsPerPage={{ records_per_page }}">
                                    <i class="bx bx-chevrons-left"></i>
                                </a>
                                {% else %}
                                <span class="page-link disabled">
                                    <i class="bx bx-chevrons-left"></i>
                                </span>
                                {% endif %}
                            </li>


                            <!-- Always show page 1 -->
                            <li class="page-item {% if page_obj.number == 1 %}active{% endif %}">
                                <a class="page-link" href="?page=1&recordsPerPage={{ records_per_page }}">1</a>
                            </li>

                            <!-- Always show page 2 if exists -->
                            {% if page_obj.paginator.num_pages >= 2 %}
                            <li class="page-item {% if page_obj.number == 2 %}active{% endif %}">
                                <a class="page-link" href="?page=2&recordsPerPage={{ records_per_page }}">2</a>
                            </li>
                            {% endif %}

                            <!-- Ellipsis if there’s a gap before last two pages -->
                            {% if page_obj.paginator.num_pages > 4 %}
                            <li class="page-item disabled"><span class="page-link">…</span></li>
                            {% endif %}

                            <!-- Show second last page only if it's not duplicate of page 2 -->
                            {% if page_obj.paginator.num_pages > 2 and page_obj.paginator.num_pages|add:'-1' != 2 %}
                            <li
                                class="page-item {% if page_obj.number == page_obj.paginator.num_pages|add:'-1' %}active{% endif %}">
                                <a class="page-link"
                                    href="?page={{ page_obj.paginator.num_pages|add:'-1' }}&recordsPerPage={{ records_per_page }}">
                                    {{ page_obj.paginator.num_pages|add:'-1' }}
                                </a>
                            </li>
                            {% endif %}

                            <!-- Show last page only if it's not duplicate of page 2 -->
                            {% if page_obj.paginator.num_pages > 1 and page_obj.paginator.num_pages != 2 %}
                            <li
                                class="page-item {% if page_obj.number == page_obj.paginator.num_pages %}active{% endif %}">
                                <a class="page-link"
                                    href="?page={{ page_obj.paginator.num_pages }}&recordsPerPage={{ records_per_page }}">
                                    {{ page_obj.paginator.num_pages }}
                                </a>
                            </li>
                            {% endif %}

                            <!-- Next Button -->
                            <li class="page-item {% if not page_obj.has_next %}disabled{% endif %}">
                                {% if page_obj.has_next %}
                                <a class="page-link"
                                    href="?page={{ page_obj.next_page_number }}&recordsPerPage={{ records_per_page }}">
                                    <i class="bx bx-chevrons-right"></i>
                                </a>
                                {% else %}
                                <span class="page-link disabled">
                                    <i class="bx bx-chevrons-right"></i>
                                </span>
                                {% endif %}
                            </li>

                        </ul>
                    </nav>
                </div>

                <script>
                    document.getElementById('recordsPerPage').addEventListener('change', function () {
                        // Always reset to page 1 when changing limit
                        const form = document.getElementById('recordsForm');
                        const hiddenPage = document.createElement('input');
                        hiddenPage.type = 'hidden';
                        hiddenPage.name = 'page';
                        hiddenPage.value = 1;
                        form.appendChild(hiddenPage);
                        form.submit();
                    });
                </script>



            </div>

            <!--/ All Projects Table -->

        </div>
        <!-- /Content -->

        <div class="content-backdrop fade"></div>
    </div>

    <div id="alert-container"
        style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1050;">
    </div>

    <!-- Layout wrapper -->
    <!-- Add Project Modal -->
    <div class="modal fade" id="addProjectModal" tabindex="-1" aria-labelledby="addProjectModalLabel" aria-hidden="true"
        data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header table-primary text-white">
                    <h5 class="modal-title" id="addProjectModalLabel">
                        <i class="bx bx-plus me-2"></i> Add New Project
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>

                <form id="projectForm" method="POST" action="{% url 'save_project' %}">
                    {% csrf_token %}
                    <div class="modal-body px-4 py-3" style="max-height: 70vh; overflow-y: auto;">
                        <div class="table-responsive">
                            <table class="table table-bordered align-middle">
                                <tbody>
                                    <!-- Project Basic Info -->
                                    <tr>
                                        <th>Project Name</th>
                                        <td colspan="3">
                                            <input type="text" class="form-control" name="project_name" required>
                                            <div class="invalid-feedback"></div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Start Date</th>
                                        <td>
                                            <input type="date" class="form-control" name="start_date" required>
                                            <div class="invalid-feedback"></div>
                                        </td>
                                        <th>Deadline</th>
                                        <td>
                                            <input type="date" class="form-control" name="deadline">
                                            <div class="invalid-feedback"></div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Technologies</th>
                                        <td>
                                            <input type="text" class="form-control" name="technologies" required>
                                            <div class="invalid-feedback"></div>
                                        </td>
                                        <th>App Mode</th>
                                        <td>
                                            <input type="text" class="form-control" name="app_mode" required>
                                            <div class="invalid-feedback"></div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Status</th>
                                        <td>
                                            <select class="form-select" name="status" required>
                                                <option value="">-- Select --</option>
                                                <option value="Ongoing">Ongoing</option>
                                                <option value="Completed">Completed</option>
                                                <option value="On Hold">On Hold</option>
                                                <option value="Cancelled">Cancelled</option>
                                            </select>
                                            <div class="invalid-feedback"></div>
                                        </td>
                                        <th>Team Members</th>
                                        <td>
                                            <select class="form-select" name="team_members" multiple required>
                                                {% for user in users %}
                                                <option value="{{ user.id }}">{{ user.first_name }} {{ user.last_name }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                            <small class="text-muted">Hold CTRL (Windows) or CMD (Mac) to select
                                                multiple</small>
                                            <div class="invalid-feedback"></div>
                                        </td>
                                    </tr>

                                    <!-- Payment Info -->
                                    <tr>
                                        <th>Payment %</th>
                                        <td>
                                            <input type="number" class="form-control" name="payment_percentage" min="0"
                                                max="100" required>
                                            <div class="invalid-feedback"></div>
                                        </td>
                                        <th>Payment Status</th>
                                        <td>
                                            <select class="form-select" name="payment_status" required>
                                                <option value="Pending">Pending</option>
                                                <option value="Advanced">Advanced</option>
                                                <option value="Paid">Paid</option>
                                            </select>
                                            <div class="invalid-feedback"></div>
                                        </td>
                                    </tr>

                                    <!-- Links -->
                                    <tr>
                                        <th>Live Link</th>
                                        <td colspan="3">
                                            <input type="url" class="form-control" name="live_link"
                                                placeholder="https://example.com">
                                            <div class="invalid-feedback"></div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Postman Collection</th>
                                        <td colspan="3">
                                            <input type="url" class="form-control" name="postman_collection"
                                                placeholder="https://example.com/postman.json">
                                            <div class="invalid-feedback"></div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Data Folder</th>
                                        <td colspan="3">
                                            <input type="url" class="form-control" name="data_folder"
                                                placeholder="https://example.com/data/">
                                            <div class="invalid-feedback"></div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Other Link</th>
                                        <td colspan="3">
                                            <input type="url" class="form-control" name="other_link"
                                                placeholder="https://example.com/other">
                                            <div class="invalid-feedback"></div>
                                        </td>
                                    </tr>

                                    <!-- Financials -->
                                    <tr>
                                        <th>Expense</th>
                                        <td>
                                            <input type="number" step="0.01" class="form-control" name="expense"
                                                required>
                                            <div class="invalid-feedback"></div>
                                        </td>
                                        <th>Developer Charge</th>
                                        <td>
                                            <input type="number" step="0.01" class="form-control"
                                                name="developer_charge" required>
                                            <div class="invalid-feedback"></div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Server Charge</th>
                                        <td>
                                            <input type="number" step="0.01" class="form-control" name="server_charge"
                                                required>
                                            <div class="invalid-feedback"></div>
                                        </td>
                                        <th>3rd Party API Charge</th>
                                        <td>
                                            <input type="number" step="0.01" class="form-control"
                                                name="third_party_api_charge" required>
                                            <div class="invalid-feedback"></div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Income</th>
                                        <td colspan="3">
                                            <input type="number" step="0.01" class="form-control" name="income"
                                                required>
                                            <div class="invalid-feedback"></div>
                                        </td>
                                    </tr>

                                    <!-- Free Service -->
                                    <tr>
                                        <th>Free Service</th>
                                        <td colspan="3">
                                            <textarea class="form-control" name="free_service" rows="2"
                                                required></textarea>
                                            <div class="invalid-feedback"></div>
                                        </td>
                                    </tr>

                                    <!-- Sales / Lead Tracking -->
                                    <tr>
                                        <th>Inquiry Date</th>
                                        <td>
                                            <input type="date" class="form-control" name="inquiry_date" required>
                                            <div class="invalid-feedback"></div>
                                        </td>
                                        <th>Lead Source</th>
                                        <td>
                                            <input type="text" class="form-control" name="lead_source" required>
                                            <div class="invalid-feedback"></div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Quotation Sent</th>
                                        <td>
                                            <select class="form-select" name="quotation_sent" required>
                                                <option value="">-- Select --</option>
                                                <option value="Yes">Yes</option>
                                                <option value="No">No</option>
                                            </select>
                                            <div class="invalid-feedback"></div>
                                        </td>
                                        <th>Demo Given</th>
                                        <td>
                                            <select class="form-select" name="demo_given" required>
                                                <option value="">-- Select --</option>
                                                <option value="Yes">Yes</option>
                                                <option value="No">No</option>
                                            </select>
                                            <div class="invalid-feedback"></div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Quotation Amount</th>
                                        <td>
                                            <input type="number" step="0.01" class="form-control"
                                                name="quotation_amount" required>
                                            <div class="invalid-feedback"></div>
                                        </td>
                                        <th>Approval Amount</th>
                                        <td>
                                            <input type="number" step="0.01" class="form-control" name="approval_amount"
                                                required>
                                            <div class="invalid-feedback"></div>
                                        </td>
                                    </tr>

                                    <!-- Completion / Client Info -->
                                    <tr>
                                        <th>Completed Date</th>
                                        <td>
                                            <input type="date" class="form-control" name="completed_date">
                                            <div class="invalid-feedback"></div>
                                        </td>
                                        <th>Client Industry</th>
                                        <td>
                                            <input type="text" class="form-control" name="client_industry" required>
                                            <div class="invalid-feedback"></div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Contract Signed</th>
                                        <td colspan="3">
                                            <select class="form-select" name="contract_signed" required>
                                                <option value="">-- Select --</option>
                                                <option value="Yes">Yes</option>
                                                <option value="No">No</option>
                                            </select>
                                            <div class="invalid-feedback"></div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Save Project</button>
                    </div>
                </form>
                <script>
                    document.getElementById("projectForm").addEventListener("submit", function (e) {
                        e.preventDefault();
                        let form = this;
                        let formData = new FormData(form);

                        fetch(form.action, {
                            method: "POST",
                            body: formData,
                            headers: {
                                "X-Requested-With": "XMLHttpRequest",
                                "X-CSRFToken": form.querySelector('[name=csrfmiddlewaretoken]').value
                            }
                        })
                            .then(res => res.json())
                            .then(data => {
                                // clear old errors
                                form.querySelectorAll(".is-invalid").forEach(el => el.classList.remove("is-invalid"));
                                form.querySelectorAll(".invalid-feedback").forEach(el => el.innerText = "");

                                if (data.success) {
                                    // Close modal
                                    let modalEl = document.getElementById("addProjectModal");
                                    let modal = bootstrap.Modal.getInstance(modalEl);
                                    modal.hide();

                                    // Show success toast
                                    showToast(data.message, "success");

                                    // Refresh after short delay so toast is visible
                                    setTimeout(() => window.location.reload(), 1000);

                                } else {
                                    if (data.errors) {
                                        for (let field in data.errors) {
                                            let input = form.querySelector(`[name="${field}"]`);
                                            if (input) {
                                                input.classList.add("is-invalid");
                                                let feedback = input.closest("td,div").querySelector(".invalid-feedback");
                                                if (feedback) {
                                                    feedback.innerText = data.errors[field].join(", ");
                                                }
                                            }
                                        }
                                    }

                                    // Show general error toast
                                    if (data.errors["__all__"]) {
                                        showToast(data.errors["__all__"].join(", "), "danger");
                                    }
                                }

                            })
                            .catch(err => console.error("Error:", err));
                    });

                </script>

            </div>
        </div>
    </div>


    <!-- Project Details Modal -->
    <div class="modal fade" id="projectDetailsModal" tabindex="-1" aria-labelledby="projectDetailsModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header table-primary text-white">
                    <h5 class="modal-title" id="projectDetailsModalLabel">
                        <i class="bx bx-folder-open me-2"></i> Project Details: Hospital Management
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body px-4 py-3">
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped align-middle">
                            <tbody>
                                <tr>
                                    <th>Project ID</th>
                                    <td id="pd-project-id"></td>
                                    <th>Inquiry Date</th>
                                    <td id="pd-inquiry-date"></td>
                                </tr>
                                <tr>
                                    <th>Project Name</th>
                                    <td id="pd-project-name"></td>
                                    <th>Technologies</th>
                                    <td id="pd-technologies"></td>
                                </tr>
                                <tr>
                                    <th>App Mode</th>
                                    <td id="pd-app-mode"></td>
                                    <th>Lead Source</th>
                                    <td id="pd-lead-source"></td>
                                </tr>
                                <tr>
                                    <th>Status</th>
                                    <td id="pd-status"></td>
                                    <th>Quotation Sent?</th>
                                    <td id="pd-quotation-sent"></td>
                                </tr>
                                <tr>
                                    <th>Demo</th>
                                    <td id="pd-demo"></td>
                                    <th>Team Members</th>
                                    <td id="pd-team-members"></td>
                                </tr>
                                <tr>
                                    <th>Quotation Amount</th>
                                    <td id="pd-quotation-amount"></td>
                                    <th>Approval Amount</th>
                                    <td id="pd-approval-amount"></td>
                                </tr>
                                <tr>
                                    <th>Deadline</th>
                                    <td id="pd-deadline"></td>
                                    <th>Completed Date</th>
                                    <td id="pd-completed-date"></td>
                                </tr>
                                <tr>
                                    <th>Payment Status (Client)</th>
                                    <td id="pd-payment-status" colspan="3"></td>
                                </tr>
                                <tr>
                                    <th>Client Industry</th>
                                    <td id="pd-client-industry"></td>
                                    <th>Contract Signed?</th>
                                    <td id="pd-contract-signed"></td>
                                </tr>
                                <tr>
                                    <th>Live Link / API</th>
                                    <td id="pd-live-link" colspan="3"></td>
                                </tr>
                                <tr class="table-secondary fw-bold text-dark">
                                    <td colspan="4" class="text-center">💸 Expense & Income</td>
                                </tr>
                                <tr>
                                    <th>Expense</th>
                                    <td id="pd-expense"></td>
                                    <th>Developer Charge</th>
                                    <td id="pd-developer-charge"></td>
                                </tr>
                                <tr>
                                    <th>Server Charge</th>
                                    <td id="pd-server-charge"></td>
                                    <th>3rd Party API Charge</th>
                                    <td id="pd-third-party-charge"></td>
                                </tr>
                                <tr>
                                    <th>Income</th>
                                    <td id="pd-income" colspan="3"></td>
                                </tr>
                                <tr>
                                    <th>Free Service</th>
                                    <td id="pd-free-service"></td>
                                    <th>Postman Collection</th>
                                    <td id="pd-postman-collection"></td>
                                </tr>
                                <tr>
                                    <th>Data Folder</th>
                                    <td id="pd-data-folder" colspan="3"></td>
                                </tr>
                                <tr>
                                    <th>Other Link</th>
                                    <td id="pd-other-link" colspan="3"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Project Modal -->
    <div class="modal fade" id="editProjectModal" tabindex="-1" aria-labelledby="editProjectModalLabel"
        aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header table-primary text-white">
                    <h5 class="modal-title" id="editProjectModalLabel">
                        <i class="bx bx-edit me-2"></i> Edit Project
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>

                <form id="editProjectForm" method="POST">
                    {% csrf_token %}
                    <!-- hidden ID field -->
                    <input type="hidden" name="project_id" id="edit-project-id">

                    <div class="modal-body px-4 py-3" style="max-height: 70vh; overflow-y: auto;">
                        <div class="table-responsive">
                            <table class="table table-bordered align-middle">
                                <tbody>
                                    <!-- Project Basic Info -->
                                    <tr>
                                        <th>Project Name</th>
                                        <td colspan="3">
                                            <input type="text" class="form-control" name="project_name"
                                                id="edit-project-name" required>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Start Date</th>
                                        <td><input type="date" class="form-control" name="start_date"
                                                id="edit-start-date">
                                        </td>
                                        <th>Deadline</th>
                                        <td><input type="date" class="form-control" name="deadline" id="edit-deadline">
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Technologies</th>
                                        <td><input type="text" class="form-control" name="technologies"
                                                id="edit-technologies"></td>
                                        <th>App Mode</th>
                                        <td><input type="text" class="form-control" name="app_mode" id="edit-app-mode">
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Status</th>
                                        <td>
                                            <select class="form-select" name="status" id="edit-status">
                                                <option value="">-- Select --</option>
                                                <option value="Ongoing">Ongoing</option>
                                                <option value="Completed">Completed</option>
                                                <option value="On Hold">On Hold</option>
                                                <option value="Cancelled">Cancelled</option>
                                            </select>
                                        </td>
                                        <th>Team Members</th>
                                        <td>
                                            <select class="form-select" name="team_members" id="edit-team-members"
                                                multiple>
                                                {% for user in users %}
                                                <option value="{{ user.id }}">{{ user.first_name }} {{ user.last_name }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                            <small class="text-muted">Hold CTRL (Windows) or CMD (Mac) to select
                                                multiple
                                                members</small>
                                        </td>
                                    </tr>

                                    <!-- Payment Info -->
                                    <tr>
                                        <th>Payment %</th>
                                        <td><input type="number" class="form-control" name="payment_percentage"
                                                id="edit-payment-percentage" min="0" max="100"></td>
                                        <th>Payment Status</th>
                                        <td>
                                            <select class="form-select" name="payment_status" id="edit-payment-status">
                                                <option value="Pending">Pending</option>
                                                <option value="Advanced">Advanced</option>
                                                <option value="Paid">Paid</option>
                                            </select>
                                        </td>
                                    </tr>

                                    <!-- Links -->
                                    <tr>
                                        <th>Live Link</th>
                                        <td colspan="3"><input type="url" class="form-control" name="live_link"
                                                id="edit-live-link"></td>
                                    </tr>
                                    <tr>
                                        <th>Postman Collection</th>
                                        <td colspan="3"><input type="url" class="form-control" name="postman_collection"
                                                id="edit-postman-collection"></td>
                                    </tr>
                                    <tr>
                                        <th>Data Folder</th>
                                        <td colspan="3"><input type="url" class="form-control" name="data_folder"
                                                id="edit-data-folder"></td>
                                    </tr>
                                    <tr>
                                        <th>Other Link</th>
                                        <td colspan="3"><input type="url" class="form-control" name="other_link"
                                                id="edit-other-link"></td>
                                    </tr>

                                    <!-- Financials -->
                                    <tr>
                                        <th>Expense</th>
                                        <td><input type="number" step="0.01" class="form-control" name="expense"
                                                id="edit-expense"></td>
                                        <th>Developer Charge</th>
                                        <td><input type="number" step="0.01" class="form-control"
                                                name="developer_charge" id="edit-developer-charge"></td>
                                    </tr>
                                    <tr>
                                        <th>Server Charge</th>
                                        <td><input type="number" step="0.01" class="form-control" name="server_charge"
                                                id="edit-server-charge"></td>
                                        <th>3rd Party API Charge</th>
                                        <td><input type="number" step="0.01" class="form-control"
                                                name="third_party_api_charge" id="edit-third-party-charge"></td>
                                    </tr>
                                    <tr>
                                        <th>Income</th>
                                        <td colspan="3"><input type="number" step="0.01" class="form-control"
                                                name="income" id="edit-income"></td>
                                    </tr>

                                    <!-- Free Service -->
                                    <tr>
                                        <th>Free Service</th>
                                        <td colspan="3"><textarea class="form-control" name="free_service"
                                                id="edit-free-service" rows="2"></textarea></td>
                                    </tr>

                                    <!-- Sales / Lead Tracking -->
                                    <tr>
                                        <th>Inquiry Date</th>
                                        <td><input type="date" class="form-control" name="inquiry_date"
                                                id="edit-inquiry-date"></td>
                                        <th>Lead Source</th>
                                        <td><input type="text" class="form-control" name="lead_source"
                                                id="edit-lead-source"></td>
                                    </tr>
                                    <tr>
                                        <th>Quotation Sent</th>
                                        <td>
                                            <select class="form-select" name="quotation_sent" id="edit-quotation-sent">
                                                <option value="">-- Select --</option>
                                                <option value="Yes">Yes</option>
                                                <option value="No">No</option>
                                            </select>
                                        </td>
                                        <th>Demo Given</th>
                                        <td>
                                            <select class="form-select" name="demo_given" id="edit-demo-given">
                                                <option value="">-- Select --</option>
                                                <option value="Yes">Yes</option>
                                                <option value="No">No</option>
                                            </select>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Quotation Amount</th>
                                        <td><input type="number" step="0.01" class="form-control"
                                                name="quotation_amount" id="edit-quotation-amount"></td>
                                        <th>Approval Amount</th>
                                        <td><input type="number" step="0.01" class="form-control" name="approval_amount"
                                                id="edit-approval-amount"></td>
                                    </tr>

                                    <!-- Completion / Client Info -->
                                    <tr>
                                        <th>Completed Date</th>
                                        <td><input type="date" class="form-control" name="completed_date"
                                                id="edit-completed-date"></td>
                                        <th>Client Industry</th>
                                        <td><input type="text" class="form-control" name="client_industry"
                                                id="edit-client-industry"></td>
                                    </tr>
                                    <tr>
                                        <th>Contract Signed</th>
                                        <td colspan="3">
                                            <select class="form-select" name="contract_signed"
                                                id="edit-contract-signed">
                                                <option value="">-- Select --</option>
                                                <option value="Yes">Yes</option>
                                                <option value="No">No</option>
                                            </select>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Update Project</button>
                    </div>
                </form>
                <script>
                    document.getElementById("editProjectForm").addEventListener("submit", function (e) {
                        e.preventDefault();
                        let form = this;
                        let formData = new FormData(form);
                        let projectId = document.getElementById("edit-project-id").value;

                        if (!projectId) {
                            showToast("Project ID missing!", "danger");
                            return;
                        }

                        fetch(`/update_project/${projectId}/`, {
                            method: "POST",
                            body: formData,
                            headers: {
                                "X-Requested-With": "XMLHttpRequest",
                                "X-CSRFToken": form.querySelector('[name=csrfmiddlewaretoken]').value
                            }
                        })
                            .then(res => res.json())
                            .then(data => {
                                // Clear old validation errors
                                form.querySelectorAll(".is-invalid").forEach(el => el.classList.remove("is-invalid"));
                                form.querySelectorAll(".invalid-feedback").forEach(el => el.innerText = "");

                                if (data.success) {
                                    // Close modal
                                    let modalEl = document.getElementById("editProjectModal");
                                    let modal = bootstrap.Modal.getInstance(modalEl);
                                    modal.hide();

                                    // Show success toast
                                    showToast(data.message, "success");

                                    // Refresh after a short delay
                                    setTimeout(() => window.location.reload(), 1000);
                                } else {
                                    if (data.errors) {
                                        for (let field in data.errors) {
                                            let input = form.querySelector(`[name="${field}"]`);
                                            if (input) {
                                                input.classList.add("is-invalid");
                                                let feedback = input.closest("td,div").querySelector(".invalid-feedback");
                                                if (feedback) {
                                                    feedback.innerText = data.errors[field].join(", ");
                                                }
                                            }
                                        }
                                    }

                                    if (data.errors["__all__"]) {
                                        showToast(data.errors["__all__"].join(", "), "danger");
                                    }
                                }
                            })
                            .catch(err => {
                                console.error("Error:", err);
                                showToast("Unexpected error while updating project.", "danger");
                            });
                    });

                </script>

            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content text-center">
                <div class="modal-header border-0">
                    <h5 class="modal-title w-100" id="deleteConfirmLabel">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this project?
                </div>
                <div class="modal-footer justify-content-center border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                </div>
            </div>
        </div>
    </div>

    {% endblock %}
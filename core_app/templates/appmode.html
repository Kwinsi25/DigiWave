{% extends "base.html" %}
{% load static %}
{% block title %}All App Modes{% endblock %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

{% block content %}
{% if messages %}
<div id="toast-container" style="
    position: fixed; top:20px; right:20px; z-index:3000;
    display:flex; flex-direction:column; gap:10px;">
  {% for message in messages %}
  <div class="toast align-items-center text-white bg-{{ message.tags }} border-0 show" role="alert">
    <div class="d-flex">
      <div class="toast-body">{{ message }}</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
  {% endfor %}
</div>
{% endif %}

<div class="content-wrapper">
  <div class="container-xxl flex-grow-1 container-p-y">

    <!-- Stats Card -->
    <div class="row mb-4">
      <div class="col-md-3 col-sm-6 mb-3">
        <div class="card h-100 shadow-sm border-0">
          <div class="card-body d-flex justify-content-between align-items-center">
            <div>
              <h6 class="mb-1">Total App Modes</h6>
              <h4 class="fw-bold text-primary">{{ total_app_modes }}</h4>
            </div>
            <div class="avatar bg-primary text-white rounded-circle p-2">
              <i class="bx bx-cog"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- App Modes Table -->
    <div class="card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4 class="mb-0">All App Modes</h4>
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAppModeModal">
            <i class="bx bx-plus"></i> Add App Mode
          </button>
        </div>

        <div class="table-responsive text-nowrap scrollable-table-body">
          <table class="table" id="appModeTable">
            <thead>
              <tr>
                <th data-sort="number">Sr No.</th>
                <th data-sort="string">Name</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for mode in page_obj %}
              <tr>
                <td>{{ forloop.counter0|add:page_obj.start_index }}</td>
                <td>{{ mode.name }}</td>
                <td>
                  <a href="#" class="text-primary me-2 edit-appmode" data-appmode-id="{{ mode.id }}"><i class="bx bx-edit-alt"></i></a>
                  <a href="#" class="text-danger delete-appmode" data-appmode-id="{{ mode.id }}"><i class="bx bx-trash"></i></a>
                </td>
              </tr>
              {% empty %}
              <tr id="noAppModeRow">
                <td colspan="3" class="text-center">No App Mode found.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="d-flex justify-content-between align-items-center mt-3">
          <div class="d-flex align-items-center">
            <form method="GET" id="recordsForm" class="d-flex align-items-center">
              <label for="recordsPerPage" class="me-2 mb-0">Records per page:</label>
              <select class="form-select form-select-sm" name="recordsPerPage" id="recordsPerPage" style="width: auto;">
                {% for option in records_options %}
                <option value="{{ option }}" {% if records_per_page == option %}selected{% endif %}>
                  {{ option }}
                </option>
                {% endfor %}
              </select>
            </form>
          </div>
          <nav aria-label="Page navigation" class="mt-3">
            <ul class="pagination justify-content-end mb-0">
              <!-- Previous -->
              <li class="page-item {% if not page_obj.has_previous %}disabled{% endif %}">
                {% if page_obj.has_previous %}
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}&recordsPerPage={{ records_per_page }}">
                  <i class="bx bx-chevrons-left"></i>
                </a>
                {% else %}
                <span class="page-link disabled"><i class="bx bx-chevrons-left"></i></span>
                {% endif %}
              </li>
              <!-- Pages logic same as Technology template -->
              {% for i in page_obj.paginator.page_range %}
              <li class="page-item {% if page_obj.number == i %}active{% endif %}">
                <a class="page-link" href="?page={{ i }}&recordsPerPage={{ records_per_page }}">{{ i }}</a>
              </li>
              {% endfor %}
              <!-- Next -->
              <li class="page-item {% if not page_obj.has_next %}disabled{% endif %}">
                {% if page_obj.has_next %}
                <a class="page-link" href="?page={{ page_obj.next_page_number }}&recordsPerPage={{ records_per_page }}">
                  <i class="bx bx-chevrons-right"></i>
                </a>
                {% else %}
                <span class="page-link disabled"><i class="bx bx-chevrons-right"></i></span>
                {% endif %}
              </li>
            </ul>
          </nav>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- Add App Mode Modal -->
<div class="modal fade" id="addAppModeModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header table-primary text-white">
        <h5 class="modal-title"><i class="bx bx-cog me-2"></i> Add App Mode</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
      </div>
      <form id="addAppModeForm" method="POST" action="{% url 'add_appmode' %}">
        {% csrf_token %}
        <div class="modal-body">
          <table class="table table-bordered">
            <tbody>
              <tr>
                <th>Name</th>
                <td><input class="form-control" name="name" maxlength="100" required placeholder="App Mode Name"></td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" type="submit">Save App Mode</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit App Mode Modal -->
<div class="modal fade" id="editAppModeModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header table-warning text-dark">
        <h5 class="modal-title"><i class="bx bx-edit-alt me-2"></i> Edit App Mode</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
      </div>
      <form id="editAppModeForm" method="POST" action="{% url 'update_appmode' %}">
        {% csrf_token %}
        <input type="hidden" name="id" id="edit-appmode-id">
        <div class="modal-body">
          <table class="table table-bordered">
            <tbody>
              <tr>
                <th>Name</th>
                <td><input class="form-control" name="name" id="edit-name" required placeholder="App Mode Name"></td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" type="submit">Update App Mode</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete App Mode Modal -->
<div class="modal fade" id="deleteAppModeModal" tabindex="-1" aria-labelledby="deleteAppModeLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center">
      <div class="modal-header border-0">
        <h5 class="modal-title w-100" id="deleteAppModeLabel">Confirm Delete</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this App Mode?
      </div>
      <div class="modal-footer justify-content-center border-0">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteAppModeBtn">Delete</button>
      </div>
    </div>
  </div>
</div>

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="{% static 'js/common.js' %}"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
   // searching
    enableTableSearch("searchBox", "appModeTable");
    // sorting
    
    enableTableSorting("appModeTable");
  

  // Edit App Mode
  $(document).on("click", ".edit-appmode", function () {
    const id = $(this).data("appmode-id");
    if (!id) { showToast("Invalid App Mode ID", "danger"); return; }

    fetch(`/get_appmode/?id=${id}`, { headers: { "X-Requested-With": "XMLHttpRequest" } })
      .then(res => res.json())
      .then(data => {
        if (!data.id) { showToast("Error fetching App Mode data", "danger"); return; }
        document.getElementById("edit-appmode-id").value = data.id;
        document.getElementById("edit-name").value = data.name;
        const editModal = bootstrap.Modal.getOrCreateInstance(document.getElementById("editAppModeModal"));
        editModal.show();
      })
      .catch(err => showToast("Error fetching App Mode data", "danger"));
  });

  // Delete App Mode
  let appModeIdToDelete = null;
  $(document).on("click", ".delete-appmode", function () {
    appModeIdToDelete = $(this).data("appmode-id");
    if (!appModeIdToDelete) { showToast("Invalid App Mode ID", "danger"); return; }
    bootstrap.Modal.getOrCreateInstance(document.getElementById("deleteAppModeModal")).show();
  });

  $("#confirmDeleteAppModeBtn").click(function () {
    if (!appModeIdToDelete) return;
    $.ajax({
      url: `/delete_appmode/${appModeIdToDelete}/`,
      type: "POST",
      data: { csrfmiddlewaretoken: "{{ csrf_token }}" },
      success: function(res) {
        if(res.success){ showToast(res.message, "success"); setTimeout(() => window.location.reload(), 800); }
        else{ showToast(res.error, "danger"); }
      },
      error: function() { showToast("Unexpected error deleting App Mode", "danger"); }
    });
    bootstrap.Modal.getOrCreateInstance(document.getElementById("deleteAppModeModal")).hide();
  });

});
</script>
{% endblock %}

{% endblock %}

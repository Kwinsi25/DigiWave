{% extends "base.html" %}
{% block title %}Attendance{% endblock %}
{% load static %}

{% block extra_css %}
<style>
.scrollable-table-body { max-height: 400px; overflow-y: auto; }
.scrollable-table-body table { margin-bottom: 0; }
.scrollable-table-body thead th { position: sticky; top: 0; background: #fff; z-index: 1; }
</style>
{% endblock %}

{% block content %}
{% if messages %}
<div id="toast-container" style="position: fixed; top: 20px; right: 20px; z-index: 3000; display:flex; flex-direction:column; gap:10px;">
    {% for message in messages %}
    <div class="toast align-items-center text-white bg-{{ message.tags }} border-0 show">
        <div class="d-flex">
            <div class="toast-body">{{ message }}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<div class="content-wrapper">
  <div class="container-xxl flex-grow-1 container-p-y">

    <!-- Stats Cards -->
    <div class="row mb-4">
      <div class="col-md-3 col-sm-6 mb-3">
        <div class="card h-100 shadow-sm border-0">
          <div class="card-body d-flex align-items-center justify-content-between">
            <div>
              <h6 class="mb-1">Present Today</h6>
              <h4 class="fw-bold text-success">{{ present_today }}</h4>
            </div>
            <div class="avatar bg-success text-white rounded-circle p-2">
              <i class="bx bx-user-check"></i>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3 col-sm-6 mb-3">
        <div class="card h-100 shadow-sm border-0">
          <div class="card-body d-flex justify-content-between align-items-center">
            <div>
              <h6 class="mb-1">Absent Today</h6>
              <h4 class="fw-bold text-danger">{{ absent_today }}</h4>
            </div>
            <div class="avatar bg-danger text-white rounded-circle p-2">
              <i class="bx bx-user-x"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Attendance Table -->
    <div class="card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4 class="mb-0">Attendance Logs</h4>
         <div>
    <button class="btn btn-success me-2" id="clockInBtn"
        {% if is_clocked_in %}disabled{% endif %}>
        <i class="bx bx-log-in"></i> Clock In
    </button>
    <button class="btn btn-danger" id="clockOutBtn"
        {% if not is_clocked_in %}disabled{% endif %}>
        <i class="bx bx-log-out"></i> Clock Out
    </button>
</div>

        </div>

        <div class="table-responsive text-nowrap scrollable-table-body">
          <table class="table">
            <thead>
              <tr>
                <th>Sr No.</th>
                <th>Date</th>
                <th>Clock In</th>
                <th>Clock Out</th>
                <th>Total Break</th>
                <th>Total Hours</th>
              </tr>
            </thead>
           <tbody>
  {% for record in attendance_logs %}
  <tr>
    <td>{{ forloop.counter }}</td>
    <td>{{ record.date|date:"M. d, Y" }}</td>
    <!-- Only first in -->
    <td>
      {% if record.first_in %}
        {{ record.first_in|date:"h:i A" }}
      {% else %}
        -
      {% endif %}
    </td>
    <!-- Only last out -->
    <td>
      {% if record.last_out %}
        {{ record.last_out|date:"h:i A" }}
      {% else %}
        -
      {% endif %}
    </td>
    <td>{{ record.total_break_str }}</td>
    <td>{{ record.total_hours_str }}</td>
  </tr>
  {% empty %}
  <tr>
    <td colspan="6" class="text-center">No attendance records found.</td>
  </tr>
  {% endfor %}
</tbody>

          </table>
        </div>
      </div>
    </div>

  </div>
</div>

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="{% static 'js/common.js' %}"></script>
<script>
  function formatDateTime(dt) {
    const options = { 
        year: 'numeric', month: 'short', day: 'numeric',
        hour: '2-digit', minute: '2-digit', second: '2-digit',
        hour12: true
    };
    return dt.toLocaleString('en-US', options);
}
const clockInBtn = document.getElementById("clockInBtn");
const clockOutBtn = document.getElementById("clockOutBtn");

clockInBtn.addEventListener("click", function(event) {
    event.preventDefault();
    const now = new Date();
    showToast(`Clock In: ${formatDateTime(now)}`, "success");

    // Disable/enable buttons
    clockInBtn.disabled = true;
    clockOutBtn.disabled = false;

    // Redirect after 3 seconds (enough time to see toast)
    setTimeout(() => {
        window.location.href = "{% url 'clock_in' %}";
    }, 3000);
});

clockOutBtn.addEventListener("click", function(event) {
    event.preventDefault();
    const now = new Date();
    showToast(`Clock Out: ${formatDateTime(now)}`, "danger");

    // Disable/enable buttons
    clockOutBtn.disabled = true;
    clockInBtn.disabled = false;

    // Redirect after 3 seconds
    setTimeout(() => {
        window.location.href = "{% url 'clock_out' %}";
    }, 3000);
});

</script>
{% endblock %}
{% endblock %}

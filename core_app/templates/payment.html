{% extends "base.html" %}
{% load static %}
{% block title %}All Payments{% endblock %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

{% block extra_css %}
<style>
    .alert-success {
        background-color: #017004 !important;
        /* Green */
        color: black !important;
    }

    /* Example: Custom error background */
    .alert-error,
    .alert-danger {
        background-color: #F44336;
        /* Red */
        color: black;
    }

    /* Example: Custom info background */
    .alert-info {
        background-color: #2196F3;
        /* Blue */
        color: black;
    }

    /* Example: Custom warning background */
    .alert-warning {
        background-color: #FF9800;
        /* Orange */
        color: black;
    }

    .scrollable-table-body {
        max-height: 400px;
        /* Adjust height as needed */
        overflow-y: auto;
    }

    .scrollable-table-body table {
        margin-bottom: 0;
        /* Avoid extra spacing */
    }

    /* Optional: Fix the header */
    .scrollable-table-body thead th {
        position: sticky;
        top: 0;
        background: #fff;
        z-index: 1;
    }
</style>
{% endblock %}

{% block content %}
{% if messages %}
<div id="toast-container" style="
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 3000;  /* above sidebar/navbar */
    display: flex;
    flex-direction: column;
    gap: 10px;
">
    {% for message in messages %}
    <div class="toast align-items-center text-white bg-{{ message.tags }} border-0 show" role="alert"
        aria-live="assertive" aria-atomic="true" style="min-width: 250px;">
        <div class="d-flex">
            <div class="toast-body">
                {{ message }}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                aria-label="Close"></button>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}


<div class="content-wrapper">

    <!-- Content -->
    <div class="container-xxl flex-grow-1 container-p-y">

        <div class="row mb-4">

            <!-- Total Payments -->
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card h-100 shadow-sm border-0">
                    <div class="card-body d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="mb-1">Total Payments</h6>
                            <h4 class="fw-bold text-info">{{total_payments}}</h4>
                        </div>
                        <div class="avatar bg-primary text-white rounded-circle p-2">
                            <i class="bx bx-wallet fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bank Transfer -->
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card h-100 shadow-sm border-0">
                    <div class="card-body d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="mb-1">Bank Transfer</h6>
                            <h4 class="fw-bold text-success">{{bank_transfer_count}}</h4>
                        </div>
                        <div class="avatar bg-info text-white rounded-circle p-2">
                            <i class="bx bx-buildings fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- UPI -->
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card h-100 shadow-sm border-0">
                    <div class="card-body d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="mb-1">UPI</h6>
                            <h4 class="fw-bold text-danger">{{upi_count}}</h4>
                        </div>
                        <div class="avatar bg-success text-white rounded-circle p-2">
                            <i class="bx bx-qr-scan fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cash -->
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card h-100 shadow-sm border-0">
                    <div class="card-body d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="mb-1">Cash</h6>
                            <h4 class="fw-bold">{{cash_count}}</h4>
                        </div>
                        <div class="avatar bg-warning text-white rounded-circle p-2">
                            <i class="bx bx-money fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- All Payment Table -->
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="mb-0">All Payments</h4>
                    <div class="d-flex gap-2">

                        <button type="button" class="btn btn-outline-secondary" title="Filter Payments">
                            <i class="bx bx-filter-alt"></i>
                        </button>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                            data-bs-target="#addPaymentModal">
                            <i class="bx bx-plus"></i> Add Payment
                        </button>
                    </div>
                </div>

                <div class="table-responsive text-nowrap scrollable-table-body">
                    <table class="table" id="paymentTable">
                        <thead>
                            <tr>
                                <th data-sort="number">Sr No.</th>
                                <th data-sort="string">Project ID</th>
                                <th data-sort="string">Project Name</th>
                                <th data-sort="string">Payment Status</th>
                                <th data-sort="number">Remaining Amount</th>
                            </tr>
                        </thead>
                        <tbody class="table-border-bottom-0">
                            {% for row in page_obj %}

                            <tr>

                                <th>{{ forloop.counter }}</th>
                                <td>{{ row.project.project_id }}</td>
                                <td>
                                    <a href="#" data-bs-toggle="modal" data-bs-target="#paymentDetailsModal"
                                        class="fw-bold payment-link" data-project-id="{{ row.project.id }}">
                                        {{ row.project.project_name }}
                                    </a>

                                </td>
                                <td>
                                    {% if row.status == "Paid" %}
                                        <span class="badge bg-label-success">Received</span>
                                    {% elif row.status == "Advanced" %}
                                        <span class="badge bg-label-warning">Advanced</span>
                                    {% else %}
                                        <span class="badge bg-label-danger">Pending</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if row.status == "Advanced" %}
                                        {{ row.remaining_amount|default:"-" }}
                                    {% else %}
                                        -
                                    {% endif %}
                                    </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center">No project payment found.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>





                </div>
                <!-- Records Per Page & Pagination -->
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div class="d-flex align-items-center">
                        <form method="GET" id="recordsForm" class="d-flex align-items-center">
                            <label for="recordsPerPage" class="me-2 mb-0">Records per page:</label>
                            <select class="form-select form-select-sm" name="recordsPerPage" id="recordsPerPage"
                                style="width: auto;">
                                {% for option in records_options %}
                                <option value="{{ option }}" {% if records_per_page == option %}selected{% endif %}>
                                    {{ option }}
                                </option>
                                {% endfor %}
                            </select>
                        </form>
                    </div>

                    <!-- Pagination -->
                    <nav aria-label="Page navigation" class="mt-3">
                        <ul class="pagination justify-content-end mb-0">

                            <!-- Previous Button -->
                            <li class="page-item {% if not page_obj.has_previous %}disabled{% endif %}">
                                {% if page_obj.has_previous %}
                                <a class="page-link"
                                    href="?page={{ page_obj.previous_page_number }}&recordsPerPage={{ records_per_page }}">
                                    <i class="bx bx-chevrons-left"></i>
                                </a>
                                {% else %}
                                <span class="page-link disabled">
                                    <i class="bx bx-chevrons-left"></i>
                                </span>
                                {% endif %}
                            </li>


                            <!-- Always show page 1 -->
                            <li class="page-item {% if page_obj.number == 1 %}active{% endif %}">
                                <a class="page-link" href="?page=1&recordsPerPage={{ records_per_page }}">1</a>
                            </li>

                            <!-- Always show page 2 if exists -->
                            {% if page_obj.paginator.num_pages >= 2 %}
                            <li class="page-item {% if page_obj.number == 2 %}active{% endif %}">
                                <a class="page-link" href="?page=2&recordsPerPage={{ records_per_page }}">2</a>
                            </li>
                            {% endif %}

                            <!-- Ellipsis if there’s a gap before last two pages -->
                            {% if page_obj.paginator.num_pages > 4 %}
                            <li class="page-item disabled"><span class="page-link">…</span></li>
                            {% endif %}

                            <!-- Show second last page only if it's not duplicate of page 2 -->
                            {% if page_obj.paginator.num_pages > 2 and page_obj.paginator.num_pages|add:'-1' != 2 %}
                            <li
                                class="page-item {% if page_obj.number == page_obj.paginator.num_pages|add:'-1' %}active{% endif %}">
                                <a class="page-link"
                                    href="?page={{ page_obj.paginator.num_pages|add:'-1' }}&recordsPerPage={{ records_per_page }}">
                                    {{ page_obj.paginator.num_pages|add:'-1' }}
                                </a>
                            </li>
                            {% endif %}

                            <!-- Show last page only if it's not duplicate of page 2 -->
                            {% if page_obj.paginator.num_pages > 1 and page_obj.paginator.num_pages != 2 %}
                            <li
                                class="page-item {% if page_obj.number == page_obj.paginator.num_pages %}active{% endif %}">
                                <a class="page-link"
                                    href="?page={{ page_obj.paginator.num_pages }}&recordsPerPage={{ records_per_page }}">
                                    {{ page_obj.paginator.num_pages }}
                                </a>
                            </li>
                            {% endif %}

                            <!-- Next Button -->
                            <li class="page-item {% if not page_obj.has_next %}disabled{% endif %}">
                                {% if page_obj.has_next %}
                                <a class="page-link"
                                    href="?page={{ page_obj.next_page_number }}&recordsPerPage={{ records_per_page }}">
                                    <i class="bx bx-chevrons-right"></i>
                                </a>
                                {% else %}
                                <span class="page-link disabled">
                                    <i class="bx bx-chevrons-right"></i>
                                </span>
                                {% endif %}
                            </li>

                        </ul>
                    </nav>
                </div>


            </div>

        </div>


    </div>

<!-- Add Payment Modal -->
<div class="modal fade" id="addPaymentModal" tabindex="-1" aria-labelledby="addPaymentModalLabel" aria-hidden="true"
     data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">

      <div class="modal-header table-primary text-white">
        <h5 class="modal-title" id="addPaymentModalLabel">
          <i class="bx bx-credit-card me-2"></i> Add Payment
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                aria-label="Close"></button>
      </div>

      <form method="POST" action="{% url 'add_payment' %}">
        {% csrf_token %}
        <div class="modal-body px-4 py-3" style="max-height: 70vh; overflow-y: auto;">
          <div class="table-responsive">
            <table class="table table-bordered align-middle">
              <tbody>

                <!-- ==================== Project Selection ==================== -->
                <tr class="table-light">
                  <th colspan="4"><i class="bx bx-briefcase me-2"></i> Project Details</th>
                </tr>
                <tr>
                  <th>Project</th>
                  <td colspan="3">
                    <select class="form-select" name="project">
                      <option value="">-- Select Project --</option>
                      {% for project in projects %}
                        <option value="{{ project.id }}">{{ project.project_name }}</option>
                      {% endfor %}
                    </select>
                  </td>
                </tr>

                <!-- ==================== Payment Information ==================== -->
                <tr class="table-light">
                  <th colspan="4"><i class="bx bx-money me-2"></i> Payment Information</th>
                </tr>
                <tr>
                        <th>Milestone Name</th>
                        <td colspan="3">
                            <input type="text" class="form-control" name="milestone_name"
                                placeholder="Enter milestone name (optional)">
                        </td>
                        </tr>
                <tr>
                  <th>Amount (₹)</th>
                  <td>
                    <input type="number" step="0.01" class="form-control" name="amount"
                           placeholder="Enter payment amount">
                  </td>
                  <th>Payment Date</th>
                  <td>
                    <input type="text" class="form-control flat-date" name="payment_date" 
           placeholder="Select payment date"  >
                  </td>
                </tr>

                <tr>
                  <th>Payment Method</th>
                  <td colspan="3">
                    <select class="form-select" name="payment_method" id="paymentMethod">
                      <option value="">-- Select Method --</option>
                      <option value="Bank Transfer">Bank Transfer</option>
                      <option value="UPI">UPI</option>
                      <option value="Cash">Cash</option>
                      <option value="Cheque">Cheque</option>
                      <option value="Other">Other</option>
                    </select>
                  </td>
                </tr>

                <!-- ==================== Bank Transfer ==================== -->
                <tr id="bankFields" class="d-none">
                  <th>Bank Details</th>
                  <td colspan="3">
                    <input type="text" class="form-control mb-2" name="bank_name" placeholder="Bank Name">
                    <!-- <input type="text" class="form-control mb-2" name="account_no" placeholder="Account Number">
                    <input type="text" class="form-control" name="ifsc_code" placeholder="IFSC Code"> -->
                  </td>
                </tr>

                <!-- ==================== UPI ==================== -->
                <tr id="upiFields" class="d-none">
                  <th>UPI</th>
                  <td colspan="3">
                    <input type="text" class="form-control" name="upi_id" placeholder="UPI ID (example@upi)">
                  </td>
                </tr>

                <!-- ==================== Cheque ==================== -->
                <tr id="chequeFields" class="d-none">
                  <th>Cheque</th>
                  <td colspan="3">
                    <input type="text" class="form-control mb-2" name="cheque_no" placeholder="Cheque Number">
                    <input type="text" class="form-control" name="cheque_name" placeholder="Cheque Holder Name">
                  </td>
                </tr>

                <!-- ==================== Other Details ==================== -->
                <tr id="otherFields" class="d-none">
                  <th>Other Details</th>
                  <td colspan="3">
                    <textarea class="form-control" name="other_details" rows="2"
                              placeholder="Enter additional payment details"></textarea>
                  </td>
                </tr>

              </tbody>
            </table>
          </div>
        </div>

        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Save Payment</button>
        </div>
      </form>

    </div>
  </div>
</div>


<!-- Payment Details Modal -->
<div class="modal fade" id="paymentDetailsModal" tabindex="-1" aria-labelledby="paymentDetailsModalLabel"
     aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">

      <!-- Header -->
      <div class="modal-header table-success text-white">
        <h5 class="modal-title" id="paymentDetailsModalLabel">
          <i class="bx bx-credit-card me-2"></i> Payment Details
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                aria-label="Close"></button>
      </div>

      <!-- Body -->
      <div class="modal-body px-4 py-3">
        <div class="table-responsive">

          <!-- ================= Project Summary ================= -->
          <h6 class="fw-bold mb-3"><i class="bx bx-briefcase me-1"></i> Project Summary</h6>
          <table class="table table-bordered table-sm mb-4">
            <tbody>
              <tr>
                <th>Project ID</th>
                <td id="pd-project-id"></td>
                <th>Project Name</th>
                <td id="pd-project-name"></td>
              </tr>
              <tr>
                <th>Approval Amount</th>
                <td id="pd-approval-amount"></td>
                <th>Received</th>
                <td id="pd-total-paid"></td>
              </tr>
              <tr>
                <th>Remaining Amount</th>
                <td colspan="3" id="pd-remaining-amount"></td>
              </tr>
            </tbody>
          </table>

          <!-- ================= Payment Breakdown ================= -->
          <h6 class="fw-bold mb-3"><i class="bx bx-money me-1"></i> Payment Breakdown</h6>
          <table class="table table-bordered table-striped align-middle">
            <thead class="table-light">
              <tr>
                <th>Milestone</th>
                <th>Amount (₹)</th>
                <th>Payment Date</th>
                <th>Method</th>
                <th>Details</th>
               
              </tr>
            </thead>
            <tbody id="payment-details-body">
              <!-- Filled dynamically -->
             
            </tbody>
          </table>

        </div>
      </div>

    </div>
  </div>
</div>



    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmLabel"
        aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content text-center">
                <div class="modal-header border-0">
                    <h5 class="modal-title w-100" id="deleteConfirmLabel">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this project?
                </div>
                <div class="modal-footer justify-content-center border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                </div>
            </div>
        </div>
    </div>

    

</div>
{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="{% static 'js/common.js' %}"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {

         // searching
    enableTableSearch("searchBox", "paymentTable");
    // sorting
    
    enableTableSorting("paymentTable");
   


        // Payment Modal Dynamic Fields
        const methodSelect = document.getElementById("paymentMethod");
        const bankFields = document.getElementById("bankFields");
        const upiFields = document.getElementById("upiFields");
        const chequeFields = document.getElementById("chequeFields");
        const otherFields = document.getElementById("otherFields");

        methodSelect.addEventListener("change", function () {
            // hide all first
            bankFields.classList.add("d-none");
            upiFields.classList.add("d-none");
            chequeFields.classList.add("d-none");
            otherFields.classList.add("d-none");

            if (this.value === "Bank Transfer") bankFields.classList.remove("d-none");
            if (this.value === "UPI") upiFields.classList.remove("d-none");
            if (this.value === "Cheque") chequeFields.classList.remove("d-none");
            if (this.value === "Other") otherFields.classList.remove("d-none");
        });

        // Payment Details Modal Population
const paymentDetailsUrl = "{% url 'get_payment' %}";

$(document).on("click", ".payment-link", function (e) {
    e.preventDefault();
    const projectId = $(this).data("project-id");
    console.log("Fetching details for payment ID:", projectId);

    $.get(paymentDetailsUrl, { id: projectId }, function (res) {
        if (!res.success) {
            console.error("Failed:", res.error);
            return;
        }

        const project = res.data;

        // === Fill project summary ===
        $("#pd-project-id").text(project.project_id);
        $("#pd-project-name").text(project.project_name);

        $("#pd-approval-amount")
            .text(`₹${project.approval_amount}`)
            .addClass("text-primary fw-bold");

        $("#pd-total-paid")
            .text(`₹${project.total_paid}`)
            .addClass("text-success fw-bold");

        $("#pd-remaining-amount")
  .text(
    project.remaining_amount === "-" || project.remaining_amount === null
      ? "-" 
      : `₹${project.remaining_amount}`
  )
  .addClass("text-danger fw-bold");


        // === Clear existing rows ===
        const tbody = $("#payment-details-body");
        tbody.empty();

        // === Fill payments as table rows ===
        project.payments.forEach((p) => {
            let extraDetails = "";

            if (p.method === "Bank Transfer") {
                extraDetails = `
                    <strong>Bank:</strong> ${p.details.bank_name || ""}<br>
                    `;
                    // <strong>Acc:</strong> ${p.details.account_no || ""}<br>
                    // <strong>IFSC:</strong> ${p.details.ifsc_code || ""}
            } else if (p.method === "UPI") {
                extraDetails = `<strong>UPI:</strong> ${p.details.upi_id || ""}`;
            } else if (p.method === "Cheque") {
                extraDetails = `
                    <strong>Cheque No:</strong> ${p.details.cheque_no || ""}<br>
                    <strong>Name:</strong> ${p.details.cheque_name || ""}
                `;
            } else if (p.method === "Other") {
                extraDetails = `<strong>Details:</strong> ${p.details.other_details || ""}`;
            }

            tbody.append(`
                <tr>
                    <td>${p.milestone || "-"}</td>
                    <td class="text-success fw-bold">₹${p.amount}</td>
                    <td>${formatDate(p.date)}</td>
                     
                    <td>${p.method}</td>
                    <td>${extraDetails || "-"}</td>
                </tr>
            `);
        });

        // Show modal
        $("#paymentDetailsModal").modal("show");
    });
});


// add

    const addPaymentForm = document.querySelector("#addPaymentModal form");

    addPaymentForm.addEventListener("submit", function (e) {
        e.preventDefault();

        let form = this;
        let formData = new FormData(form);

        fetch("{% url 'add_payment' %}", {
            method: "POST",
            body: formData,
            headers: {
                "X-Requested-With": "XMLHttpRequest",
                "X-CSRFToken": form.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(res => res.json())
        .then(data => {
            // Clear old validation errors
            form.querySelectorAll(".is-invalid").forEach(el => el.classList.remove("is-invalid"));

            if (data.success) {
                // Close modal
                let modalEl = document.getElementById("addPaymentModal");
                let modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();

                // Show success toast
                showToast(data.message || "Payment added successfully!", "success");

                // Reload after short delay
                setTimeout(() => window.location.reload(), 800);
            } else {
                if (data.errors) {
                    if (data.errors["__all__"]) {
                        showToast(data.errors["__all__"].join(", "), "danger");
                    } else {
                        // Highlight fields with errors
                        Object.keys(data.errors).forEach(field => {
                            let input = form.querySelector(`[name="${field}"]`);
                            if (input) {
                                input.classList.add("is-invalid");
                            }
                        });
                        showToast("Please fix highlighted errors.", "danger");
                    }
                } else {
                    showToast("Something went wrong while saving payment.", "danger");
                }
            }
        })
        .catch(err => {
            console.error("Error:", err);
            showToast("Unexpected error while adding payment.", "danger");
        });
    });
    
    });
</script>
{% endblock %}
{% endblock %}
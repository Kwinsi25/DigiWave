{% extends "base.html" %}
{% block title %}All Technologies{% endblock %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

{% block content %}
{% if messages %}
<div id="toast-container" style="
    position: fixed; top:20px; right:20px; z-index:3000;
    display:flex; flex-direction:column; gap:10px;">
  {% for message in messages %}
  <div class="toast align-items-center text-white bg-{{ message.tags }} border-0 show" role="alert">
    <div class="d-flex">
      <div class="toast-body">{{ message }}</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
  {% endfor %}
</div>
{% endif %}

<div class="content-wrapper">
  <div class="container-xxl flex-grow-1 container-p-y">

    <!-- Stats Cards -->
    <div class="row mb-4">
      <div class="col-md-3 col-sm-6 mb-3">
        <div class="card h-100 shadow-sm border-0">
          <div class="card-body d-flex justify-content-between align-items-center">
            <div>
              <h6 class="mb-1">Total Technologies</h6>
              <h4 class="fw-bold text-primary">{{ total_technologies }}</h4>
            </div>
            <div class="avatar bg-primary text-white rounded-circle p-2">
              <i class="bx bx-cog"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Technologies Table -->
    <div class="card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4 class="mb-0">All Technologies</h4>
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTechnologyModal">
            <i class="bx bx-plus"></i> Add Technology
          </button>
        </div>

        <div class="table-responsive text-nowrap scrollable-table-body">
          <table class="table" id="technologyTable">
            <thead>
              <tr>
                <th>Sr No.</th>
                <th>Name</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for tech in page_obj %}
              <tr>
                <td>{{ forloop.counter0|add:page_obj.start_index }}</td>
                <td>{{ tech.name }}</td>
                <td>
                  <a href="#" class="text-primary me-2 edit-technology" data-technology-id="{{ tech.id }}"><i class="bx bx-edit-alt"></i></a>
                  <a href="#" class="text-danger delete-technology" data-technology-id="{{ tech.id }}"><i class="bx bx-trash"></i></a>
                </td>
              </tr>
              {% empty %}
              <tr id="noTechnologyRow">
                <td colspan="3" class="text-center">No technology found.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Pagination (same logic as designation page) -->
        <div class="d-flex justify-content-between align-items-center mt-3">
          <div class="d-flex align-items-center">
            <form method="GET" id="recordsForm" class="d-flex align-items-center">
              <label for="recordsPerPage" class="me-2 mb-0">Records per page:</label>
              <select class="form-select form-select-sm" name="recordsPerPage" id="recordsPerPage" style="width: auto;">
                {% for option in records_options %}
                <option value="{{ option }}" {% if records_per_page == option %}selected{% endif %}>
                  {{ option }}
                </option>
                {% endfor %}
              </select>
            </form>
          </div>
          <!-- Reuse pagination code here -->
          <nav aria-label="Page navigation" class="mt-3">
            <ul class="pagination justify-content-end mb-0">
              <!-- Previous -->
              <li class="page-item {% if not page_obj.has_previous %}disabled{% endif %}">
                {% if page_obj.has_previous %}
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}&recordsPerPage={{ records_per_page }}">
                  <i class="bx bx-chevrons-left"></i>
                </a>
                {% else %}
                <span class="page-link disabled"><i class="bx bx-chevrons-left"></i></span>
                {% endif %}
              </li>
              <!-- First page -->
              <li class="page-item {% if page_obj.number == 1 %}active{% endif %}">
                <a class="page-link" href="?page=1&recordsPerPage={{ records_per_page }}">1</a>
              </li>
              {% if page_obj.paginator.num_pages >= 2 %}
              <li class="page-item {% if page_obj.number == 2 %}active{% endif %}">
                <a class="page-link" href="?page=2&recordsPerPage={{ records_per_page }}">2</a>
              </li>
              {% endif %}
              {% if page_obj.paginator.num_pages > 4 %}
              <li class="page-item disabled"><span class="page-link">â€¦</span></li>
              {% endif %}
              {% if page_obj.paginator.num_pages > 2 and page_obj.paginator.num_pages|add:'-1' != 2 %}
              <li class="page-item {% if page_obj.number == page_obj.paginator.num_pages|add:'-1' %}active{% endif %}">
                <a class="page-link" href="?page={{ page_obj.paginator.num_pages|add:'-1' }}&recordsPerPage={{ records_per_page }}">
                  {{ page_obj.paginator.num_pages|add:'-1' }}
                </a>
              </li>
              {% endif %}
              {% if page_obj.paginator.num_pages > 1 and page_obj.paginator.num_pages != 2 %}
              <li class="page-item {% if page_obj.number == page_obj.paginator.num_pages %}active{% endif %}">
                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}&recordsPerPage={{ records_per_page }}">
                  {{ page_obj.paginator.num_pages }}
                </a>
              </li>
              {% endif %}
              <!-- Next -->
              <li class="page-item {% if not page_obj.has_next %}disabled{% endif %}">
                {% if page_obj.has_next %}
                <a class="page-link" href="?page={{ page_obj.next_page_number }}&recordsPerPage={{ records_per_page }}">
                  <i class="bx bx-chevrons-right"></i>
                </a>
                {% else %}
                <span class="page-link disabled"><i class="bx bx-chevrons-right"></i></span>
                {% endif %}
              </li>
            </ul>
          </nav>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- Add Technology Modal -->
<div class="modal fade" id="addTechnologyModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header table-primary text-white">
        <h5 class="modal-title"><i class="bx bx-cog me-2"></i> Add Technology</h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form id="addTechnologyForm" method="POST" action="{% url 'add_technology' %}">
        {% csrf_token %}
        <div class="modal-body">
          <table class="table table-bordered">
            <tbody>
              <tr>
                <th>Name</th>
                <td><input class="form-control" name="name" maxlength="100" required placeholder="Technology Name"></td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" type="submit">Save Technology</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Technology Modal -->
<div class="modal fade" id="editTechnologyModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header table-warning text-dark">
        <h5 class="modal-title"><i class="bx bx-edit-alt me-2"></i> Edit Technology</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="editTechnologyForm" method="POST" action="{% url 'update_technology' %}">
        {% csrf_token %}
        <input type="hidden" name="id" id="edit-technology-id">
        <div class="modal-body">
          <table class="table table-bordered">
            <tbody>
              <tr>
                <th>Name</th>
                <td><input class="form-control" name="name" id="edit-name" required placeholder="Technology Name"></td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" type="submit">Update Technology</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Technology Modal -->
<div class="modal fade" id="deleteTechnologyModal" tabindex="-1" aria-labelledby="deleteTechnologyLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center">
      <div class="modal-header border-0">
        <h5 class="modal-title w-100" id="deleteTechnologyLabel">Confirm Delete</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this Technology?
      </div>
      <div class="modal-footer justify-content-center border-0">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteTechnologyBtn">Delete</button>
      </div>
    </div>
  </div>
</div>

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {

  // ------------------ Records per page ------------------
  document.getElementById('recordsPerPage').addEventListener('change', function () {
    const form = document.getElementById('recordsForm');
    const hiddenPage = document.createElement('input');
    hiddenPage.type = 'hidden';
    hiddenPage.name = 'page';
    hiddenPage.value = 1;
    form.appendChild(hiddenPage);
    form.submit();
  });

  // ------------------ Toast Function ------------------
  function showToast(message, type = "info") {
      const container = document.getElementById("toast-container") || (() => {
          const div = document.createElement("div");
          div.id = "toast-container";
          div.style.position = "fixed";
          div.style.top = "20px";
          div.style.right = "20px";
          div.style.zIndex = "3000";
          div.style.display = "flex";
          div.style.flexDirection = "column";
          div.style.gap = "10px";
          document.body.appendChild(div);
          return div;
      })();

      const toast = document.createElement("div");
      toast.className = `toast align-items-center text-white bg-${type} border-0 show`;
      toast.style.minWidth = "250px";
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      `;

      container.appendChild(toast);

      setTimeout(() => {
          toast.style.transition = "opacity 0.5s ease, transform 0.5s ease";
          toast.style.opacity = "0";
          toast.style.transform = "translateX(100%)";
          setTimeout(() => toast.remove(), 500);
      }, 3000);
  }

  const toasts = document.querySelectorAll('#toast-container .toast');
  toasts.forEach(function (toast) {
      setTimeout(() => {
          toast.style.transition = "opacity 0.5s ease, transform 0.5s ease";
          toast.style.opacity = "0";
          toast.style.transform = "translateX(100%)";
          setTimeout(() => toast.remove(), 500);
      }, 3000);
  });

  // ------------------ Edit Technology ------------------
  $(document).on("click", ".edit-technology", function () {
    const id = $(this).data("technology-id");
    if (!id) { showToast("Invalid technology ID", "danger"); return; }

    fetch(`/get_technology/?id=${id}`, { headers: { "X-Requested-With": "XMLHttpRequest" } })
      .then(res => res.json())
      .then(data => {
        if (!data.id) { showToast("Error fetching technology data", "danger"); return; }
        document.getElementById("edit-technology-id").value = data.id;
        document.getElementById("edit-name").value = data.name;
        const editModal = bootstrap.Modal.getOrCreateInstance(document.getElementById("editTechnologyModal"));
        editModal.show();
      })
      .catch(err => showToast("Error fetching technology data", "danger"));
  });

  // ------------------ Delete Technology ------------------
  let techIdToDelete = null;
  $(document).on("click", ".delete-technology", function () {
    techIdToDelete = $(this).data("technology-id");
    if (!techIdToDelete) { showToast("Invalid technology ID", "danger"); return; }
    bootstrap.Modal.getOrCreateInstance(document.getElementById("deleteTechnologyModal")).show();
  });

  $("#confirmDeleteTechnologyBtn").click(function () {
    if (!techIdToDelete) return;
    $.ajax({
      url: `/delete_technology/${techIdToDelete}/`,
      type: "POST",
      data: { csrfmiddlewaretoken: "{{ csrf_token }}" },
      success: function(res) {
        if(res.success){ showToast(res.message, "success"); setTimeout(() => window.location.reload(), 800); }
        else{ showToast(res.error, "danger"); }
      },
      error: function() { showToast("Unexpected error deleting technology", "danger"); }
    });
    bootstrap.Modal.getOrCreateInstance(document.getElementById("deleteTechnologyModal")).hide();
  });

});
</script>
{% endblock %}

{% endblock %}

{% extends "base.html" %}
{% block title %}Files & Docs{% endblock %}

{% block extra_css %}
<style>
    .scrollable-table-body {
        max-height: 400px;
        overflow-y: auto;
    }

    .scrollable-table-body table {
        margin-bottom: 0;
    }

    .scrollable-table-body thead th {
        position: sticky;
        top: 0;
        background: #fff;
        z-index: 1;
    }
</style>
{% endblock %}

{% block content %}
<div class="content-wrapper">
    <div class="container-xxl flex-grow-1 container-p-y">

        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card h-100 shadow-sm border-0">
                    <div class="card-body d-flex align-items-center justify-content-between">
                        <div>
                            <h6>Total Projects</h6>
                            <h4 class="fw-bold text-primary">{{ total_projects }}</h4>
                        </div>
                        <div class="avatar bg-primary text-white rounded-circle p-2"><i class="bx bx-folder fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card h-100 shadow-sm border-0">
                    <div class="card-body d-flex align-items-center justify-content-between">
                        <div>
                            <h6>Total Folders</h6>
                            <h4 class="fw-bold text-success">{{ total_folders }}</h4>
                        </div>
                        <div class="avatar bg-success text-white rounded-circle p-2"><i class="bx bx-archive fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card h-100 shadow-sm border-0">
                    <div class="card-body d-flex align-items-center justify-content-between">
                        <div>
                            <h6>Total Files</h6>
                            <h4 class="fw-bold text-warning">{{ total_files }}</h4>
                        </div>
                        <div class="avatar bg-warning text-white rounded-circle p-2"><i class="bx bx-file fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card h-100 shadow-sm border-0">
                    <div class="card-body d-flex align-items-center justify-content-between">
                        <div>
                            <h6>Recent Upload</h6>
                            <h6 class="fw-bold text-danger">{{ recent_file_name }}</h6>
                        </div>
                        <div class="avatar bg-danger text-white rounded-circle p-2"><i class="bx bx-upload fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Folder Table -->
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4>All Folders</h4>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addFileModal">
                        <i class="bx bx-plus"></i> Add Files
                    </button>
                </div>

                <!-- <div class="table-responsive text-nowrap scrollable-table-body">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Sr No.</th>
                                <th>Project Id</th>
                                <th>Project Name</th>
                                <th>Folder Name</th>
                                <th>File Count</th>
                                <th>Recent File</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in page_obj %}
                            <tr>
                                <td>{{ forloop.counter0|add:page_obj.start_index }}</td>
                                <td>{{ row.project_id }}</td>
                                <td>
                                    {% if row.project_db_id %}

                                    {{ row.project_name }}
                                    {% else %}
                                    No Project
                                    {% endif %}
                                </td>

                                <td>
                                    {% if row.folder_list %}
                                    {% for folder in row.folder_list %}
                                    <a href="javascript:void(0);" class="text-primary view-folder"
                                        data-folder-id="{{ folder.id }}">
                                        {{ folder.name }}
                                    </a><br>
                                    {% endfor %}
                                    {% else %}
                                    No Folders
                                    {% endif %}
                                </td>

                                <td>{{ row.file_count }}</td>
                                <td>{{ row.last_file_name }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>

                    </table>

                </div> -->
                <div class="row g-3">
                    {% for folder in page_obj %}
                    <div class="col-md-2 col-sm-4 col-6">
                        <div class="card folder-card text-center position-relative"
                            style="border-radius: 18px; overflow:hidden; cursor:pointer;">

                            <!-- Glassmorphism File Count Badge -->
                            <span class="position-absolute top-0 end-0 m-2 px-2 py-1 rounded-pill" style="backdrop-filter: blur(8px); background: rgba(99,102,241,0.8); 
                             color: white; font-size: 0.7rem; font-weight: 600;">
                                {{ folder.file_count }}
                            </span>

                            <div class="card-body p-3">
                                <!-- Folder Icon in gradient circle -->
                                <div class="d-flex justify-content-center align-items-center mx-auto mb-2" style="width:75px; height:75px; border-radius:50%;
                                background: linear-gradient(135deg, #fde68a, #f59e0b20);">
                                    <i class="bx bxs-folder" style="font-size:38px; color:#f59e0b;"></i>
                                </div>

                                <!-- Folder Name -->
                                <h6 class="mt-2 mb-1 text-truncate" style="max-width:100%;">
                                    <a href="javascript:void(0);"
                                        class="stretched-link text-decoration-none text-dark fw-semibold view-folder"
                                        data-folder-id="{{ folder.id }}">
                                        {{ folder.name }}
                                    </a>
                                </h6>

                                <!-- Created Date -->
                                <small class="text-muted d-block">
                                    {{ folder.created_at|date:"M j, Y" }}
                                </small>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="col-12 text-center text-muted">No Folders</div>
                    {% endfor %}
                </div>

                <style>
                    /* Hover animation */
                    .folder-card {
                        transition: transform 0.2s ease, box-shadow 0.2s ease;
                    }

                    .folder-card:hover {
                        transform: translateY(-6px);
                        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
                    }
                </style>




                <!-- pagination -->
                <div class="d-flex justify-content-between align-items-center mt-3">

                    <!-- Records Per Page Dropdown -->
                    <div class="d-flex align-items-center">
                        <form method="GET" id="recordsForm" class="d-flex align-items-center">
                            <label for="recordsPerPage" class="me-2 mb-0">Records per page:</label>
                            <select class="form-select form-select-sm" name="recordsPerPage" id="recordsPerPage"
                                style="width: auto;">
                                {% for option in records_options %}
                                <option value="{{ option }}" {% if records_per_page == option %}selected{% endif %}>
                                    {{ option }}
                                </option>
                                {% endfor %}
                            </select>
                        </form>
                    </div>

                    <!-- Pagination -->
                    <nav aria-label="Page navigation" class="mt-3">
                        <ul class="pagination justify-content-end mb-0">

                            <!-- Previous Button -->
                            <li class="page-item {% if not page_obj.has_previous %}disabled{% endif %}">
                                {% if page_obj.has_previous %}
                                <a class="page-link"
                                    href="?page={{ page_obj.previous_page_number }}&recordsPerPage={{ records_per_page }}">
                                    <i class="bx bx-chevrons-left"></i>
                                </a>
                                {% else %}
                                <span class="page-link disabled">
                                    <i class="bx bx-chevrons-left"></i>
                                </span>
                                {% endif %}
                            </li>

                            <!-- Always show first page -->
                            <li class="page-item {% if page_obj.number == 1 %}active{% endif %}">
                                <a class="page-link" href="?page=1&recordsPerPage={{ records_per_page }}">1</a>
                            </li>

                            <!-- Show second page if exists -->
                            {% if page_obj.paginator.num_pages >= 2 %}
                            <li class="page-item {% if page_obj.number == 2 %}active{% endif %}">
                                <a class="page-link" href="?page=2&recordsPerPage={{ records_per_page }}">2</a>
                            </li>
                            {% endif %}

                            <!-- Ellipsis -->
                            {% if page_obj.paginator.num_pages > 4 %}
                            <li class="page-item disabled"><span class="page-link">…</span></li>
                            {% endif %}

                            <!-- Second last page (if not duplicate of 2) -->
                            {% if page_obj.paginator.num_pages > 2 and page_obj.paginator.num_pages|add:'-1' != 2 %}
                            <li
                                class="page-item {% if page_obj.number == page_obj.paginator.num_pages|add:'-1' %}active{% endif %}">
                                <a class="page-link"
                                    href="?page={{ page_obj.paginator.num_pages|add:'-1' }}&recordsPerPage={{ records_per_page }}">
                                    {{ page_obj.paginator.num_pages|add:'-1' }}
                                </a>
                            </li>
                            {% endif %}

                            <!-- Last page (if not duplicate of 2) -->
                            {% if page_obj.paginator.num_pages > 1 and page_obj.paginator.num_pages != 2 %}
                            <li
                                class="page-item {% if page_obj.number == page_obj.paginator.num_pages %}active{% endif %}">
                                <a class="page-link"
                                    href="?page={{ page_obj.paginator.num_pages }}&recordsPerPage={{ records_per_page }}">
                                    {{ page_obj.paginator.num_pages }}
                                </a>
                            </li>
                            {% endif %}

                            <!-- Next Button -->
                            <li class="page-item {% if not page_obj.has_next %}disabled{% endif %}">
                                {% if page_obj.has_next %}
                                <a class="page-link"
                                    href="?page={{ page_obj.next_page_number }}&recordsPerPage={{ records_per_page }}">
                                    <i class="bx bx-chevrons-right"></i>
                                </a>
                                {% else %}
                                <span class="page-link disabled">
                                    <i class="bx bx-chevrons-right"></i>
                                </span>
                                {% endif %}
                            </li>

                        </ul>
                    </nav>
                </div>

                <script>
                    document.getElementById('recordsPerPage').addEventListener('change', function () {
                        const form = document.getElementById('recordsForm');
                        const hiddenPage = document.createElement('input');
                        hiddenPage.type = 'hidden';
                        hiddenPage.name = 'page';
                        hiddenPage.value = 1;
                        form.appendChild(hiddenPage);
                        form.submit();
                    });
                </script>
            </div>
        </div>

        <!-- Add File Modal -->
        <div class="modal fade" id="addFileModal" tabindex="-1" aria-labelledby="addFileModalLabel" aria-hidden="true"
            data-bs-backdrop="static" data-bs-keyboard="false">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header table-primary text-white">
                        <h5 class="modal-title" id="addFileModalLabel"><i class="bx bx-plus me-2"></i> Add New File</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>

                    <form id="addFileForm" method="POST" enctype="multipart/form-data" action="{% url 'add_file' %}">
                        {% csrf_token %}
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="projectSelect" class="form-label">Select Project (Optional)</label>
                                <select class="form-select" id="projectSelect" name="project">
                                    <option value="">-- No Project --</option>
                                    {% for project in all_projects %}
                                    <option value="{{ project.id }}">{{ project.project_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="folderSelect" class="form-label">Select Folder</label>
                                <select class="form-select" id="folderSelect" name="folder" required>
                                    <option value="">-- Select Folder --</option>
                                    {% for folder in all_folders %}
                                    <option value="{{ folder.id }}" data-project="{{ folder.project.id|default:'' }}">
                                        {{ folder.name }}
                                        {% if folder.project %}
                                        ({{ folder.project.project_name }} - {{ folder.project.project_id }})
                                        {% else %}
                                        (No Project)
                                        {% endif %}
                                    </option>
                                    {% endfor %}
                                </select>

                                <button type="button" class="btn btn-sm btn-outline-primary mt-2"
                                    onclick="new bootstrap.Modal(document.getElementById('addFolderModal')).show()">➕
                                    Create New Folder</button>
                            </div>

                            <div class="mb-3">
                                <label for="fileInput" class="form-label">Select File(s)</label>
                                <input type="file" class="form-control" id="fileInput" name="files" multiple required>
                            </div>
                        </div>

                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary">Upload Files</button>
                        </div>
                    </form>
                    <script>
                        function showToast(message, type = "info") {
                            const container = document.getElementById("toast-container") || (() => {
                                const div = document.createElement("div");
                                div.id = "toast-container";
                                div.style.position = "fixed";
                                div.style.top = "20px";
                                div.style.right = "20px";
                                div.style.zIndex = "3000";
                                div.style.display = "flex";
                                div.style.flexDirection = "column";
                                div.style.gap = "10px";
                                document.body.appendChild(div);
                                return div;
                            })();

                            const toast = document.createElement("div");
                            toast.className = `toast align-items-center text-white bg-${type} border-0 show`;
                            toast.style.minWidth = "250px";
                            toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    `;

                            container.appendChild(toast);

                            setTimeout(() => {
                                toast.style.transition = "opacity 0.5s ease, transform 0.5s ease";
                                toast.style.opacity = "0";
                                toast.style.transform = "translateX(100%)";
                                setTimeout(() => toast.remove(), 500);
                            }, 3000);
                        }

                        function filterFolders() {
                            const projectSelect = document.getElementById("projectSelect");
                            const folderSelect = document.getElementById("folderSelect");

                            if (!projectSelect || !folderSelect) return;

                            const selectedProjectId = projectSelect.value;

                            Array.from(folderSelect.options).forEach(option => {
                                if (!option.value) return; // skip placeholder
                                const folderProjectId = option.getAttribute("data-project") || "";

                                if (!selectedProjectId && !folderProjectId) {
                                    option.style.display = "";
                                } else if (selectedProjectId && folderProjectId === selectedProjectId) {
                                    option.style.display = "";
                                } else {
                                    option.style.display = "none";
                                }
                            });

                            folderSelect.value = "";
                        }

                        // -----------------------------
                        //Bind Events
                        // -----------------------------
                        document.addEventListener("DOMContentLoaded", filterFolders);
                        document.getElementById("projectSelect")?.addEventListener("change", filterFolders);

                        // Also when modal is opened
                        document.getElementById("addFileModal")?.addEventListener("show.bs.modal", filterFolders);


                        // Filter folders by project
                        document.getElementById("projectSelect").addEventListener("change", function () {
                            const selectedProjectId = this.value; // string
                            const folderSelect = document.getElementById("folderSelect");

                            Array.from(folderSelect.options).forEach(option => {
                                if (!option.value) return; // skip placeholder
                                const folderProjectId = option.getAttribute("data-project") || "";

                                // Case 1: No project selected -> show only folders with no project
                                if (!selectedProjectId && !folderProjectId) {
                                    option.style.display = "";
                                }
                                // Case 2: Project selected -> show only folders with same project_id
                                else if (selectedProjectId && folderProjectId === selectedProjectId) {
                                    option.style.display = "";
                                }
                                else {
                                    option.style.display = "none";
                                }
                            });

                            folderSelect.value = "";
                        });


                        // Upload files
                        document.getElementById("addFileForm").addEventListener("submit", function (e) {
                            e.preventDefault();
                            const form = new FormData(this);

                            fetch("{% url 'add_file' %}", { method: "POST", body: form })
                                .then(res => res.json())
                                .then(data => {
                                    if (data.success) {
                                        showToast("Files uploaded successfully!", "success");
                                        bootstrap.Modal.getInstance(document.getElementById("addFileModal")).hide();
                                        setTimeout(() => window.location.reload(), 1000);
                                    } else { showToast(data.error || "Upload failed!", "danger"); }
                                }).catch(() => showToast("Error uploading files", "danger"));
                        });
                    </script>
                </div>
            </div>
        </div>

        <!-- Add Folder Modal -->
        <div class="modal fade" id="addFolderModal" tabindex="-1" aria-labelledby="addFolderModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content text-center">
                    <div class="modal-header border-0">
                        <h5 class="modal-title w-100" id="addFolderModalLabel">Create New Folder</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

                        <input type="text" id="newFolderName" class="form-control" placeholder="Enter folder name">
                    </div>
                    <div class="modal-footer justify-content-center border-0">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="confirmAddFolderBtn">Create Folder</button>
                    </div>
                    <script>
                        function showToast(message, type = "info") {
                            const container = document.getElementById("toast-container") || (() => {
                                const div = document.createElement("div");
                                div.id = "toast-container";
                                div.style.position = "fixed";
                                div.style.top = "20px";
                                div.style.right = "20px";
                                div.style.zIndex = "3000";
                                div.style.display = "flex";
                                div.style.flexDirection = "column";
                                div.style.gap = "10px";
                                document.body.appendChild(div);
                                return div;
                            })();

                            const toast = document.createElement("div");
                            toast.className = `toast align-items-center text-white bg-${type} border-0 show`;
                            toast.style.minWidth = "250px";
                            toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    `;

                            container.appendChild(toast);

                            setTimeout(() => {
                                toast.style.transition = "opacity 0.5s ease, transform 0.5s ease";
                                toast.style.opacity = "0";
                                toast.style.transform = "translateX(100%)";
                                setTimeout(() => toast.remove(), 500);
                            }, 3000);
                        }

                        function filterFolders() {
                            const projectSelect = document.getElementById("projectSelect");
                            const folderSelect = document.getElementById("folderSelect");

                            if (!projectSelect || !folderSelect) return;

                            const selectedProjectId = projectSelect.value;

                            Array.from(folderSelect.options).forEach(option => {
                                if (!option.value) return; // skip placeholder
                                const folderProjectId = option.getAttribute("data-project") || "";

                                if (!selectedProjectId && !folderProjectId) {
                                    option.style.display = "";
                                } else if (selectedProjectId && folderProjectId === selectedProjectId) {
                                    option.style.display = "";
                                } else {
                                    option.style.display = "none";
                                }
                            });

                            folderSelect.value = "";
                        }

                        // -----------------------------
                        // 🔹 Bind Events
                        // -----------------------------
                        document.addEventListener("DOMContentLoaded", filterFolders);
                        document.getElementById("projectSelect")?.addEventListener("change", filterFolders);

                        // Also when modal is opened
                        document.getElementById("addFileModal")?.addEventListener("show.bs.modal", filterFolders);

                        // Filter folders by project
                        document.getElementById("projectSelect").addEventListener("change", function () {
                            const selectedProjectId = this.value; // string
                            const folderSelect = document.getElementById("folderSelect");

                            Array.from(folderSelect.options).forEach(option => {
                                if (!option.value) return; // skip placeholder
                                const folderProjectId = option.getAttribute("data-project") || "";

                                // Case 1: No project selected -> show only folders with no project
                                if (!selectedProjectId && !folderProjectId) {
                                    option.style.display = "";
                                }
                                // Case 2: Project selected -> show only folders with same project_id
                                else if (selectedProjectId && folderProjectId === selectedProjectId) {
                                    option.style.display = "";
                                }
                                else {
                                    option.style.display = "none";
                                }
                            });

                            folderSelect.value = "";
                        });


                        // Create folder
                        document.getElementById("confirmAddFolderBtn").addEventListener("click", function () {
                            const folderName = document.getElementById("newFolderName").value.trim();
                            const projectId = document.getElementById("projectSelect").value || null;

                            if (!folderName) {
                                showToast("Folder name is required!", "warning");
                                setTimeout(() => window.location.reload(), 1000);
                                return;
                            }

                            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                            fetch("{% url 'create_folder' %}", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    "X-CSRFToken": csrftoken
                                },
                                body: JSON.stringify({ name: folderName, project_id: projectId })
                            })
                                .then(res => res.json())
                                .then(data => {
                                    if (data.success) {
                                        const folderSelect = document.getElementById("folderSelect");
                                        const option = document.createElement("option");
                                        option.value = data.folder_id;
                                        option.setAttribute("data-project", projectId || "");
                                        option.text = data.folder_name + (data.project_name ? ` (${data.project_name})` : '');
                                        folderSelect.add(option);
                                        folderSelect.value = data.folder_id;

                                        showToast("Folder created successfully!", "success");

                                        bootstrap.Modal.getInstance(document.getElementById("addFolderModal")).hide();

                                        document.getElementById("newFolderName").value = "";
                                    } else {
                                        showToast(data.error, "danger");
                                    }
                                })
                                .catch(() => showToast("Error creating folder", "danger"));
                        });

                    </script>
                </div>
            </div>
        </div>

        <!-- detail view -->

        <div class="modal fade" id="viewProjectModal" tabindex="-1" tabindex="-1" aria-hidden="true"
            data-bs-backdrop="static" data-bs-keyboard="false">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header table-info text-white">
                        <h5 class="modal-title"><i class="bx bx-folder me-2"></i> Folder Details</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                    </div>
                    <div class="modal-body">

                        <p><b>Folder Name :</b> <span id="projectTitle"></span></p>
                        <p><b>Project Name :</b> <span id="projectId"></span></p>


                        <hr>
                        <h6>Files</h6>
                        <div id="projectFolders"></div>
                    </div>
                    <script>
                        function showToast(message, type = "info") {
                            const container = document.getElementById("toast-container") || (() => {
                                const div = document.createElement("div");
                                div.id = "toast-container";
                                div.style.position = "fixed";
                                div.style.top = "20px";
                                div.style.right = "20px";
                                div.style.zIndex = "3000";
                                div.style.display = "flex";
                                div.style.flexDirection = "column";
                                div.style.gap = "10px";
                                document.body.appendChild(div);
                                return div;
                            })();

                            const toast = document.createElement("div");
                            toast.className = `toast align-items-center text-white bg-${type} border-0 show`;
                            toast.style.minWidth = "250px";
                            toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    `;

                            container.appendChild(toast);

                            setTimeout(() => {
                                toast.style.transition = "opacity 0.5s ease, transform 0.5s ease";
                                toast.style.opacity = "0";
                                toast.style.transform = "translateX(100%)";
                                setTimeout(() => toast.remove(), 500);
                            }, 3000);
                        }

                        function getFileExtension(filename) {
                            return filename.split('.').pop().toLowerCase();
                        }

                        document.addEventListener("click", function (e) {
                            if (e.target.classList.contains("view-folder")) {
                                const folderId = e.target.getAttribute("data-folder-id");

                                fetch(`/get_files/?id=${folderId}`)
                                    .then(res => res.json())
                                    .then(data => {
                                        document.getElementById("projectTitle").innerText = data.name;

                                        document.getElementById("projectId").innerText = data.project;


                                        const container = document.getElementById("projectFolders");
                                        container.innerHTML = "";
                                        if (data.files.length) {
                                            container.innerHTML = `
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <div>
                                                        <input type="checkbox" id="selectAll" class="form-check-input me-2">
                                                        <label for="selectAll" class="fw-bold">Select All</label>
                                                    </div>
                                                    <button id="deleteSelectedBtn" class="btn btn-danger btn-sm" disabled>
                                                        <i class="bx bx-trash"></i> Delete Selected
                                                    </button>
                                                </div>
                                                <ul class="list-group">
                                                    ${data.files.map(f => `
                                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                                            <div class="d-flex align-items-center">
                                                                <input type="checkbox" class="form-check-input me-2 file-checkbox" value="${f.id}">
                                                                <div class="d-flex flex-column">
                                                                    <span class="fw-bold">${f.name}</span>
                                                                    <small class="text-muted">Added: ${f.created_at}</small>
                                                                </div>
                                                            </div>
                                                            <div class="btn-group">
                                                                ${f.file_url ? `<button class="btn btn-sm btn-primary view-file" data-url="${f.file_url}" title="View"><i class="bx bx-show"></i></button>` : ''}
                                                                <button class="btn btn-danger delete-file" data-file-id="${f.id}">
                                                                    <i class="bx bx-trash"></i>
                                                                </button>
                                                            </div>
                                                        </li>
                                                    `).join("")}
                                                </ul>
                                            `;

                                        } else {
                                            container.innerHTML = "<p class='text-muted text-center'>No files</p>";
                                        }

                                        new bootstrap.Modal(document.getElementById("viewProjectModal")).show();
                                    })
                                    .catch(() => showToast("Error loading folder details"));
                            }
                            // Open file preview modal dynamically
                            if (e.target.closest(".view-file")) {
                                const url = e.target.closest(".view-file").dataset.url;
                                const filename = url.split('/').pop();
                                console.log(url, filename);
                                const ext = getFileExtension(url);
                                const container = document.getElementById("filePreview");
                                document.getElementById("fileTitle").innerText = "Preview: " + filename;

                                container.innerHTML = ""; // reset

                                if (["txt"].includes(ext)) {
                                    fetch(url)
                                        .then(res => res.text())
                                        .then(text => {
                                            container.innerHTML = `<h5>Preview: ${filename}</h5><pre>${text}</pre>`;
                                        })
                                        .catch(() => {
                                            container.innerHTML = `<p class="text-center">Cannot preview this file. <a href="${url}" download>Download</a></p>`;
                                        });
                                }
                                else if (["pdf"].includes(ext)) {
                                    container.innerHTML = `<iframe src="${url}" style="width:100%;height:70vh;border:none;"></iframe>`;
                                }
                                else if (["jpg", "jpeg", "png", "gif", "webp"].includes(ext)) {
                                    container.innerHTML = `<img src="${url}" style="width:100%;height:auto;">`;
                                }
                                else if (["mp4", "webm", "ogg"].includes(ext)) {
                                    container.innerHTML = `<video controls style="width:100%;height:auto;"><source src="${url}" type="video/${ext}"></video>`;
                                }
                                else if (["html", "htm"].includes(ext)) {
                                    container.innerHTML = `<iframe src="${url}" style="width:100%;height:70vh;border:none;"></iframe>`;
                                }
                                else {
                                    container.innerHTML = `<p class="text-center">Preview not available. <a href="${url}" target="_blank" download>Download</a> to view the file.</p>`;
                                }

                                new bootstrap.Modal(document.getElementById("viewFileModal")).show();
                            }


                            let selectedToDelete = [];  // store ids globally

                            document.addEventListener("click", function (e) {
                                // Delete Selected → open confirmation modal
                                if (e.target.id === "deleteSelectedBtn") {
                                    selectedToDelete = Array.from(document.querySelectorAll(".file-checkbox:checked"))
                                        .map(cb => cb.value);

                                    if (!selectedToDelete.length) return;

                                    // Update modal text dynamically
                                    document.querySelector("#deleteFileModal .modal-body").innerText =
                                        `Are you sure you want to delete ${selectedToDelete.length} file(s)?`;

                                    // Show modal


                                    new bootstrap.Modal(document.getElementById("deleteFileModal")).show();
                                }
                            });

                            // Confirm delete button inside modal
                            // document.getElementById("confirmDeleteFileBtn").addEventListener("click", function () {
                            //     if (!selectedToDelete.length) return;

                            //     fetch(`/delete_files/`, {
                            //         method: "POST",
                            //         headers: { "Content-Type": "application/json", "X-CSRFToken": getCSRFToken() },
                            //         body: JSON.stringify({ ids: selectedToDelete })
                            //     })
                            //     .then(res => res.json())
                            //     .then(() => {

                            //         // Remove them from UI
                            //         selectedToDelete.forEach(id => {
                            //             const cb = document.querySelector(`.file-checkbox[value="${id}"]`);
                            //             if (cb) cb.closest("li").remove();
                            //         });

                            //         showToast("Selected files deleted successfully");
                            //         // Reset UI
                            //         selectedToDelete = [];
                            //         document.getElementById("deleteSelectedBtn").disabled = true;
                            //         document.getElementById("selectAll").checked = false;

                            //         if (!document.querySelector(".file-checkbox")) {
                            //             document.getElementById("projectFolders").innerHTML = "<p class='text-muted text-center'>No files</p>";
                            //         }

                            //         bootstrap.Modal.getInstance(document.getElementById("deleteFileModal")).hide();
                            //         bootstrap.Modal.getInstance(document.getElementById("viewProjectModal")).hide();
                            //     })
                            //     .catch(() => showToast("Error deleting selected files"));
                            // });

                            // Checkbox change events
                            document.addEventListener("change", function (e) {
                                if (e.target.id === "selectAll") {
                                    const all = document.querySelectorAll(".file-checkbox");
                                    all.forEach(cb => cb.checked = e.target.checked);
                                    document.getElementById("deleteSelectedBtn").disabled = !e.target.checked;
                                }

                                if (e.target.classList.contains("file-checkbox")) {
                                    const all = document.querySelectorAll(".file-checkbox");
                                    const checked = document.querySelectorAll(".file-checkbox:checked");
                                    document.getElementById("selectAll").checked = (all.length === checked.length);
                                    document.getElementById("deleteSelectedBtn").disabled = checked.length === 0;
                                    // Disable row delete buttons if multiple selected
                                    document.querySelectorAll(".delete-file").forEach(btn => {
                                        btn.disabled = checked.length > 1 || document.getElementById("selectAll").checked;
                                    });
                                }
                            });

                            // CSRF helper
                            function getCSRFToken() {
                                return document.querySelector("[name=csrfmiddlewaretoken]")?.value || "";
                            }


                        });

                    </script>
                </div>
            </div>
        </div>

        <!-- File Preview Modal -->
        <div class="modal fade" id="viewFileModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header table-primary text-white">
                        <h5 class="modal-title" id="fileTitle"></h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="filePreview"></div>
                </div>
            </div>
        </div>

        <!-- Delete File Modal -->
        <div class="modal fade" id="deleteFileModal" tabindex="-1" aria-labelledby="deleteFileLabel" aria-hidden="true"
            data-bs-backdrop="false" data-bs-keyboard="false">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content text-center">
                    <div class="modal-header border-0">
                        <h5 class="modal-title w-100" id="deleteFileLabel">Confirm Delete</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        Are you sure you want to delete this file?
                    </div>
                    <div class="modal-footer justify-content-center border-0">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                    </div>
                </div>
            </div>
            <script>
                let fileIdToDelete = null;
                let selectedToDelete = [];

                // CSRF helper
                function getCSRFToken() {
                    return document.querySelector("[name=csrfmiddlewaretoken]")?.value || "";
                }

                // --- Single Delete ---
                document.addEventListener("click", function (e) {
                    const btn = e.target.closest(".delete-file");
                    if (btn) {
                        e.preventDefault();
                        fileIdToDelete = btn.dataset.fileId;
                        selectedToDelete = [];
                        document.querySelector("#deleteFileModal .modal-body").innerText =
                            "Are you sure you want to delete this file?";
                        new bootstrap.Modal(document.getElementById("deleteFileModal")).show();
                    }
                });

                // --- Bulk Delete ---
                document.addEventListener("click", function (e) {
                    if (e.target.id === "deleteSelectedBtn") {
                        selectedToDelete = Array.from(document.querySelectorAll(".file-checkbox:checked"))
                            .map(cb => cb.value);

                        if (!selectedToDelete.length) return;

                        fileIdToDelete = null;
                        document.querySelector("#deleteFileModal .modal-body").innerText =
                            `Are you sure you want to delete ${selectedToDelete.length} file(s)?`;
                        new bootstrap.Modal(document.getElementById("deleteFileModal")).show();
                    }
                });

                // --- Confirm Delete (Single + Bulk) ---
                document.getElementById("confirmDeleteBtn").addEventListener("click", function () {
                    const csrftoken = getCSRFToken();

                    // Multi delete
                    if (selectedToDelete.length > 0) {
                        fetch(`/delete_files/`, {
                            method: "POST",
                            headers: { "Content-Type": "application/json", "X-CSRFToken": csrftoken },
                            body: JSON.stringify({ ids: selectedToDelete })
                        })
                            .then(res => res.json())
                            .then(() => {
                                selectedToDelete.forEach(id => {
                                    const cb = document.querySelector(`.file-checkbox[value="${id}"]`);
                                    if (cb) cb.closest("li").remove();
                                });

                                showToast("Selected files deleted successfully", "success");
                                selectedToDelete = [];
                                document.getElementById("deleteSelectedBtn").disabled = true;
                                document.getElementById("selectAll").checked = false;

                                if (!document.querySelector(".file-checkbox")) {
                                    document.getElementById("projectFolders").innerHTML =
                                        "<p class='text-muted text-center'>No files</p>";
                                }
                            })
                            .catch(() => showToast("Error deleting selected files", "danger"))
                            .finally(() => {
                                bootstrap.Modal.getInstance(document.getElementById("deleteFileModal")).hide();
                                bootstrap.Modal.getInstance(document.getElementById("viewProjectModal")).hide();
                                setTimeout(() => window.location.reload(), 1000);
                            });

                        // Single delete
                    } else if (fileIdToDelete) {
                        fetch(`/delete_file/${fileIdToDelete}/`, {
                            method: "POST",
                            headers: { "Content-Type": "application/json", "X-CSRFToken": csrftoken }
                        })
                            .then(res => res.json())
                            .then(data => {
                                if (data.success) {
                                    showToast(data.message, "success");
                                    const btn = document.querySelector(`.delete-file[data-file-id="${fileIdToDelete}"]`);
                                    if (btn) btn.closest("li").remove();
                                } else {
                                    showToast(data.error, "danger");
                                }
                            })
                            .catch(() => showToast("Unexpected error deleting file", "danger"))
                            .finally(() => {
                                bootstrap.Modal.getInstance(document.getElementById("deleteFileModal")).hide();
                                bootstrap.Modal.getInstance(document.getElementById("viewProjectModal")).hide();
                                setTimeout(() => window.location.reload(), 1000);
                            });
                    }
                });

                // --- Select All + Checkbox Logic ---
                document.addEventListener("change", function (e) {
                    // --- Individual checkbox ---
                    if (e.target.classList.contains("file-checkbox")) {
                        const all = document.querySelectorAll(".file-checkbox");
                        const checked = document.querySelectorAll(".file-checkbox:checked");

                        // Handle "Select All" state
                        document.getElementById("selectAll").checked = all.length === checked.length;
                        document.getElementById("deleteSelectedBtn").disabled = !checked.length;

                        // 🚫 Disable row trash buttons if multi-select is active
                        document.querySelectorAll(".delete-file").forEach(btn => {
                            btn.disabled = checked.length > 0;
                        });
                    }

                    // --- Select All ---
                    if (e.target.id === "selectAll") {
                        const checkboxes = document.querySelectorAll(".file-checkbox");
                        checkboxes.forEach(cb => cb.checked = e.target.checked);

                        const checked = document.querySelectorAll(".file-checkbox:checked");
                        document.getElementById("deleteSelectedBtn").disabled = !checked.length;

                        // 🚫 Disable row trash buttons if multi-select is active
                        document.querySelectorAll(".delete-file").forEach(btn => {
                            btn.disabled = checked.length > 0;
                        });
                    }

                });

            </script>
        </div>




    </div>
</div>
{% endblock %}